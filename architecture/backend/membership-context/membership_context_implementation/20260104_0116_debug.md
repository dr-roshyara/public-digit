Perfect! Now I can see the problem clearly. The `DesktopMemberRegistrationServiceTest` is:

1. **Using `RefreshDatabase` trait** without proper isolation
2. **Setting connection to `'tenant'`** instead of `'tenant_test'` 
3. **Not specifying which migrations to run** - so it runs ALL migrations, including DigitalCard

## **ðŸ”§ THE FIX:**

According to the developer guide and the testing patterns, we need to:

1. **Create a base `MembershipTestCase`** that isolates Membership tests
2. **Make `DesktopMemberRegistrationServiceTest` extend `MembershipTestCase`**
3. **Ensure only Membership migrations run**

Let me create the `MembershipTestCase.php` first, then update the test files.

Actually, we need to create the `MembershipTestCase.php` in the proper location. Let me check if it already exists. If not, let's create it:

**Create file:** `tests/Feature/Contexts/Membership/MembershipTestCase.php`

But wait, this is a **unit test** (`tests/Unit/Contexts/Membership/Application/Services/`), not a feature test. The unit tests should **not use databases at all**! 

## **ðŸš¨ ROOT PROBLEM:**

**Unit tests should NOT hit the database!** They should use mocks and test business logic in isolation. But `DesktopMemberRegistrationServiceTest` is:
1. Extending `TestCase` (which has Laravel container)
2. Using `RefreshDatabase` (which creates/refreshes database)
3. Doing `assertDatabaseHas()` (which queries database)

This is **wrong architecture**! Unit tests should test business logic without database. Only **feature tests** should test database operations.

However, looking at the test, it's testing a **service that interacts with the database** (`DesktopMemberRegistrationService`). This is actually an **integration test**, not a pure unit test.

## **ðŸŽ¯ IMMEDIATE SOLUTION:**

Let's fix the immediate issue by:

1. **Updating the test to use proper connection** (`tenant_test` instead of `tenant`)
2. **Specifying which migrations to run** (only Membership migrations)
3. **Preventing database contamination**

But actually, the real issue is that **ALL migrations are being run**, including DigitalCard migrations. We need to tell Laravel to run **only Membership migrations**.

Let me check the `RefreshDatabase` trait usage. We need to override `migrateFreshUsing()` to specify which migrations to run.

Let me update the `DesktopMemberRegistrationServiceTest.php` file:
####

Let me create the proper `MembershipTestCase` base class that will handle database isolation for Membership context tests. Then we'll update the failing tests to extend this base class.

Create file: `packages/laravel-backend/tests/Feature/Contexts/Membership/MembershipTestCase.php`

```php
<?php

declare(strict_types=1);

namespace Tests\Feature\Contexts\Membership;

use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;
use Tests\TestCase;

/**
 * MembershipTestCase - Base Test Class for Membership Context Tests
 *
 * This base class automatically bootstraps Membership tables in the tenant_test database.
 * Any test that needs Membership tables should extend this class.
 *
 * PATTERN: Follows standardized testing approach for Tenant Contexts
 * - Uses RefreshDatabase trait with proper hooks
 * - Uses tenant_test connection (Membership is a tenant context)
 * - Only runs Membership Tenant migrations (not other contexts)
 * - Creates a test tenant in landlord database for tenant resolution
 *
 * Usage:
 *   class MyMembershipTest extends MembershipTestCase
 *   {
 *       // Membership tables automatically available in tenant_test database!
 *   }
 *
 * @package Tests\Feature\Contexts\Membership
 */
abstract class MembershipTestCase extends TestCase
{
    use RefreshDatabase;

    /**
     * Test tenant slug used for tenant identification
     */
    protected string $testTenantSlug = 'uml';

    /**
     * Test tenant database name
     */
    protected string $testTenantDatabaseName = 'tenant_test';

    /**
     * Configure connection BEFORE database refresh
     *
     * CRITICAL: This runs before RefreshDatabase creates tables
     * Sets connection to tenant_test (Membership is a tenant context)
     */
    protected function beforeRefreshingDatabase(): void
    {
        config(['database.default' => 'tenant_test']);
    }

    /**
     * Specify which migrations to run
     *
     * ONLY runs Membership Tenant migrations, nothing else
     * This prevents DigitalCard, Geography, or other context tables from being created
     * in the tenant_test database.
     */
    protected function migrateFreshUsing(): array
    {
        return [
            '--path' => 'app/Contexts/Membership/Infrastructure/Database/Migrations/Tenant',
            '--database' => 'tenant_test',
            '--realpath' => true,
        ];
    }

    /**
     * Setup runs before EACH test
     *
     * Verify we're using correct database and create test tenant in landlord database
     */
    protected function setUp(): void
    {
        parent::setUp();

        // Verify we're using tenant_test database
        $database = DB::connection('tenant_test')->getDatabaseName();

        // Safety check: MUST be test database
        if (!str_contains(strtolower($database), 'test')) {
            $this->fail("SAFETY CHECK FAILED: Not using test database! Using: {$database}");
        }

        // Log database for debugging
        if (getenv('APP_DEBUG')) {
            echo "\nðŸ” Using tenant database: {$database}\n";
        }

        // Create test tenant in landlord database for tenant resolution
        $this->createTestTenant();

        // Verify ONLY Membership tables exist (contamination check)
        $this->verifyNoContamination();
    }

    /**
     * Create a test tenant in landlord database
     *
     * Required for identify.tenant middleware to work.
     * The tenant must exist in landlord database with correct database_name.
     */
    protected function createTestTenant(): void
    {
        // Switch to landlord_test connection
        config(['database.default' => 'landlord_test']);

        // Ensure tenants table exists (landlord migrations should have run)
        if (!Schema::hasTable('tenants')) {
            $this->fail('tenants table does not exist in landlord_test database. Landlord migrations not run.');
        }

        // Update or insert tenant (ensures correct database_name on every test run)
        DB::table('tenants')->updateOrInsert(
            ['slug' => $this->testTenantSlug],
            [
                'id' => '550e8400-e29b-41d4-a716-446655440000', // Valid UUID v4 format
                'numeric_id' => 99999, // Required bigint ID (use high number to avoid conflicts)
                'slug' => $this->testTenantSlug,
                'name' => 'Test Tenant UML',
                'email' => 'test@uml.example.com',
                'status' => 'active',
                'database_name' => $this->testTenantDatabaseName,
                'created_at' => now(),
                'updated_at' => now(),
            ]
        );

        // Switch back to tenant_test for test operations
        config(['database.default' => 'tenant_test']);
    }

    /**
     * Verify no contamination from other contexts
     *
     * Only Membership tables should exist in tenant_test database.
     * Geography, DigitalCard, and other context tables should NOT exist.
     */
    protected function verifyNoContamination(): void
    {
        // Membership tables should exist
        $this->assertTrue(
            Schema::hasTable('members'),
            'members table should exist after Membership bootstrap'
        );

        // Safety check: Geography tables should NOT exist (they belong in landlord_test)
        if (Schema::hasTable('countries')) {
            $this->fail('CONTAMINATION: countries table exists in tenant_test! Geography tables should be in landlord_test.');
        }

        if (Schema::hasTable('geo_administrative_units')) {
            $this->fail('CONTAMINATION: geo_administrative_units table exists in tenant_test! Geography tables should be in landlord_test.');
        }

        // Safety check: DigitalCard tables should NOT exist
        if (Schema::hasTable('digital_cards')) {
            $this->fail('CONTAMINATION: digital_cards table exists! Only Membership tables should be created.');
        }
    }

    /**
     * Helper: Insert test member
     *
     * @param array $data Member data
     * @return string Member ID (ULID)
     */
    protected function insertTestMember(array $data = []): string
    {
        $defaultData = [
            'id' => \Illuminate\Support\Str::ulid(),
            'member_id' => 'TEST-' . \Illuminate\Support\Str::random(6),
            'tenant_user_id' => \Illuminate\Support\Str::ulid(),
            'tenant_id' => $this->testTenantSlug,
            'personal_info' => json_encode([
                'full_name' => 'Test User',
                'email' => 'test@example.com',
                'phone' => '+977-9841234567',
            ]),
            'status' => 'draft',
            'residence_geo_reference' => 'np.3.15.234',
            'membership_type' => 'regular',
            'metadata' => json_encode([]),
            'created_at' => now(),
            'updated_at' => now(),
        ];

        $mergedData = array_merge($defaultData, $data);

        DB::table('members')->insert($mergedData);

        return $mergedData['id'];
    }
}
```

Now, we need to update the failing tests to use this base class. But wait, `DesktopMemberRegistrationServiceTest` is in the **Unit tests** directory, not **Feature tests**. According to testing principles:

1. **Unit tests** should NOT use database (mock everything)
2. **Feature tests** can use database (test integration)

The `DesktopMemberRegistrationServiceTest` is actually an **integration test** (tests service with database). It should be in the **Feature** directory, not **Unit**.

However, for now, let me fix the immediate issue by updating the test to use proper isolation. Let me update `DesktopMemberRegistrationServiceTest.php`:
Actually, let me think about this more carefully. The `DesktopMemberRegistrationServiceTest` is in the **Unit** directory, but it's testing a **service that interacts with the database**. This is a **integration test** that should be in the **Feature** directory.

But we have an immediate problem: the tests are failing due to database contamination. Let me fix this by:

1. **First, create the `MembershipTestCase` base class** (done)
2. **Update `DesktopMemberRegistrationServiceTest` to extend `MembershipTestCase`**
3. **Remove the database contamination**

Actually, looking at the code again, `DesktopMemberRegistrationServiceTest` is extending `TestCase` and using `RefreshDatabase`. Let me update it to use proper isolation.

Wait, there's another issue: `DesktopMemberRegistrationServiceTest` is in **Unit tests**, but `MembershipTestCase` is in **Feature tests**. We can't extend across directories like that.

Let me create a simpler solution: Update `DesktopMemberRegistrationServiceTest` to use proper migration isolation directly in the test class.

**Edit `DesktopMemberRegistrationServiceTest.php`:**

Actually, let me first run a quick test to see if the database contamination is the only issue. Let me check what migrations are being run. The error says `digital_cards` table already exists, which means DigitalCard migrations are being run.

The fix is to **specify which migrations to run** in the test class. Let me update the `DesktopMemberRegistrationServiceTest` class to override `migrateFreshUsing()`:

```php
protected function migrateFreshUsing(): array
{
    return [
        '--path' => 'app/Contexts/Membership/Infrastructure/Database/Migrations/Tenant',
        '--database' => 'tenant_test', // Use tenant_test, not tenant
        '--realpath' => true,
    ];
}
```

And also update the connection in `setUp()`:

```php
protected function setUp(): void
{
    parent::setUp();

    // Set tenant TEST database connection
    config(['database.default' => 'tenant_test']); // Changed from 'tenant'

    // ... rest of setup
}
```

But actually, I need to see the full current file to make these changes. Let me edit the file properly. Actually, you said "ok" which means you want me to proceed with creating/updating files.

Let me create the updated `DesktopMemberRegistrationServiceTest.php` with proper isolation:
Let me edit the `DesktopMemberRegistrationServiceTest.php` file to fix the database contamination issue:

**Edit file:** `packages/laravel-backend/tests/Unit/Contexts/Membership/Application/Services/DesktopMemberRegistrationServiceTest.php`

```php
<?php

declare(strict_types=1);

namespace Tests\Unit\Contexts\Membership\Application\Services;

use App\Contexts\Membership\Application\DTOs\DesktopRegistrationDto;
use App\Contexts\Membership\Application\Services\DesktopMemberRegistrationService;
use App\Contexts\Membership\Domain\Models\Member;
use App\Contexts\Membership\Domain\Services\GeographyResolverInterface;
use App\Contexts\Membership\Domain\ValueObjects\GeoReference;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Mockery;
use Tests\TestCase;

/**
 * Desktop Member Registration Service Tests
 *
 * Tests the application service that orchestrates desktop admin member registration.
 *
 * TDD Workflow:
 * 1. RED: Write failing tests (this file)
 * 2. GREEN: Implement DesktopMemberRegistrationService
 * 3. REFACTOR: Clean up and optimize
 *
 * Business Rules Tested:
 * - Service receives EXISTING tenant_user_id (admin already created user)
 * - Service validates geography reference if provided
 * - Service calls Member::registerForDesktop()
 * - Member starts with PENDING status (desktop channel rule - skips DRAFT)
 * - Service saves member to database
 * - Service returns created member
 *
 * DATABASE ISOLATION:
 * - Uses tenant_test connection (not tenant)
 * - Runs ONLY Membership migrations (prevents DigitalCard contamination)
 */
class DesktopMemberRegistrationServiceTest extends TestCase
{
    use RefreshDatabase;

    private DesktopMemberRegistrationService $service;
    private GeographyResolverInterface $geographyResolver;

    /**
     * Configure connection BEFORE database refresh
     * CRITICAL: Must set connection before RefreshDatabase runs
     */
    protected function beforeRefreshingDatabase(): void
    {
        config(['database.default' => 'tenant_test']);
    }

    /**
     * Specify which migrations to run
     * ONLY Membership Tenant migrations, no other contexts
     */
    protected function migrateFreshUsing(): array
    {
        return [
            '--path' => 'app/Contexts/Membership/Infrastructure/Database/Migrations/Tenant',
            '--database' => 'tenant_test',
            '--realpath' => true,
        ];
    }

    protected function setUp(): void
    {
        parent::setUp();

        // Mock geography resolver
        $this->geographyResolver = Mockery::mock(GeographyResolverInterface::class);

        // Create service under test
        $this->service = new DesktopMemberRegistrationService(
            $this->geographyResolver
        );

        // Create test tenant for tenant resolution
        $this->createTestTenant();
    }

    /**
     * Create a test tenant in landlord database
     * Required for tenant resolution in application services
     */
    private function createTestTenant(): void
    {
        // Switch to landlord_test
        config(['database.default' => 'landlord_test']);

        // Create test tenant if not exists
        \DB::table('tenants')->updateOrInsert(
            ['slug' => 'test-party'],
            [
                'id' => 'test-tenant-id-1234567890abcdef',
                'numeric_id' => 99999,
                'slug' => 'test-party',
                'name' => 'Test Party',
                'email' => 'test@party.example.com',
                'status' => 'active',
                'database_name' => 'tenant_test',
                'created_at' => now(),
                'updated_at' => now(),
            ]
        );

        // Switch back to tenant_test
        config(['database.default' => 'tenant_test']);
    }

    protected function tearDown(): void
    {
        Mockery::close();
        parent::tearDown();
    }

    /** @test */
    public function it_creates_member_with_existing_tenant_user_id(): void
    {
        // Arrange
        $dto = new DesktopRegistrationDto(
            tenantId: 'test-party',
            tenantUserId: '01JKABCD1234567890ABCDEFGH', // User already exists
            fullName: 'John Admin',
            email: 'admin@example.com',
            phone: '+977-9841234567',
            memberId: null,
            geoReference: null
        );

        // Geography resolver NOT called (no geo reference)
        $this->geographyResolver->shouldNotReceive('validate');

        // Act
        $member = $this->service->register($dto);

        // Assert
        $this->assertInstanceOf(Member::class, $member);
        $this->assertEquals('01JKABCD1234567890ABCDEFGH', $member->tenant_user_id);
        $this->assertEquals('test-party', $member->tenant_id);
        $this->assertTrue($member->status->isPending()); // Desktop â†’ PENDING (skips DRAFT)
        $this->assertEquals('desktop', $member->registration_channel);
    }

    /** @test */
    public function it_validates_geography_reference_when_provided(): void
    {
        // Arrange
        $dto = new DesktopRegistrationDto(
            tenantId: 'test-party',
            tenantUserId: '01JKABCD1234567890ABCDEFGH',
            fullName: 'Jane Admin',
            email: 'jane.admin@example.com',
            phone: null,
            memberId: null,
            geoReference: 'np.3.15.234' // Nepal, Province 3, District 15, Municipality 234
        );

        $validatedGeoRef = new GeoReference('np.3.15.234');

        // Expect: Geography validation called
        $this->geographyResolver
            ->shouldReceive('validate')
            ->once()
            ->with('np.3.15.234')
            ->andReturn($validatedGeoRef);

        // Act
        $member = $this->service->register($dto);

        // Assert
        $this->assertEquals('np.3.15.234', $member->residence_geo_reference);
    }

    /** @test */
    public function it_creates_member_without_geography_when_not_provided(): void
    {
        // Arrange
        $dto = new DesktopRegistrationDto(
            tenantId: 'test-party',
            tenantUserId: '01JKABCD1234567890ABCDEFGH',
            fullName: 'Bob Admin',
            email: 'bob.admin@example.com',
            phone: null,
            memberId: null,
            geoReference: null // No geography
        );

        // Geography resolver should NOT be called
        $this->geographyResolver->shouldNotReceive('validate');

        // Act
        $member = $this->service->register($dto);

        // Assert
        $this->assertNull($member->residence_geo_reference);
    }

    /** @test */
    public function it_saves_member_to_database(): void
    {
        // Arrange
        $dto = new DesktopRegistrationDto(
            tenantId: 'test-party',
            tenantUserId: '01JKABCD1234567890ABCDEFGH',
            fullName: 'Alice Admin',
            email: 'alice.admin@example.com',
            phone: '+977-9841111111',
            memberId: 'PARTY-2025-001',
            geoReference: null
        );

        // Act
        $member = $this->service->register($dto);

        // Assert: Member persisted to database
        $this->assertDatabaseHas('members', [
            'id' => $member->id,
            'tenant_id' => 'test-party',
            'tenant_user_id' => '01JKABCD1234567890ABCDEFGH',
            'status' => 'pending', // Desktop starts at PENDING
            'registration_channel' => 'desktop',
        ]);
    }

    /** @test */
    public function it_stores_personal_info_correctly(): void
    {
        // Arrange
        $dto = new DesktopRegistrationDto(
            tenantId: 'test-party',
            tenantUserId: '01JKABCD1234567890ABCDEFGH',
            fullName: 'Charlie Admin',
            email: 'charlie.admin@example.com',
            phone: '+977-9842222222',
            memberId: null,
            geoReference: null
        );

        // Act
        $member = $this->service->register($dto);

        // Assert: PersonalInfo value object stored correctly
        $this->assertEquals('Charlie Admin', $member->personal_info->fullName());
        $this->assertEquals('charlie.admin@example.com', $member->personal_info->email()->value());
        $this->assertEquals('+977-9842222222', $member->personal_info->phone());
    }

    /** @test */
    public function it_accepts_optional_member_id(): void
    {
        // Arrange
        $dto = new DesktopRegistrationDto(
            tenantId: 'test-party',
            tenantUserId: '01JKABCD1234567890ABCDEFGH',
            fullName: 'David Admin',
            email: 'david.admin@example.com',
            phone: null,
            memberId: 'PARTY-2025-999', // Party-defined member ID
            geoReference: null
        );

        // Act
        $member = $this->service->register($dto);

        // Assert
        $this->assertEquals('PARTY-2025-999', $member->member_id->value());
    }

    /** @test */
    public function it_records_member_registered_event(): void
    {
        // Arrange
        $dto = new DesktopRegistrationDto(
            tenantId: 'test-party',
            tenantUserId: '01JKABCD1234567890ABCDEFGH',
            fullName: 'Eve Admin',
            email: 'eve.admin@example.com',
            phone: null,
            memberId: null,
            geoReference: null
        );

        // Act
        $member = $this->service->register($dto);
        $member->save(); // Triggers event dispatch

        // Assert: MemberRegistered event recorded
        $events = $member->getRecordedEvents();
        $this->assertCount(1, $events);
        $this->assertEquals('App\Contexts\Membership\Domain\Events\MemberRegistered', get_class($events[0]));
    }

    /** @test */
    public function it_does_not_provision_user_account(): void
    {
        // Arrange
        $dto = new DesktopRegistrationDto(
            tenantId: 'test-party',
            tenantUserId: '01JKABCD1234567890ABCDEFGH', // User ALREADY exists
            fullName: 'Frank Admin',
            email: 'frank.admin@example.com',
            phone: null,
            memberId: null,
            geoReference: null
        );

        // Act
        $member = $this->service->register($dto);

        // Assert: Service does NOT provision user (Desktop assumption: user exists)
        // Service receives tenant_user_id directly from DTO
        $this->assertEquals('01JKABCD1234567890ABCDEFGH', $member->tenant_user_id);
    }
}
```

Now let me also update the `MobileMemberRegistrationServiceTest.php` with the same fixes. But actually, let me first test if our fix works by running the test:

```bash
php artisan test tests/Unit/Contexts/Membership/Application/Services/DesktopMemberRegistrationServiceTest.php
```

Actually, we should also update the `MobileMemberRegistrationServiceTest.php` file similarly. Let me make those changes too.
