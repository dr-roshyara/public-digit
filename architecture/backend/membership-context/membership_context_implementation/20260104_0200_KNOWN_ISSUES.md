# Known Issues - Membership Context Testing

**Date**: 2026-01-04 02:00
**Status**: üî¥ ACTIVE ISSUE

---

## Issue #1: Registration Tests Database Contamination

###  Problem

`DesktopMemberRegistrationServiceTest` and `MobileMemberRegistrationServiceTest` are failing due to database contamination:

1. **Wrong Database Connection**: Migrations running on `tenant` connection instead of `tenant_test`
2. **Digital_cards Table Conflict**: DigitalCard migrations being run, creating conflict

###  Root Cause

Laravel's `RefreshDatabase` trait does not properly respect custom database connections set in test classes. Even after:
- Setting `config(['database.default' => 'tenant_test'])` in `beforeRefreshingDatabase()`
- Overriding `refreshDatabase()` method
- Passing `--database=tenant_test` to artisan commands

The migrations still execute on the default `tenant` connection, causing:
- Production database contamination (trying to create tables that already exist)
- Cross-context table creation (DigitalCard tables in Membership tests)

###  Evidence

```bash
SQLSTATE[42P07]: Duplicate table: 7 FEHLER: Relation ¬ªdigital_cards¬´ existiert bereits
(Connection: tenant, SQL: create table "digital_cards" ...)
```

The error explicitly shows `Connection: tenant` instead of `Connection: tenant_test`.

###  Impact

| Component | Status | Impact |
|-----------|--------|--------|
| **STEP 5: Approval/Rejection** | ‚úÖ WORKING | 22/22 tests passing - NOT affected |
| **DAY 3: Desktop Registration** | ‚ùå FAILING | 8/8 tests failing - database contamination |
| **DAY 2: Mobile Registration** | ‚ùå FAILING | 6/6 tests failing - database contamination |
| **Domain Layer Tests** | ‚úÖ WORKING | All passing - no database dependency |
| **Application Layer Tests (Approval)** | ‚úÖ WORKING | All passing - uses MembershipTestCase correctly |

###  Attempted Solutions

#### ‚úÖ Attempt 1: Create MembershipTestCase Base Class
**Status**: Created successfully
**Result**: Base class works for some tests (approval/rejection) but not for registration tests
**Files Created**:
- `tests/Feature/Contexts/Membership/MembershipTestCase.php`

**Implementation**:
```php
protected function beforeRefreshingDatabase(): void
{
    config(['database.default' => 'tenant_test']);
}

protected function migrateFreshUsing(): array
{
    return [
        '--path' => 'app/Contexts/Membership/Infrastructure/Database/Migrations/Tenant',
        '--database' => 'tenant_test',
    ];
}
```

**Result**: Failed - migrations still run on `tenant` connection

#### ‚ùå Attempt 2: Override refreshDatabase() Method
**Status**: Implemented but failed
**Result**: Same issue - migrations ignore `--database` flag

**Implementation**:
```php
protected function refreshDatabase(): void
{
    config(['database.default' => 'tenant_test']);

    $this->artisan('migrate:fresh', [
        '--database' => 'tenant_test',
    ]);

    $this->artisan('migrate', [
        '--database' => 'tenant_test',
        '--path' => 'app/Contexts/Membership/Infrastructure/Database/Migrations/Tenant',
    ]);
}
```

**Result**: Failed - connection still shows `tenant`

###  Workaround (Temporary)

**Option A: Mock Repository Pattern** (Recommended for Unit Tests)
Convert registration service tests to pure unit tests:
- Mock `MemberRepositoryInterface` instead of using real database
- Test business logic in isolation
- No database contamination risk

**Option B: Use Separate Test Database** (Recommended for Integration Tests)
Move registration tests to Feature tests with dedicated test database:
- Create `tenant_membership_test` database
- Configure database.php with separate connection
- Use DatabaseTransactions instead of RefreshDatabase

**Option C: Skip Registration Tests Temporarily**
Focus on STEP 5 approval/rejection which is working:
- Document registration tests as known issue
- Proceed with feature implementation
- Fix database isolation in separate task

###  Recommended Next Steps

1. **IMMEDIATE**: Document STEP 5 completion (approval/rejection working perfectly)
2. **SHORT-TERM**: Convert registration service tests to use mocks (pure unit tests)
3. **LONG-TERM**: Investigate Laravel 12 RefreshDatabase trait behavior with custom connections

---

## Issue #2: Service Binding in MembershipServiceProvider

###  Problem

Potential service binding issues in `MembershipServiceProvider` that may affect Desktop API authentication.

###  Status

‚è≥ INVESTIGATION PENDING

###  Evidence

From user priority list:
> Priority 1: Fix hanging MemberRegistrationApiTest
> - Debug service binding in MembershipServiceProvider
> - Fix authentication mocking for Desktop API
> - Ensure tenant switching works in tests

###  Next Steps

1. Verify all services are bound correctly in `MembershipServiceProvider`
2. Test Desktop API routes with session authentication
3. Mock authentication for feature tests

---

## Summary

### ‚úÖ What's Working

1. **STEP 5: Approval/Rejection Feature**
   - 22/22 tests passing
   - Production-ready code
   - Full documentation created

2. **Domain Layer**
   - All value objects working
   - All aggregate methods tested
   - Event recording functional

3. **Application Layer (Approval/Rejection)**
   - Service orchestration working
   - DTO pattern implemented
   - Repository interaction tested

### ‚ùå What's Not Working

1. **Desktop Registration Service Tests**
   - Database contamination from RefreshDatabase trait
   - Wrong connection being used
   - DigitalCard migrations interfering

2. **Mobile Registration Service Tests**
   - Same database contamination issue
   - Needs migration isolation fix

### üéØ Recommendation

**SHIP STEP 5 NOW, FIX REGISTRATION TESTS LATER**

Reasoning:
- STEP 5 (approval/rejection) is 100% functional and tested
- Registration tests failing due to infrastructure issue, NOT business logic
- Business logic for registration was already validated in previous implementation
- Fixing test infrastructure is a separate concern from feature development

**Action Plan**:
1. ‚úÖ Mark STEP 5 as complete
2. ‚úÖ Document registration test issue
3. ‚è≥ Create separate task to fix test database isolation
4. ‚è≥ Convert registration service tests to use mocks (proper unit tests)

---

**Last Updated**: 2026-01-04 02:00
**Next Review**: After fixing test database isolation
**Priority**: P2 (Does not block STEP 5 deployment)
