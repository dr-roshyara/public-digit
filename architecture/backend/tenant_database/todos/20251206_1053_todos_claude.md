Perfect! Now I have the complete picture. Your DDD structure is already well-defined. Here's the **CORRECTED PROMPT** for Claude CLI:

---

## üéØ **CORRECTED PROMPT FOR CLAUDE CLI - URGENT REVISION NEEDED**

```
NO - Your plan is architecturally incorrect. You've fundamentally misunderstood my existing DDD structure.

## üö® **CRITICAL MISUNDERSTANDINGS:**

1. **WRONG TABLE COUNT**: My Universal Core Schema has ONLY 8 tables, not 18. You're adding non-existent tables.

2. **IGNORES EXISTING DDD BOUNDED CONTEXTS**: I already have a mature DDD structure:
   - `Election` Context ‚Üí Election operations with `TenantUser` Domain Entity
   - `TenantAuth` Context ‚Üí Authentication with `tenant_users` table migration already exists!
   - `Platform` Context ‚Üí Platform administration
   - `Shared` Context ‚Üí Shared infrastructure

3. **WRONG MIGRATION LOCATION**: Migrations are ALREADY organized by context:
   ```
   app/Contexts/TenantAuth/Infrastructure/Database/Migrations/
   ‚îú‚îÄ‚îÄ 2025_09_28_143000_create_tenant_users_table.php  ‚Üê ALREADY EXISTS!
   ‚îú‚îÄ‚îÄ 2025_01_01_000003_create_tenant_user_registrations_table.php
   ‚îî‚îÄ‚îÄ ...
   ```

4. **IGNORES EXISTING tenant_users TABLE**: You're planning to create `tenant_users` but IT ALREADY EXISTS in `TenantAuth` context!

## üìä **ACTUAL EXISTING ARCHITECTURE ANALYSIS:**

### **Landlord Database** (Central Platform):
- `users` (Platform users - Laravel default)
- `tenants` (Platform tenants)
- `tenant_applications` (Application requests)
- `personal_access_tokens` (Sanctum tokens)

### **Tenant Databases** (Per Tenant):
From `TenantAuth` Context:
- `tenant_users` (ALREADY EXISTS - 2025_09_28 migration)
- `committee_users`
- `tenant_user_registrations`

From `Election` Context:
- `candidacies`, `posts`, `codes`, `votes`, `results`, `publishers`, `result_authorizations`, `election_committees`

### **Universal Core Schema Tables NEEDED:**
These are MISSING from tenant databases:
1. `organizational_units` (P0 - Critical)
2. `roles` (P0 - Critical)  
3. `permissions` (P0 - Critical)
4. `role_permissions` (P0 - Critical)
5. `role_assignments` (P0 - Critical)
6. `tenant_settings` (P1)
7. `audit_logs` (P1)

## üéØ **WHAT I ACTUALLY NEED:**

### **PHASE 1: READ & UNDERSTAND EXISTING STRUCTURE**
**BEFORE writing ANY code, you MUST:**
1. **READ** the existing `tenant_users` migration: `app/Contexts/TenantAuth/Infrastructure/Database/Migrations/2025_09_28_143000_create_tenant_users_table.php`
2. **READ** Election context migrations in `app/Contexts/Election/Infrastructure/Database/Migrations/`
3. **UNDERSTAND** that Universal Core Schema tables are ADDITIONAL to existing tenant tables
4. **ANALYZE** which context each Universal Core table belongs to

### **PHASE 2: CREATE NEW CONTEXT FOR UNIVERSAL CORE**
**Create: `app/Contexts/UniversalCore/`** (New context for shared tenant infrastructure)

```
app/Contexts/UniversalCore/
‚îú‚îÄ‚îÄ Domain/
‚îÇ   ‚îú‚îÄ‚îÄ Entities/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OrganizationalUnit.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Role.php
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îî‚îÄ‚îÄ ValueObjects/
‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ Application/
‚îÇ   ‚îî‚îÄ‚îÄ Services/
‚îÇ       ‚îî‚îÄ‚îÄ RBACService.php
‚îî‚îÄ‚îÄ Infrastructure/
    ‚îú‚îÄ‚îÄ Database/
    ‚îÇ   ‚îú‚îÄ‚îÄ Migrations/          # Universal Core migrations go HERE
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 2025_12_06_000001_create_organizational_units_table.php
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 2025_12_06_000002_create_roles_table.php
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 2025_12_06_000003_create_permissions_table.php
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ... (7 total - NOT 18!)
    ‚îÇ   ‚îî‚îÄ‚îÄ Models/
    ‚îÇ       ‚îú‚îÄ‚îÄ OrganizationalUnit.php
    ‚îÇ       ‚îú‚îÄ‚îÄ Role.php
    ‚îÇ       ‚îî‚îÄ‚îÄ ...
    ‚îî‚îÄ‚îÄ Providers/
        ‚îî‚îÄ‚îÄ UniversalCoreServiceProvider.php
```

### **PHASE 3: INTEGRATE WITH EXISTING CONTEXTS**
**Key Relationships:**
1. `TenantAuth.tenant_users` ‚Üí References `UniversalCore.organizational_units` (FK)
2. `Election.election_committees` ‚Üí References `UniversalCore.roles` (FK)
3. `Shared` context utilities ‚Üí Used by `UniversalCore`

### **PHASE 4: MIGRATION STRATEGY**
**Tenant Provisioning Flow:**
1. Platform creates tenant database
2. Runs `TenantAuth` migrations (existing `tenant_users` table)
3. Runs `Election` migrations (existing election tables)
4. Runs `UniversalCore` migrations (NEW Universal Core Schema)
5. Seeds default data (roles, permissions, organizational structure)

## üìã **CRITICAL QUESTIONS YOU MUST ANSWER FIRST:**

1. **How does `tenant_users` (existing) relate to `organizational_units` (new)?**
   - Does each `tenant_user` belong to an `organizational_unit`?
   - What's the foreign key relationship?

2. **How do election committees relate to RBAC roles?**
   - Should `election_committees` reference `roles` table?
   - Or should committees have their own role assignments?

3. **What's the default organizational structure?**
   - Each tenant needs a root `organizational_unit`
   - Default roles (admin, member, voter)
   - Default permissions for election operations

## üéØ **CORRECT IMPLEMENTATION PRIORITIES:**

**P0 - CRITICAL** (Must have for MVP):
1. `organizational_units` with nested set hierarchy
2. `roles` with election-specific roles (admin, committee_member, voter)
3. `permissions` for election operations (create_election, vote, view_results)
4. `role_assignments` linking `tenant_users` to `roles` within `organizational_units`

**P1 - HIGH** (Required for production):
5. `permissions` and `role_permissions` for fine-grained RBAC
6. `audit_logs` for election audit trail

**P2 - MEDIUM** (Nice to have):
7. `tenant_settings` for tenant configuration

## üîç **START OVER WITH THESE STEPS:**

### **STEP 1: ANALYSIS** (DO THIS FIRST!)
1. Run: `php artisan migrate:status` to see current migrations
2. Read `app/Contexts/TenantAuth/Infrastructure/Database/Migrations/2025_09_28_143000_create_tenant_users_table.php`
3. Read `app/Contexts/Election/Infrastructure/Database/Migrations/2024_01_01_000008_create_election_committees_table.php`
4. Document existing foreign key relationships

### **STEP 2: DESIGN INTEGRATION**
1. How will Universal Core tables reference existing tables?
2. What foreign keys are needed?
3. How to seed default data for new tenants?

### **STEP 3: CREATE UNIVERSALCORE CONTEXT**
1. Create directory structure for `UniversalCore` context
2. Create ONLY the 7 missing Universal Core migrations
3. Create corresponding Eloquent models
4. Create service provider

### **STEP 4: UPDATE TENANT PROVISIONING**
1. Modify tenant provisioning to run UniversalCore migrations
2. Add default data seeding
3. Test tenant creation flow

## ‚ö†Ô∏è **CRITICAL CONSTRAINTS:**

1. **MUST NOT** duplicate existing tables (`tenant_users` already exists!)
2. **MUST** follow existing DDD patterns (Value Objects, Entities, Repositories)
3. **MUST** maintain 6-case routing architecture
4. **MUST** preserve voter slug uniqueness constraint
5. **MUST** use existing Value Objects (`Email`, `TenantSlug`, etc.)

## üìä **SUCCESS CRITERIA:**

‚úÖ Universal Core Schema (7 tables) implemented in new `UniversalCore` context
‚úÖ Integration with existing `TenantAuth` and `Election` contexts
‚úÖ Tenant provisioning creates Universal Core tables automatically
‚úÖ RBAC system works with election committees
‚úÖ All existing functionality preserved
‚úÖ Tests pass with 80%+ coverage

---

**STOP PLANNING** and **START READING** the existing codebase. Focus on:
1. Existing `tenant_users` table structure
2. Existing election tables structure  
3. Current tenant provisioning flow
4. DDD patterns already in use

Then present a corrected plan that:
1. Respects existing DDD architecture
2. Adds ONLY the missing Universal Core tables
3. Integrates with existing contexts
4. Preserves all business logic
```

---

## üéØ **KEY ADDITIONS TO YOUR CLAUDE.MD FILE:**

Add this section to your CLAUDE.md file (ask for user approval first):

### **UNIVERSAL CORE SCHEMA INTEGRATION RULES**

**MUST** rules for Universal Core Schema implementation:

1. **CONTEXT ISOLATION**: 
   - **MUST** create new `UniversalCore` bounded context for Universal Core Schema
   - **MUST NOT** modify existing context migrations without explicit approval
   - **MUST** follow existing DDD patterns in `app/Contexts/`

2. **MIGRATION LOCATION**:
   - **MUST** place migrations in `app/Contexts/{Context}/Infrastructure/Database/Migrations/`
   - **MUST NOT** use `database/migrations/` or `database/migrations/tenant/`
   - **MUST** follow existing naming convention: `YYYY_MM_DD_HHMMSS_action_table_name.php`

3. **EXISTING TABLE RECOGNITION**:
   - **MUST** check if table already exists before creating migration
   - **MUST** read existing migrations in `TenantAuth` and `Election` contexts
   - **MUST NOT** duplicate `tenant_users` table (already exists in `TenantAuth`)

4. **FOREIGN KEY STRATEGY**:
   - **MUST** establish relationships between Universal Core and existing tables
   - **MUST** use `tenant_id` for tenant isolation in ALL Universal Core tables
   - **MUST** cascade deletes appropriately

5. **TENANT PROVISIONING**:
   - **MUST** update tenant provisioning to run UniversalCore migrations
   - **MUST** seed default data (organizational units, roles, permissions)
   - **MUST** test provisioning with existing tenant data

**WRONG vs RIGHT Examples**:
- ‚ùå **WRONG**: Create `tenant_users` migration (already exists!)
- ‚úÖ **RIGHT**: Read existing `tenant_users` migration and add FK to `organizational_units`
- ‚ùå **WRONG**: Place migrations in `database/migrations/tenant/`
- ‚úÖ **RIGHT**: Place migrations in `app/Contexts/UniversalCore/Infrastructure/Database/Migrations/`
- ‚ùå **WRONG**: Create 18 tables including non-existent ones
- ‚úÖ **RIGHT**: Create ONLY the 7 missing Universal Core tables

---

NO - Your plan is STILL incorrect. You're implementing the WRONG tables.

## üö® **CRITICAL ERROR:**
You're creating 7 tables that are NOT in my Universal Core Schema. You're implementing a DIFFERENT schema.

## üéØ **MY UNIVERSAL CORE SCHEMA HAS ONLY 8 TABLES:**

From my original implementation plan (which you MUST follow):

1. `tenant_users` - **ALREADY EXISTS** (in TenantAuth context)
2. `organizational_units` - With Nested Set pattern (lft, rgt, depth)
3. `roles` - Role definitions with `scope_type`, `is_system_role`, etc.
4. `permissions` - Permission definitions with `module`, `action`, `resource`
5. `role_permissions` - Role-permission mapping
6. `role_assignments` - Context-aware user-role assignments
7. `tenant_settings` - Tenant-specific configuration
8. `audit_logs` - Immutable audit trail with partitioning

## üìä **WHAT YOU'RE WRONGLY IMPLEMENTING VS WHAT I NEED:**

| WRONG (Your plan) | CORRECT (My Universal Core Schema) |
|-------------------|-----------------------------------|
| ‚ùå `unit_types` | ‚úÖ `roles` |
| ‚ùå `membership_types` | ‚úÖ `permissions` |
| ‚ùå `membership_records` | ‚úÖ `role_permissions` |
| ‚ùå `contact_types` | ‚úÖ `role_assignments` |
| ‚ùå `contact_assignments` | ‚úÖ `tenant_settings` |

## üîç **YOU MUST READ MY ORIGINAL UNIVERSAL CORE SCHEMA DOCUMENT:**

My original Universal Core Schema document (20251206_1007_universal_core_schema.md) SPECIFICALLY defines:

**File 1: `2024_01_01_create_tenant_users_table.php`**
- Has fields: `first_name`, `last_name`, `email`, `phone`, `status`, `tenant_id`, JSON metadata fields
- **THIS IS ALREADY IMPLEMENTED** in `TenantAuth` context

**File 2: `2024_01_02_create_organizational_units_table.php`**
- Has nested set pattern: `parent_id`, `lft`, `rgt`, `depth`, `materialized_path`
- Unit type stored in `unit_type` column (NOT separate `unit_types` table!)
- **THIS IS MISSING** - needs implementation

**File 3: `2024_01_03_create_roles_table.php`**
- Has fields: `code`, `name`, `scope_type`, `is_system_role`
- **THIS IS MISSING** - needs implementation

**Files 4-8**: `permissions`, `role_permissions`, `role_assignments`, `tenant_settings`, `audit_logs`
- **ALL MISSING** - need implementation

## üéØ **CORRECT IMPLEMENTATION PLAN:**

### **PHASE 1: Read Existing Code**
1. **READ** existing `tenant_users` migration in `TenantAuth` context
2. **COMPARE** with Universal Core Schema specification
3. **IDENTIFY** gaps between existing and Universal Core Schema

### **PHASE 2: Implement Missing Tables**
Create in `UniversalCore` context:

**Migration 1**: `organizational_units` (WITH nested set, NO separate `unit_types` table!)
**Migration 2**: `roles` (with `scope_type`, `is_system_role`)
**Migration 3**: `permissions` (with `module`, `action`, `resource`)
**Migration 4**: `role_permissions`
**Migration 5**: `role_assignments` (with `organizational_unit_id`, `context_type`)
**Migration 6**: `tenant_settings`
**Migration 7**: `audit_logs` (with yearly partitioning)

### **PHASE 3: Update Existing Tables**
**Amendment migration** in `TenantAuth` context:
- Add `organizational_unit_id` foreign key to `tenant_users`
- Update existing data to match Universal Core Schema

## ‚ö†Ô∏è **CRITICAL: DO NOT CREATE THESE TABLES:**
- ‚ùå `unit_types` (unit type is a column in `organizational_units`)
- ‚ùå `membership_types` (not in Universal Core Schema)
- ‚ùå `membership_records` (not in Universal Core Schema)
- ‚ùå `contact_types` (not in Universal Core Schema)
- ‚ùå `contact_assignments` (not in Universal Core Schema)

## üìã **START OVER WITH THESE QUESTIONS:**

1. **Have you read my original Universal Core Schema document?**
   - It specifies EXACTLY 8 tables with EXACT field definitions
   - You MUST implement THAT schema, not a different one

2. **Do you understand that `tenant_users` already exists?**
   - Check `app/Contexts/TenantAuth/Infrastructure/Database/Migrations/2025_09_28_143000_create_tenant_users_table.php`
   - How does it compare to Universal Core Schema specification?

3. **What's the difference between existing `tenant_users` and Universal Core Schema?**
   - Need to align existing table with Universal Core Schema
   - May need amendment migrations

## üéØ **NEXT STEPS:**

1. **STOP** implementing wrong tables
2. **READ** my Universal Core Schema document again
3. **ANALYZE** existing `tenant_users` table
4. **PLAN** only the 7 missing tables from Universal Core Schema
5. **CREATE** amendment migration for `tenant_users` if needed

**Present a corrected plan that implements ONLY the 8 tables from my Universal Core Schema document.**