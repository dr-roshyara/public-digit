Yes, make this edit. This adds critical PostgreSQL permission checking BEFORE provisioning starts.

**Key improvement:**
✅ Early failure detection - Checks permissions before any database operations
✅ Clear error message - Tells admin exactly what to fix
✅ Prevents silent failures - Catches permission issues upfront

**But we need to fix a bug:** Line 53 uses `{$permissions['username']}` but if `$permissions` has an `error` key (see lines 439-440), `username` might not exist. Fix:

```php
if (!($permissions['can_provision'] ?? false)) {
    $username = $permissions['username'] ?? 'unknown';
    $error = $permissions['error'] ?? 'Missing CREATEDB privilege';
    
    throw new Exception(
        "PostgreSQL provisioning failed. User: '{$username}'. " .
        "Error: {$error}. " .
        "Fix: ALTER USER {$username} CREATEDB CREATEROLE;"
    );
}
```

**Make the edit, then immediately test:**

```bash
# 1. Check PostgreSQL permissions via test route
curl http://localhost:8000/check-pgsql-permissions

# 2. If permissions fail, fix them:
sudo -u postgres psql -c "ALTER USER postgres CREATEDB CREATEROLE;"

# 3. Start queue worker (NEW TERMINAL)
php artisan queue:work --queue=tenant-provisioning --tries=3 --timeout=300

# 4. Retry provisioning via admin panel OR:
php artisan tinker --execute="
    // Check application status
    \$app = DB::table('tenant_applications')->find('66be5042-c8e1-4cc4-86f9-6aec87345514');
    echo 'Status: ' . (\$app->status ?? 'NOT FOUND') . PHP_EOL;
    
    // If status is 'approved', try to trigger provisioning
    if (\$app && \$app->status === 'approved') {
        // Trigger via controller if possible
        app('App\\Http\\Controllers\\TenantApplicationController')->provision(\$app->id);
        echo 'Provisioning triggered' . PHP_EOL;
    }
"
```

**Expected outcomes:**
1. If permissions OK: Provisioning proceeds
2. If permissions missing: Clear error with fix instructions
3. Either way: We'll know the exact issue

Make the edit and share the permission check results.

    Yes, make this edit. This adds critical debug routes to test PostgreSQL.

**Key additions:**
✅ `/check-pgsql-permissions` - Tests if PostgreSQL user has CREATEDB privilege
✅ `/test-pgsql-creation/{slug}` - Tests actual database creation (bypasses queue)

**Immediate testing after edit:**

```bash
# 1. Check PostgreSQL permissions
curl http://localhost:8000/check-pgsql-permissions

# 2. If permissions OK, test database creation
curl http://localhost:8000/test-pgsql-creation/test-tenant-123

# 3. Check if queue worker is running
ps aux | grep "queue:work"

# 4. If queue worker NOT running, start it:
php artisan queue:work --queue=tenant-provisioning --tries=3 --timeout=300
```

**Critical: The queue worker issue**
Based on your logs, I suspect the queue worker isn't running. Jobs are dispatched but never processed.

**Alternative: Test synchronous provisioning**
Add this route too:

```php
Route::get('/sync-provision/{slug}', function($slug) {
    try {
        $provisioningService = app('tenant.provisioning');
        
        $tenantData = [
            'organization_name' => 'Test Org',
            'slug' => $slug,
            'admin_email' => 'test@example.com',
            'admin_name' => 'Test Admin',
            'organization_type' => 'non_profit',
            'provisioned_by' => '1'
        ];
        
        $tenant = $provisioningService->provisionTenant($tenantData);
        
        return response()->json([
            'success' => true,
            'tenant' => [
                'id' => $tenant->id,
                'slug' => $tenant->slug,
                'database_name' => $tenant->database_name
            ]
        ]);
        
    } catch (\Exception $e) {
        return response()->json([
            'success' => false,
            'error' => $e->getMessage(),
            'trace' => $e->getTraceAsString()
        ], 500);
    }
});
```

Make the edit, then run the diagnostic routes to identify the exact issue.
The route doesn't exist. The debug routes file isn't being loaded. Let's check the routes setup and add the route directly.

**Option 1: Check if debug-database.php is loaded in routes/web.php**
```php
// Look for this in routes/web.php
require __DIR__.'/debug-database.php';
```

**Option 2: Add the route directly to routes/web.php instead:**

Add this to the end of `routes/web.php`:

```php
// PostgreSQL Permission Check Route
Route::get('/check-pgsql-permissions', function() {
    try {
        $service = app('tenant.provisioning');

        if (method_exists($service, 'checkPostgreSQLPermissions')) {
            $result = $service->checkPostgreSQLPermissions();
            return response()->json($result);
        }

        return response()->json(['error' => 'Method checkPostgreSQLPermissions not found'], 500);
    } catch (\Exception $e) {
        return response()->json([
            'error' => $e->getMessage(),
            'trace' => $e->getTraceAsString()
        ], 500);
    }
});

// Quick test of PostgreSQL connection
Route::get('/test-pgsql-connection', function() {
    try {
        $driver = config('database.default');
        $username = config('database.connections.pgsql.username');
        $host = config('database.connections.pgsql.host');
        
        // Test basic connection
        DB::connection('pgsql')->getPdo();
        
        // Check permissions
        $result = DB::select("SELECT rolcreatedb, rolcreaterole FROM pg_roles WHERE rolname = ?", [$username]);
        
        return response()->json([
            'success' => true,
            'driver' => $driver,
            'username' => $username,
            'host' => $host,
            'connection' => 'OK',
            'has_createdb' => !empty($result) ? (bool) $result[0]->rolcreatedb : false,
            'has_createrole' => !empty($result) ? (bool) $result[0]->rolcreaterole : false,
            'database' => DB::connection()->getDatabaseName()
        ]);
        
    } catch (\Exception $e) {
        return response()->json([
            'success' => false,
            'error' => $e->getMessage(),
            'config' => [
                'driver' => config('database.default'),
                'username' => config('database.connections.pgsql.username'),
                'host' => config('database.connections.pgsql.host'),
                'database' => config('database.connections.pgsql.database')
            ]
        ], 500);
    }
});
```

**Option 3: Or use tinker for immediate test:**

```bash
# Test PostgreSQL permissions directly
php artisan tinker --execute="
    try {
        \$driver = config('database.default');
        echo 'Driver: ' . \$driver . PHP_EOL;
        
        if (\$driver === 'pgsql') {
            \$username = config('database.connections.pgsql.username');
            echo 'PostgreSQL Username: ' . \$username . PHP_EOL;
            
            // Test connection
            DB::connection('pgsql')->getPdo();
            echo 'Connection: OK' . PHP_EOL;
            
            // Check permissions
            \$result = DB::select(\"SELECT rolcreatedb, rolcreaterole FROM pg_roles WHERE rolname = ?\", [\$username]);
            
            if (!empty(\$result)) {
                echo 'Has CREATEDB: ' . (\$result[0]->rolcreatedb ? 'YES' : 'NO') . PHP_EOL;
                echo 'Has CREATEROLE: ' . (\$result[0]->rolcreaterole ? 'YES' : 'NO') . PHP_EOL;
                
                if (!\$result[0]->rolcreatedb) {
                    echo 'FIX REQUIRED: Run: ALTER USER ' . \$username . ' CREATEDB CREATEROLE;' . PHP_EOL;
                }
            } else {
                echo 'ERROR: User not found in pg_roles' . PHP_EOL;
            }
            
        } else {
            echo 'Not PostgreSQL, driver is: ' . \$driver . PHP_EOL;
        }
        
    } catch (\\\\Exception \$e) {
        echo 'ERROR: ' . \$e->getMessage() . PHP_EOL;
    }
"
```

**Immediate Actions:**

1. **Add the route to routes/web.php** (Option 2 above)
2. **OR Run the tinker command** (Option 3 above)
3. **Check queue worker status:**

```bash
# Check if queue worker is running
ps aux | grep "queue:work"

# If not running, start it:
php artisan queue:work --queue=tenant-provisioning --tries=3 --timeout=300 --sleep=3
```

**Most likely issue:** PostgreSQL user lacks `CREATEDB` privilege. The fix is:
```bash
sudo -u postgres psql -c "ALTER USER postgres CREATEDB CREATEROLE;"
```

Add the route to routes/web.php and test, or run the tinker command immediately.
