# **Claude CLI Prompt Instructions: Revert PlatformServiceProvider & Fix Root Cause**

## **Title:** Fix PostgreSQL Password Setup - Revert & Direct Solution

## **Immediate Action Required:**
**DO NOT create revert_platform_provider.php file.** Instead, directly revert the PlatformServiceProvider and implement the correct solution.

## **Step 1: Directly revert PlatformServiceProvider:**

```bash
# Edit PlatformServiceProvider.php directly to revert
cat > /tmp/revert_provider.sh << 'EOF'
#!/bin/bash
FILE="app/Contexts/Platform/Infrastructure/Providers/PlatformServiceProvider.php"

# Create backup
cp "$FILE" "${FILE}.backup.$(date +%Y%m%d_%H%M%S)"

# Revert to original binding
sed -i '49,52c\        // Database Provisioner - Following DDD: Domain interface, Infrastructure implementation
        $this->app->singleton(DatabaseProvisionerInterface::class, function ($app) {
            $driver = config('\''database.default'\'');
            
            if ($driver === '\''pgsql'\'') {
                return new \\App\\Contexts\\Platform\\Infrastructure\\Database\\PostgreSQLDatabaseProvisioner();
            } else {
                return new \\App\\Contexts\\Platform\\Infrastructure\\Database\\MySQLDatabaseProvisioner();
            }
        });' "$FILE"

echo "✅ PlatformServiceProvider reverted to original binding"
EOF

chmod +x /tmp/revert_provider.sh
bash /tmp/revert_provider.sh
```

## **Step 2: Apply the TenantAwareDatabaseProvisioner constructor improvements (they're good):**
**YES** to the TenantAwareDatabaseProvisioner.php edit. The constructor improvements are useful for debugging.

## **Step 3: The REAL fix - Update SecureSetupTokenService:**

```bash
# First find how SecureSetupTokenService uses provisioner
cat > find_provisioner_usage.sh << 'EOF'
#!/bin/bash
FILE="app/Contexts/Platform/Application/Services/SecureSetupTokenService.php"

if [ -f "$FILE" ]; then
    echo "=== Searching SecureSetupTokenService ==="
    grep -n "DynamicDatabaseProvisioningService\|DatabaseProvisionerInterface\|provisionDatabase\|createDatabase" "$FILE"
    
    echo -e "\n=== Constructor of SecureSetupTokenService ==="
    grep -A 10 "public function __construct" "$FILE"
    
    echo -e "\n=== submitPassword method ==="
    grep -B 5 -A 20 "public function submitPassword" "$FILE"
else
    echo "File not found: $FILE"
fi
EOF

bash find_provisioner_usage.sh
```

## **Step 4: Based on findings, implement the fix:**

The issue is that `SecureSetupTokenService` uses `DynamicDatabaseProvisioningService` which gets the wrong provisioner from the container. We need to either:

**Option A: Inject tenant-aware provisioner into DynamicDatabaseProvisioningService**

```bash
# Update DynamicDatabaseProvisioningService to accept tenant ID
cat > fix_dynamic_provisioning.sh << 'EOF'
#!/bin/bash
FILE="app/Contexts/Platform/Application/Services/DynamicDatabaseProvisioningService.php"

if [ -f "$FILE" ]; then
    # Check current constructor
    echo "Current constructor:"
    grep -A 5 "public function __construct" "$FILE"
    
    # We need to modify so it can use tenant-aware provisioner
    echo -e "\nThe service needs to accept tenant ID to create correct provisioner."
else
    echo "File not found"
fi
EOF

bash fix_dynamic_provisioning.sh
```

**Option B: Quick fix - Modify SecureSetupTokenService to use correct provisioner:**

```bash
# Direct fix in SecureSetupTokenService
cat > quick_fix_secure_setup.sh << 'EOF'
#!/bin/bash
FILE="app/Contexts/Platform/Application/Services/SecureSetupTokenService.php"

if [ -f "$FILE" ]; then
    # Create backup
    cp "$FILE" "${FILE}.backup"
    
    # Find where DynamicDatabaseProvisioningService is used
    # Look for the line that calls a method on it
    LINE=$(grep -n "dynamicDatabaseProvisioningService" "$FILE" | head -1 | cut -d: -f1)
    
    if [ -n "$LINE" ]; then
        echo "Found usage at line $LINE"
        # We need to see the context
        sed -n "$((LINE-5)),$((LINE+10))p" "$FILE"
    else
        echo "Could not find DynamicDatabaseProvisioningService usage"
        # Show more of the file
        head -100 "$FILE" | tail -50
    fi
else
    echo "File not found"
fi
EOF

bash quick_fix_secure_setup.sh
```

## **Step 5: If files are complex, create a simple override:**

```bash
# Create a temporary override in app/Providers/AppServiceProvider.php
cat > create_override.sh << 'EOF'
#!/bin/bash
FILE="app/Providers/AppServiceProvider.php"

if [ -f "$FILE" ]; then
    # Add binding override at end of register() method
    sed -i '/public function register()/a\
    // OVERRIDE: Force PostgreSQL provisioner for password setup\
    $this->app->when(App\\Contexts\\Platform\\Application\\Services\\SecureSetupTokenService::class)\
        ->needs(App\\Contexts\\Platform\\Domain\\Repositories\\DatabaseProvisionerInterface::class)\
        ->give(function ($app) {\
            // Get tenant ID from token (simplified)\\
            return new App\\Contexts\\Platform\\Infrastructure\\Database\\TenantAwareDatabaseProvisioner();\
        });' "$FILE"
    
    echo "✅ Added override to AppServiceProvider"
else
    echo "Creating simple test fix..."
    
    cat > test_fix.php << 'PHPEOF'
<?php
// Test the actual flow
require __DIR__.'/vendor/autoload.php';
$app = require_once __DIR__.'/bootstrap/app.php';
$app->make(Illuminate\Contracts\Console\Kernel::class)->bootstrap();

$tenantId = '41c38d38-564a-4e50-8054-d687af20408a';

// 1. Get tenant database config
$db = DB::table('tenant_databases')->where('tenant_id', $tenantId)->first();
echo "Tenant DB: " . ($db->database_name ?? 'none') . "\n";
echo "Driver: " . ($db->database_driver ?? 'NOT SET') . "\n";

// 2. Create provisioner based on tenant driver
if ($db && ($db->database_driver ?? '') === 'pgsql') {
    $provisioner = new App\Contexts\Platform\Infrastructure\Database\PostgreSQLDatabaseProvisioner();
} else {
    $provisioner = new App\Contexts\Platform\Infrastructure\Database\MySQLDatabaseProvisioner();
}

echo "Using provisioner: " . get_class($provisioner) . "\n";
echo "Driver: " . $provisioner->getDriver() . "\n";
PHPEOF
    
    php test_fix.php
fi
EOF

bash create_override.sh
```

## **Summary:**
1. **Revert PlatformServiceProvider** - Use original working binding
2. **Keep TenantAwareDatabaseProvisioner improvements** - Good for debugging
3. **Find where SecureSetupTokenService fails** and inject correct provisioner
4. **Test password setup** - Should work with PostgreSQL provisioner

**The root issue: Services need tenant context to select correct provisioner, but singleton binding lacks this context.**