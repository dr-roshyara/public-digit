Perfect! Now I have the complete picture. You have:

1. ‚úÖ **Working Membership module** with `InstallMembershipModule` job
2. ‚úÖ **MembershipDatabaseSeeder** pattern
3. ‚úÖ **Tenant admin context** already exists via `TenantUserManager`
4. ‚úÖ **DigitalCard context** already built

Let me provide the **minimal, direct implementation** to add DigitalCard installation with subscriptions.

## üöÄ **CONCRETE Implementation (2-3 Hours)**

### **Step 1: Create DigitalCard Database Seeder (15 min)**

Copy the Membership pattern:

```php
<?php
// File: packages/laravel-backend/app/Contexts/DigitalCard/Infrastructure/Database/Seeders/DigitalCardDatabaseSeeder.php

namespace App\Contexts\DigitalCard\Infrastructure\Database\Seeders;

use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\Artisan;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;

class DigitalCardDatabaseSeeder extends Seeder
{
    public function run(): void
    {
        Log::info('Starting DigitalCard module database seeding', [
            'database' => DB::connection()->getDatabaseName(),
        ]);

        try {
            // Run DigitalCard migrations
            $this->runDigitalCardMigrations();
            
            // Seed default data (if needed in future)
            $this->seedDefaultData();
            
            Log::info('DigitalCard module database seeding completed successfully');
        } catch (\Exception $e) {
            Log::error('DigitalCard module database seeding failed', [
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
            ]);
            
            throw $e;
        }
    }
    
    protected function runDigitalCardMigrations(): void
    {
        $migrationPath = 'app/Contexts/DigitalCard/Infrastructure/Database/Migrations';
        
        Log::info('Running DigitalCard migrations', [
            'path' => $migrationPath,
            'database' => DB::connection()->getDatabaseName(),
        ]);
        
        Artisan::call('migrate', [
            '--path' => $migrationPath,
            '--database' => 'tenant_install',
            '--force' => true,
        ]);
        
        Log::info('DigitalCard migrations completed', [
            'output' => Artisan::output(),
        ]);
    }
    
    protected function seedDefaultData(): void
    {
        // No default data needed for now
        // Digital cards are created dynamically
        Log::debug('Skipping DigitalCard default data - none required');
    }
}
```

### **Step 2: Create InstallDigitalCardModule Job (15 min)**

Copy from Membership job with minimal changes:

```php
<?php
// File: packages/laravel-backend/app/Contexts/DigitalCard/Application/Jobs/InstallDigitalCardModule.php

namespace App\Contexts\DigitalCard\Application\Jobs;

use App\Helpers\DatabaseHelper;
use App\Contexts\DigitalCard\Infrastructure\Database\Seeders\DigitalCardDatabaseSeeder;
use App\Models\Tenant;
use Illuminate\Bus\Queueable;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Foundation\Bus\Dispatchable;
use Illuminate\Queue\InteractsWithQueue;
use Illuminate\Queue\SerializesModels;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Spatie\Multitenancy\Jobs\NotTenantAware;

class InstallDigitalCardModule implements ShouldQueue, NotTenantAware
{
    use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;

    public $tries = 3;
    public $timeout = 600;
    protected Tenant $tenant;

    public function __construct(Tenant $tenant)
    {
        $this->tenant = $tenant;
        $this->onQueue('tenant-provisioning');
    }

    public function handle(): void
    {
        Log::info('Starting DigitalCard module installation', [
            'tenant_id' => $this->tenant->id,
            'tenant_slug' => $this->tenant->slug,
            'database' => $this->tenant->getDatabaseName(),
        ]);

        try {
            DB::beginTransaction();
            
            // Switch to tenant database
            $this->switchToTenantDatabase();
            
            // Ensure PostgreSQL schema
            $this->ensurePostgresSchema();
            
            // Run DigitalCard seeder
            $this->runDigitalCardSeeder();
            
            // Switch back to landlord
            $this->switchToLandlordDatabase();
            
            // Update tenant metadata
            $this->updateTenantMetadata();
            
            DB::commit();
            
            Log::info('DigitalCard module installation completed successfully', [
                'tenant_id' => $this->tenant->id,
                'timestamp' => now()->toIso8601String(),
            ]);
            
        } catch (\Exception $e) {
            DB::rollBack();
            
            Log::error('DigitalCard module installation failed', [
                'tenant_id' => $this->tenant->id,
                'error' => $e->getMessage(),
            ]);
            
            $this->ensureLandlordConnection();
            $this->markInstallationFailed($e->getMessage());
            
            throw $e;
        } finally {
            $this->ensureLandlordConnection();
        }
    }
    
    protected function switchToTenantDatabase(): void
    {
        $databaseName = $this->tenant->getDatabaseName();
        
        DatabaseHelper::configureTenantConnection(
            $databaseName,
            'tenant_install'
        );
    }
    
    protected function ensurePostgresSchema(): void
    {
        DB::statement('CREATE SCHEMA IF NOT EXISTS public');
        DB::statement('SET search_path TO public');
        DB::statement('GRANT ALL ON SCHEMA public TO public');
    }
    
    protected function runDigitalCardSeeder(): void
    {
        Log::info('Running DigitalCard database seeder');
        
        $seeder = new DigitalCardDatabaseSeeder();
        $seeder->run();
        
        Log::info('DigitalCard database seeder completed');
    }
    
    protected function switchToLandlordDatabase(): void
    {
        DatabaseHelper::switchToLandlordConnection();
    }
    
    protected function ensureLandlordConnection(): void
    {
        $currentConnection = config('database.default');
        if ($currentConnection !== 'pgsql') {
            DatabaseHelper::switchToLandlordConnection();
        }
    }
    
    protected function updateTenantMetadata(): void
    {
        $metadata = $this->tenant->metadata ?? [];
        $metadata['modules'] = $metadata['modules'] ?? [];
        
        $metadata['modules']['digital_card'] = [
            'installed' => true,
            'installed_at' => now()->toIso8601String(),
            'version' => '1.0.0',
            'status' => 'active',
            'database' => $this->tenant->getDatabaseName(),
            'last_updated' => now()->toIso8601String(),
        ];
        
        $this->tenant->update(['metadata' => $metadata]);
        
        Log::info('Tenant metadata updated with DigitalCard module');
    }
    
    protected function markInstallationFailed(string $errorMessage): void
    {
        try {
            $metadata = $this->tenant->metadata ?? [];
            $metadata['modules'] = $metadata['modules'] ?? [];
            
            $metadata['modules']['digital_card'] = [
                'installed' => false,
                'last_install_attempt' => now()->toIso8601String(),
                'status' => 'failed',
                'error' => $errorMessage,
                'retry_count' => ($metadata['modules']['digital_card']['retry_count'] ?? 0) + 1,
            ];
            
            $this->tenant->update(['metadata' => $metadata]);
            
        } catch (\Exception $e) {
            Log::error('Failed to mark DigitalCard installation as failed', [
                'tenant_id' => $this->tenant->id,
                'error' => $e->getMessage(),
            ]);
        }
    }
    
    public function failed(\Throwable $exception): void
    {
        Log::error('DigitalCard module installation job failed after all retries', [
            'tenant_id' => $this->tenant->id,
            'error' => $exception->getMessage(),
        ]);
        
        $this->ensureLandlordConnection();
        $this->markInstallationFailed(
            sprintf('Job failed after %d attempts: %s', $this->attempts(), $exception->getMessage())
        );
    }
}
```

### **Step 3: Create SubscriptionManager (15 min)**

Simple version in your admin context:

```php
<?php
// File: packages/laravel-backend/app/Contexts/TenantAuth/Application/Services/SubscriptionManager.php

namespace App\Contexts\TenantAuth\Application\Services;

use App\Models\Tenant;
use Illuminate\Support\Facades\DB;

class SubscriptionManager
{
    public function subscribe(Tenant $tenant, string $module, string $plan = 'free_trial'): bool
    {
        // Check if already subscribed
        if ($this->isSubscribed($tenant, $module)) {
            return true;
        }
        
        DB::table('tenant_subscriptions')->insert([
            'tenant_id' => $tenant->id,
            'module' => $module,
            'plan' => $plan,
            'status' => 'active',
            'created_at' => now(),
            'updated_at' => now(),
        ]);
        
        return true;
    }
    
    public function isSubscribed(Tenant $tenant, string $module): bool
    {
        return DB::table('tenant_subscriptions')
            ->where('tenant_id', $tenant->id)
            ->where('module', $module)
            ->where('status', 'active')
            ->exists();
    }
    
    public function hasFreeTrial(Tenant $tenant): bool
    {
        // Simplified: Nepali political parties get free trial
        return $tenant->country === 'NP' && 
               $tenant->organization_type === 'political_party';
    }
    
    public function activateFreeTrial(Tenant $tenant, string $module): bool
    {
        return $this->subscribe($tenant, $module, 'free_trial');
    }
}
```

### **Step 4: Add Admin Route & Controller (30 min)**

Add to your existing admin routes:

```php
// In your admin routes file (e.g., routes/tenant-admin.php)
Route::post('/modules/digital-card/install', 
    [TenantModuleController::class, 'installDigitalCard'])
    ->name('tenant-admin.modules.digital-card.install');

Route::post('/modules/digital-card/uninstall', 
    [TenantModuleController::class, 'uninstallDigitalCard'])
    ->name('tenant-admin.modules.digital-card.uninstall');
```

Create or extend your admin controller:

```php
<?php
// File: packages/laravel-backend/app/Http/Controllers/TenantAdmin/TenantModuleController.php

namespace App\Http\Controllers\TenantAdmin;

use App\Contexts\DigitalCard\Application\Jobs\InstallDigitalCardModule;
use App\Contexts\TenantAuth\Application\Services\SubscriptionManager;
use App\Contexts\TenantAuth\Application\Services\TenantUserManager;
use App\Models\Tenant;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;

class TenantModuleController extends Controller
{
    protected $tenantUserManager;
    protected $subscriptionManager;
    
    public function __construct(
        TenantUserManager $tenantUserManager,
        SubscriptionManager $subscriptionManager
    ) {
        $this->tenantUserManager = $tenantUserManager;
        $this->subscriptionManager = $subscriptionManager;
    }
    
    public function installDigitalCard(Request $request)
    {
        // Get current tenant (from tenant context)
        $tenant = $this->getCurrentTenant();
        
        // Check if already installed
        if ($this->isModuleInstalled($tenant, 'digital_card')) {
            return response()->json([
                'success' => false,
                'message' => 'Digital Card module is already installed'
            ], 400);
        }
        
        // Handle subscription
        if ($this->subscriptionManager->hasFreeTrial($tenant)) {
            // Activate free trial for Nepali parties
            $this->subscriptionManager->activateFreeTrial($tenant, 'digital_card');
        } else {
            // Check subscription for others
            if (!$this->subscriptionManager->isSubscribed($tenant, 'digital_card')) {
                return response()->json([
                    'success' => false,
                    'message' => 'Subscription required for Digital Card module'
                ], 402); // Payment Required
            }
        }
        
        // Dispatch installation job
        InstallDigitalCardModule::dispatch($tenant);
        
        return response()->json([
            'success' => true,
            'message' => 'Digital Card module installation started',
            'has_free_trial' => $this->subscriptionManager->hasFreeTrial($tenant)
        ]);
    }
    
    public function moduleStatus()
    {
        $tenant = $this->getCurrentTenant();
        $metadata = $tenant->metadata ?? [];
        $modules = $metadata['modules'] ?? [];
        
        return response()->json([
            'modules' => [
                'digital_card' => [
                    'installed' => $modules['digital_card']['installed'] ?? false,
                    'installed_at' => $modules['digital_card']['installed_at'] ?? null,
                    'status' => $modules['digital_card']['status'] ?? 'not_installed',
                    'requires_subscription' => !$this->subscriptionManager->hasFreeTrial($tenant),
                    'has_subscription' => $this->subscriptionManager->isSubscribed($tenant, 'digital_card'),
                    'has_free_trial' => $this->subscriptionManager->hasFreeTrial($tenant),
                ],
                'membership' => [
                    'installed' => $modules['membership']['installed'] ?? false,
                    'installed_at' => $modules['membership']['installed_at'] ?? null,
                    'status' => $modules['membership']['status'] ?? 'not_installed',
                ]
            ]
        ]);
    }
    
    protected function getCurrentTenant(): Tenant
    {
        // Get tenant from current context
        // Adjust based on your tenant identification logic
        return Tenant::current();
    }
    
    protected function isModuleInstalled(Tenant $tenant, string $module): bool
    {
        $metadata = $tenant->metadata ?? [];
        $modules = $metadata['modules'] ?? [];
        
        return $modules[$module]['installed'] ?? false;
    }
}
```

### **Step 5: Create Subscription Table Migration (10 min)**

```bash
cd packages/laravel-backend
php artisan make:migration create_tenant_subscriptions_table
```

```php
<?php
// File: database/migrations/2025_12_26_140000_create_tenant_subscriptions_table.php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('tenant_subscriptions', function (Blueprint $table) {
            $table->id();
            $table->foreignId('tenant_id')->constrained()->onDelete('cascade');
            $table->string('module'); // 'digital_card', 'membership'
            $table->string('plan')->default('free_trial'); // 'free_trial', 'premium', 'enterprise'
            $table->string('status')->default('active'); // 'active', 'canceled', 'expired'
            $table->timestamp('trial_ends_at')->nullable();
            $table->timestamp('ends_at')->nullable();
            $table->timestamps();
            
            $table->unique(['tenant_id', 'module']);
            $table->index(['tenant_id', 'module', 'status']);
        });
    }
    
    public function down(): void
    {
        Schema::dropIfExists('tenant_subscriptions');
    }
};
```

### **Step 6: Add Admin UI Component (45 min)**

Add to your tenant admin panel (wherever you manage modules):

```blade
{{-- In your tenant-admin dashboard view --}}
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Module Management</h5>
    </div>
    <div class="card-body">
        <!-- Digital Card Module -->
        <div class="module-item border-bottom pb-3 mb-3">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h6 class="mb-1">
                        <i class="fas fa-id-card text-primary me-2"></i>
                        Digital Card Module
                    </h6>
                    <p class="text-muted small mb-2">
                        Create digital membership cards with QR codes for verification
                    </p>
                    
                    <!-- Status Badges -->
                    <div class="d-flex gap-2 mb-2">
                        @if($digitalCardStatus['installed'])
                            <span class="badge bg-success">
                                <i class="fas fa-check-circle me-1"></i> Installed
                            </span>
                        @else
                            <span class="badge bg-secondary">
                                <i class="fas fa-times-circle me-1"></i> Not Installed
                            </span>
                        @endif
                        
                        @if($digitalCardStatus['has_free_trial'])
                            <span class="badge bg-info">
                                <i class="fas fa-gift me-1"></i> Free Trial Available
                            </span>
                        @elseif($digitalCardStatus['has_subscription'])
                            <span class="badge bg-primary">
                                <i class="fas fa-check me-1"></i> Subscribed
                            </span>
                        @endif
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div>
                    @if(!$digitalCardStatus['installed'])
                        <button type="button" 
                                class="btn btn-sm {{ $digitalCardStatus['has_free_trial'] ? 'btn-success' : 'btn-primary' }}"
                                onclick="installDigitalCardModule()"
                                id="installDigitalCardBtn">
                            @if($digitalCardStatus['has_free_trial'])
                                <i class="fas fa-gift me-1"></i> Activate Free Trial
                            @else
                                <i class="fas fa-download me-1"></i> Install Module
                            @endif
                        </button>
                    @else
                        <span class="text-success small">
                            <i class="fas fa-check me-1"></i>
                            Installed {{ $digitalCardStatus['installed_at'] ? \Carbon\Carbon::parse($digitalCardStatus['installed_at'])->diffForHumans() : '' }}
                        </span>
                    @endif
                </div>
            </div>
            
            <!-- Installation Progress (hidden by default) -->
            <div id="digitalCardInstallProgress" class="mt-2" style="display: none;">
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" 
                         style="width: 0%">
                    </div>
                </div>
                <p class="small text-muted mt-1 mb-0" id="installMessage">
                    Starting installation...
                </p>
            </div>
        </div>
        
        <!-- Membership Module (existing) -->
        <div class="module-item">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-1">
                        <i class="fas fa-users text-primary me-2"></i>
                        Membership Module
                    </h6>
                    <p class="text-muted small mb-0">
                        Manage organization members and committees
                    </p>
                </div>
                <div>
                    @if($membershipStatus['installed'])
                        <span class="badge bg-success">‚úì Installed</span>
                    @else
                        <span class="badge bg-secondary">Not Installed</span>
                    @endif
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Add this JavaScript to your tenant admin scripts
function installDigitalCardModule() {
    const btn = document.getElementById('installDigitalCardBtn');
    const progress = document.getElementById('digitalCardInstallProgress');
    const message = document.getElementById('installMessage');
    
    // Show progress bar
    btn.disabled = true;
    progress.style.display = 'block';
    message.textContent = 'Starting Digital Card module installation...';
    
    // Simulate progress (you'll replace with real polling)
    let progressPercent = 0;
    const progressBar = progress.querySelector('.progress-bar');
    const progressInterval = setInterval(() => {
        progressPercent += 5;
        progressBar.style.width = progressPercent + '%';
        
        if (progressPercent >= 100) {
            clearInterval(progressInterval);
            message.textContent = 'Installation complete! Refreshing...';
            setTimeout(() => location.reload(), 2000);
        }
    }, 500);
    
    // Make API call
    fetch('/tenant-admin/modules/digital-card/install', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            message.textContent = 'Installation started successfully! This may take a minute...';
            
            // Poll for installation status
            pollInstallationStatus();
        } else {
            clearInterval(progressInterval);
            message.textContent = 'Error: ' + data.message;
            btn.disabled = false;
        }
    })
    .catch(error => {
        clearInterval(progressInterval);
        message.textContent = 'Network error. Please try again.';
        btn.disabled = false;
        console.error('Error:', error);
    });
}

function pollInstallationStatus() {
    // Poll every 5 seconds for status
    const pollInterval = setInterval(() => {
        fetch('/tenant-admin/modules/status')
            .then(response => response.json())
            .then(data => {
                if (data.modules.digital_card.installed) {
                    clearInterval(pollInterval);
                    document.getElementById('installMessage').textContent = 
                        'Installation complete! Refreshing page...';
                    setTimeout(() => location.reload(), 2000);
                }
            });
    }, 5000);
}

// Load module status on page load
document.addEventListener('DOMContentLoaded', function() {
    fetch('/tenant-admin/modules/status')
        .then(response => response.json())
        .then(data => {
            // You can update UI dynamically if needed
            console.log('Module status:', data);
        });
});
</script>
```

## üéØ **Immediate Testing (30 min)**

```bash
# 1. Run migration
cd packages/laravel-backend
php artisan migrate

# 2. Test with a Nepali party tenant
php artisan tinker
> $tenant = Tenant::where('country', 'NP')
>                ->where('organization_type', 'political_party')
>                ->first();
> $manager = new App\Contexts\TenantAuth\Application\Services\SubscriptionManager();
> $manager->hasFreeTrial($tenant); // Should return true
> $manager->activateFreeTrial($tenant, 'digital_card'); // Should work

# 3. Test installation job
> $job = new App\Contexts\DigitalCard\Application\Jobs\InstallDigitalCardModule($tenant);
> $job->handle(); // Should install digital_cards table in tenant DB

# 4. Verify tenant metadata
> $tenant->refresh();
> $tenant->metadata['modules']['digital_card']; // Should show installed
```

## üìä **Final Checklist**

- [ ] `DigitalCardDatabaseSeeder.php` created
- [ ] `InstallDigitalCardModule.php` job created
- [ ] `SubscriptionManager.php` created
- [ ] `tenant_subscriptions` table migrated
- [ ] Admin routes added
- [ ] `TenantModuleController.php` methods added
- [ ] Admin UI component added
- [ ] Test with Nepali party tenant
- [ ] Test with non-Nepali tenant (should require subscription)

## üö® **Important Notes**

1. **Free Trial Logic**: Currently checks `country === 'NP' && organization_type === 'political_party'`
   - You may need to adjust based on your actual tenant data structure
   - Consider adding `free_trial_eligible` field to tenants table

2. **Subscription Flow**:
   - Nepali parties: Automatic free trial ‚Üí Install
   - Others: Check subscription ‚Üí Manual payment/approval ‚Üí Install

3. **Installation Queue**: Uses same `tenant-provisioning` queue as Membership module

4. **Metadata Structure**: Consistent with Membership module pattern

**Total Estimated Time**: 2-3 hours for complete implementation

Would you like me to provide the exact controller/route locations based on your current admin panel structure?
Let me review, analyze, and rewrite the implementation plan for the business modules to create a comprehensive, structured approach.

## **BUSINESS MODULES IMPLEMENTATION PLAN**
### **Digital Card Service Provider: Tiered SaaS Model**

---

## **üìä BUSINESS MODEL OVERVIEW**

### **Pricing Tiers & Feature Matrix**

| **Tier** | **Price Level** | **Card Limit** | **Core Features** | **Advanced Features** |
|----------|-----------------|----------------|-------------------|-----------------------|
| **Free Tier** | Level 1 | 500 cards | Basic lifecycle, Simple UI | None |
| **Pro Tier** | Level 1 | Unlimited | Basic lifecycle, Advanced UI | Basic exports |
| **Enterprise Tier** | Level 2 | Unlimited | All basic features | Bulk ops, Real-time, API access |

---

## **üèóÔ∏è ARCHITECTURAL BLUEPRINT**

### **Database Architecture**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              LANDLORD DATABASE                   ‚îÇ
‚îÇ  (Control Plane - Service Provider)             ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  ‚Ä¢ tenants                                     ‚îÇ
‚îÇ  ‚Ä¢ tenant_modules                              ‚îÇ
‚îÇ  ‚Ä¢ subscription_history                         ‚îÇ
‚îÇ  ‚Ä¢ usage_audit_logs                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚îÇ
                          ‚îÇ API Calls + Cache
                          ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ               TENANT DATABASE                   ‚îÇ
‚îÇ  (Data Plane - Isolated per Tenant)            ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  ‚Ä¢ digital_cards                               ‚îÇ
‚îÇ  ‚Ä¢ digital_card_events                         ‚îÇ
‚îÇ  ‚Ä¢ tenant_features (cached)                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## **üìã IMPLEMENTATION PHASES**

### **PHASE 0: Foundation (COMPLETED)**
‚úÖ Multi-tenancy with database isolation  
‚úÖ Basic card issuance with validation  
‚úÖ TDD workflow established  

### **PHASE 1-01: Core Lifecycle (Level 1 - Free/Pro Tier)**
#### **Technical Implementation:**
1. **Card Lifecycle Operations**
   - ‚úÖ Issue card
   - ‚úÖ Activate card  
   - ‚úÖ Revoke card
   - View card details
   - List cards with basic filters

2. **Business Rules for Level 1**
   - One active card per member
   - Basic expiry validation (1-2 years)
   - Simple authorization (admin vs non-admin)

3. **UI Components**
   - Basic card management interface
   - Simple card details view
   - Basic filtering and search

### **PHASE 1-02: Advanced Features (Level 2 - Enterprise Tier)**
#### **Technical Implementation:**
1. **Bulk Operations Module**
   - Bulk card issuance (CSV upload)
   - Bulk revocation
   - Queue-based processing
   - Progress tracking

2. **Advanced Export Module**
   - CSV/Excel exports
   - PDF card generation
   - Custom report builder
   - Scheduled exports

3. **Real-time Module**
   - WebSocket integration
   - Live card status updates
   - Desktop notifications
   - Activity feed

4. **API Access Module**
   - REST API endpoints
   - API key management
   - Rate limiting
   - Webhook support

---

## **üîß CORE BUSINESS LOGIC IMPLEMENTATION**

### **Step 1: Landlord Database Schema**

```php
// Migration: create_tenant_subscriptions_table.php
Schema::connection('landlord')->create('tenant_subscriptions', function (Blueprint $table) {
    $table->id();
    $table->uuid('tenant_id')->unique();
    $table->string('plan_name'); // 'free', 'pro', 'enterprise'
    $table->integer('price_level'); // 1 or 2
    $table->json('features'); // Enabled features JSON
    $table->integer('card_limit'); // 500 for free, 0 for unlimited
    $table->integer('current_usage')->default(0);
    $table->date('trial_ends_at')->nullable();
    $table->date('billing_cycle_ends_at')->nullable();
    $table->boolean('is_active')->default(true);
    $table->timestamps();
});

// Migration: create_feature_flags_table.php
Schema::connection('landlord')->create('feature_flags', function (Blueprint $table) {
    $table->id();
    $table->string('module'); // 'digital_card'
    $table->string('feature_key'); // 'bulk_operations', 'exports', 'realtime'
    $table->string('feature_name');
    $table->integer('min_price_level'); // 1 or 2
    $table->json('metadata')->nullable();
    $table->timestamps();
});
```

### **Step 2: Feature Management Service**

```php
namespace App\Services\Subscription;

class FeatureManager
{
    private array $cachedFeatures = [];
    
    public function __construct(
        private Cache $cache,
        private Connection $landlordConnection
    ) {}
    
    /**
     * Check if tenant has access to a specific feature
     */
    public function hasFeature(string $featureKey, Tenant $tenant): bool
    {
        $cacheKey = "tenant:{$tenant->id}:features";
        
        $features = $this->cache->remember($cacheKey, 3600, function () use ($tenant) {
            return $this->fetchTenantFeaturesFromLandlord($tenant);
        });
        
        return in_array($featureKey, $features);
    }
    
    /**
     * Check if tenant can issue more cards based on quota
     */
    public function canIssueCard(Tenant $tenant): bool
    {
        $subscription = $this->getTenantSubscription($tenant);
        
        // Enterprise tier has no limits
        if ($subscription->price_level === 2) {
            return true;
        }
        
        // Free tier: check 500 card limit
        if ($subscription->plan_name === 'free') {
            return $subscription->current_usage < $subscription->card_limit;
        }
        
        // Pro tier: unlimited
        return true;
    }
    
    /**
     * Increment card usage counter
     */
    public function incrementUsage(Tenant $tenant): void
    {
        $this->landlordConnection->table('tenant_subscriptions')
            ->where('tenant_id', $tenant->id)
            ->increment('current_usage');
            
        $this->clearTenantCache($tenant);
    }
    
    /**
     * Get tenant's enabled features
     */
    public function getEnabledFeatures(Tenant $tenant): array
    {
        $subscription = $this->getTenantSubscription($tenant);
        
        $features = $this->landlordConnection->table('feature_flags')
            ->where('module', 'digital_card')
            ->where('min_price_level', '<=', $subscription->price_level)
            ->pluck('feature_key')
            ->toArray();
            
        // Add any custom features from subscription metadata
        $customFeatures = $subscription->features ?? [];
        
        return array_merge($features, $customFeatures);
    }
}
```

### **Step 3: Feature Gate Middleware**

```php
namespace App\Http\Middleware;

class FeatureGate
{
    public function __construct(
        private FeatureManager $featureManager
    ) {}
    
    public function handle(Request $request, Closure $next, string $feature)
    {
        $tenant = tenancy()->getCurrentTenant();
        
        if (!$this->featureManager->hasFeature($feature, $tenant)) {
            if ($request->expectsJson()) {
                return response()->json([
                    'error' => 'Feature not available',
                    'message' => "The '{$feature}' feature requires an upgrade to a higher plan.",
                    'upgrade_url' => route('billing.upgrade')
                ], 402);
            }
            
            return redirect()->route('billing.upgrade')
                ->with('error', "Upgrade required to access {$feature}");
        }
        
        return $next($request);
    }
}
```

### **Step 4: Quota Enforcement Middleware**

```php
namespace App\Http\Middleware;

class QuotaEnforcement
{
    public function __construct(
        private FeatureManager $featureManager
    ) {}
    
    public function handle(Request $request, Closure $next)
    {
        // Only check on card creation endpoints
        if ($request->routeIs('cards.store') || $request->routeIs('cards.bulk.store')) {
            $tenant = tenancy()->getCurrentTenant();
            
            if (!$this->featureManager->canIssueCard($tenant)) {
                return response()->json([
                    'error' => 'Quota exceeded',
                    'message' => 'You have reached your card limit. Please upgrade your plan.',
                    'current_usage' => $this->featureManager->getCurrentUsage($tenant),
                    'card_limit' => $this->featureManager->getCardLimit($tenant)
                ], 402);
            }
        }
        
        return $next($request);
    }
}
```

### **Step 5: Route Configuration with Feature Gates**

```php
// routes/tenant.php

// Level 1 Features (Available to all tiers)
Route::middleware(['tenant', 'auth'])->group(function () {
    // Basic card operations
    Route::apiResource('cards', CardController::class)->only([
        'index', 'store', 'show', 'update'
    ]);
    
    // Basic lifecycle
    Route::put('/cards/{card}/activate', [CardController::class, 'activate']);
    Route::put('/cards/{card}/revoke', [CardController::class, 'revoke']);
});

// Level 2 Features (Enterprise only)
Route::middleware(['tenant', 'auth', 'feature:bulk_operations'])->group(function () {
    Route::prefix('bulk')->group(function () {
        Route::post('/issue', [BulkCardController::class, 'issue']);
        Route::post('/revoke', [BulkCardController::class, 'revoke']);
        Route::get('/operations', [BulkCardController::class, 'index']);
        Route::get('/operations/{operation}', [BulkCardController::class, 'show']);
    });
});

Route::middleware(['tenant', 'auth', 'feature:exports'])->group(function () {
    Route::prefix('exports')->group(function () {
        Route::get('/cards', [ExportController::class, 'cards']);
        Route::get('/usage', [ExportController::class, 'usage']);
        Route::post('/schedule', [ExportController::class, 'schedule']);
    });
});

Route::middleware(['tenant', 'auth', 'feature:realtime_updates'])->group(function () {
    Route::get('/websocket/auth', [WebSocketController::class, 'auth']);
});
```

### **Step 6: Frontend Feature Injection**

```vue
<!-- resources/js/Composables/useFeatures.js -->
import { computed } from 'vue'
import { usePage } from '@inertiajs/vue3'

export function useFeatures() {
    const page = usePage()
    
    const features = computed(() => page.props.features || [])
    const subscription = computed(() => page.props.subscription || {})
    
    const hasFeature = (featureKey) => {
        return features.value.includes(featureKey)
    }
    
    const canIssueCard = computed(() => {
        if (subscription.value.price_level === 2) return true
        if (subscription.value.plan_name === 'pro') return true
        return subscription.value.current_usage < subscription.value.card_limit
    })
    
    const usagePercentage = computed(() => {
        if (!subscription.value.card_limit) return 0
        return Math.round((subscription.value.current_usage / subscription.value.card_limit) * 100)
    })
    
    return {
        features,
        subscription,
        hasFeature,
        canIssueCard,
        usagePercentage
    }
}
```

### **Step 7: UI Component with Feature Gates**

```vue
<template>
  <div class="space-y-6">
    <!-- Quota Warning Banner -->
    <div v-if="subscription.plan_name === 'free' && usagePercentage > 80" 
         class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <ExclamationTriangleIcon class="h-5 w-5 text-yellow-400" />
        </div>
        <div class="ml-3">
          <p class="text-sm text-yellow-700">
            You've used {{ subscription.current_usage }} of {{ subscription.card_limit }} cards 
            ({{ usagePercentage }}%). 
            <a href="#" class="font-medium underline text-yellow-700 hover:text-yellow-600">
              Upgrade to Pro
            </a>
            for unlimited cards.
          </p>
        </div>
      </div>
    </div>
    
    <!-- Main Actions -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- Issue Card Button (Always visible) -->
      <PrimaryButton @click="issueCard" :disabled="!canIssueCard">
        Issue New Card
      </PrimaryButton>
      
      <!-- Bulk Issue Button (Feature-gated) -->
      <template v-if="hasFeature('bulk_operations')">
        <SecondaryButton @click="openBulkModal">
          Bulk Issue Cards
        </SecondaryButton>
      </template>
      <template v-else>
        <UpgradeButton @click="showUpgradeModal('bulk_operations')">
          <LockClosedIcon class="w-4 h-4 mr-2" />
          Bulk Operations (Pro)
        </UpgradeButton>
      </template>
      
      <!-- Export Button (Feature-gated) -->
      <template v-if="hasFeature('exports')">
        <SecondaryButton @click="exportCards">
          Export Cards
        </SecondaryButton>
      </template>
      <template v-else>
        <UpgradeButton @click="showUpgradeModal('exports')">
          <LockClosedIcon class="w-4 h-4 mr-2" />
          Export Data (Pro)
        </UpgradeButton>
      </template>
    </div>
  </div>
</template>

<script setup>
import { computed } from 'vue'
import { useFeatures } from '@/Composables/useFeatures'
import PrimaryButton from '@/Components/PrimaryButton.vue'
import SecondaryButton from '@/Components/SecondaryButton.vue'
import UpgradeButton from '@/Components/UpgradeButton.vue'
import { ExclamationTriangleIcon, LockClosedIcon } from '@heroicons/vue/24/outline'

const { hasFeature, subscription, canIssueCard, usagePercentage } = useFeatures()

const showUpgradeModal = (feature) => {
  // Show upgrade modal with feature highlights
  emit('upgrade-required', feature)
}
</script>
```

### **Step 8: Usage Audit Job**

```php
namespace App\Jobs;

use Illuminate\Bus\Queueable;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Foundation\Bus\Dispatchable;
use Illuminate\Queue\InteractsWithQueue;
use Illuminate\Queue\SerializesModels;
use Illuminate\Support\Facades\DB;
use App\Models\Tenant;

class AuditTenantUsageJob implements ShouldQueue
{
    use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;

    public function handle(): void
    {
        Tenant::chunk(100, function ($tenants) {
            foreach ($tenants as $tenant) {
                try {
                    tenancy()->initialize($tenant);
                    
                    // Count cards in tenant's database
                    $cardCount = DB::table('digital_cards')->count();
                    
                    // Update landlord database
                    DB::connection('landlord')
                        ->table('tenant_subscriptions')
                        ->where('tenant_id', $tenant->id)
                        ->update([
                            'current_usage' => $cardCount,
                            'last_audited_at' => now(),
                        ]);
                    
                    // Log the audit
                    $this->logAudit($tenant, $cardCount);
                    
                    tenancy()->end();
                } catch (\Exception $e) {
                    \Log::error("Audit failed for tenant {$tenant->id}: {$e->getMessage()}");
                }
            }
        });
    }
    
    private function logAudit(Tenant $tenant, int $cardCount): void
    {
        DB::connection('landlord')->table('usage_audit_logs')->insert([
            'tenant_id' => $tenant->id,
            'module' => 'digital_card',
            'recorded_usage' => $cardCount,
            'audited_at' => now(),
        ]);
    }
}
```

### **Step 9: Upgrade/Downgrade Workflow**

```php
namespace App\Services\Subscription;

class SubscriptionManager
{
    public function upgradeTenant(Tenant $tenant, string $newPlan, array $features = []): void
    {
        DB::connection('landlord')->transaction(function () use ($tenant, $newPlan, $features) {
            // Get current subscription
            $current = $this->getTenantSubscription($tenant);
            
            // Create subscription history record
            DB::connection('landlord')->table('subscription_history')->insert([
                'tenant_id' => $tenant->id,
                'from_plan' => $current->plan_name,
                'to_plan' => $newPlan,
                'changed_at' => now(),
                'reason' => 'upgrade',
            ]);
            
            // Update subscription
            DB::connection('landlord')
                ->table('tenant_subscriptions')
                ->where('tenant_id', $tenant->id)
                ->update([
                    'plan_name' => $newPlan,
                    'price_level' => $this->getPriceLevelForPlan($newPlan),
                    'features' => json_encode($features),
                    'card_limit' => $this->getCardLimitForPlan($newPlan),
                    'upgraded_at' => now(),
                ]);
            
            // Clear cache
            $this->featureManager->clearTenantCache($tenant);
            
            // Send notification
            $this->sendUpgradeNotification($tenant, $newPlan);
            
            // Trigger webhook if configured
            $this->triggerWebhook($tenant, 'subscription.upgraded', [
                'old_plan' => $current->plan_name,
                'new_plan' => $newPlan,
            ]);
        });
    }
    
    public function checkAndEnforceLimits(Tenant $tenant): void
    {
        $subscription = $this->getTenantSubscription($tenant);
        
        // Free tier enforcement
        if ($subscription->plan_name === 'free' && 
            $subscription->current_usage >= $subscription->card_limit) {
            
            // Block new card issuance
            $this->blockCardIssuance($tenant);
            
            // Send warning email
            $this->sendLimitWarning($tenant);
            
            // Log enforcement action
            \Log::warning("Tenant {$tenant->id} reached free tier limit");
        }
    }
}
```

---

## **üìà IMPLEMENTATION ROADMAP**

### **Week 1-2: Foundation Setup**
1. **Landlord Database Schema**
   - Create tenant_subscriptions table
   - Create feature_flags table
   - Create usage_audit_logs table

2. **Feature Management Service**
   - Implement FeatureManager
   - Add caching layer
   - Create migration/seeding for default features

3. **Middleware Implementation**
   - FeatureGate middleware
   - QuotaEnforcement middleware

### **Week 3-4: Backend Integration**
1. **Route Configuration**
   - Implement feature-gated routes
   - Add quota checks to existing endpoints
   - Create upgrade/downgrade endpoints

2. **Audit System**
   - Implement AuditTenantUsageJob
   - Schedule daily audits
   - Create usage reporting

### **Week 5-6: Frontend Integration**
1. **Feature Injection**
   - Add features to Inertia shared data
   - Create useFeatures composable
   - Implement feature-aware components

2. **UI Components**
   - Create UpgradeButton component
   - Implement quota display
   - Add feature upgrade modals

3. **User Experience**
   - Implement graceful degradation
   - Add upgrade CTAs
   - Create billing/upgrade pages

### **Week 7-8: Testing & Deployment**
1. **Testing**
   - Unit tests for FeatureManager
   - Integration tests for middleware
   - E2E tests for upgrade flow

2. **Deployment**
   - Database migrations
   - Feature flag seeding
   - Monitoring setup

---

## **üîê SECURITY CONSIDERATIONS**

### **Tenant Isolation**
- Feature checks must respect tenant boundaries
- No cross-tenant feature sharing
- Audit logs for all feature changes

### **API Security**
- Rate limiting per tenant
- API key authentication for external access
- Webhook signature verification

### **Data Protection**
- Encrypt sensitive subscription data
- Secure webhook endpoints
- Regular security audits

---

## **üìä MONITORING & ANALYTICS**

### **Key Metrics to Track**
1. **Usage Metrics**
   - Cards issued per tenant
   - Feature adoption rates
   - Upgrade conversion rates

2. **Business Metrics**
   - Monthly recurring revenue (MRR)
   - Customer lifetime value (LTV)
   - Churn rate

3. **System Metrics**
   - Feature check latency
   - Cache hit rates
   - Audit job performance

### **Dashboard Components**
- Tenant usage dashboard
- Feature adoption heatmap
- Revenue analytics
- Quota utilization reports

---

## **üöÄ DEPLOYMENT CHECKLIST**

### **Pre-Deployment**
- [ ] Database migrations tested
- [ ] Feature flags configured
- [ ] Default plans created
- [ ] Audit job scheduled
- [ ] Cache configuration verified

### **Post-Deployment**
- [ ] Monitor feature gate performance
- [ ] Verify quota enforcement
- [ ] Test upgrade/downgrade flows
- [ ] Validate audit reports
- [ ] Check cache invalidation

---

## **üìù SUCCESS CRITERIA**

### **Technical Success**
- [ ] Feature checks < 50ms P95
- [ ] Cache hit rate > 95%
- [ ] Zero cross-tenant feature leaks
- [ ] 100% audit accuracy

### **Business Success**
- [ ] Clear upgrade path for users
- [ ] > 20% free-to-paid conversion
- [ ] < 5% churn for paid tiers
- [ ] Positive user feedback on tiering

---

## **üîÆ FUTURE ENHANCEMENTS**

### **Phase 2: Advanced Monetization**
1. **Usage-Based Pricing**
   - Per-card pricing tiers
   - Overage charges
   - Volume discounts

2. **Custom Plans**
   - Mix-and-match features
   - Custom pricing
   - Enterprise agreements

3. **Marketplace Ecosystem**
   - Third-party integrations
   - Plugin system
   - API marketplace

### **Phase 3: Enterprise Features**
1. **Advanced Security**
   - SSO integration
   - Audit trails
   - Compliance reporting

2. **Advanced Analytics**
   - Predictive analytics
   - Usage forecasting
   - ROI calculators

3. **White Labeling**
   - Custom branding
   - Private labeling
   - Reseller program

---

This implementation plan provides a comprehensive, structured approach to implementing tiered business modules for your Digital Card service. The architecture ensures:

1. **Clean separation** between business logic and feature delivery
2. **Scalable** tier management through feature flags
3. **Performant** with intelligent caching
4. **Secure** with proper tenant isolation
5. **Monitorable** with comprehensive audit trails

The plan allows you to:
- Start with simple tiering (Free/Pro/Enterprise)
- Easily add new features and price points
- Monitor usage and business metrics effectively
- Provide clear upgrade paths to users
- Scale the monetization model as your business grows