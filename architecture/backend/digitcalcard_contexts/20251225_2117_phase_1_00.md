# **DIGITALCARD CONTEXT - PHASE 1: CORE LIFECYCLE MLP**
**Detailed Implementation Plan for Senior Fullstack Developer & Solution Architect**

## **üìã PHASE 1 OVERVIEW: BUSINESS VALUE DELIVERY**

**Duration**: Weeks 3-4 (Post Phase 0 Completion)
**Primary User**: Platform Admin (Vue Desktop)
**Secondary User**: Committee Members (Desktop)
**Goal**: Deliver fully functional digital card management for administration with complete business logic and frontend integration.

---

## **üõ†Ô∏è TECHNICAL STACK CONFIRMATION**

| Layer | Technology | Justification |
|-------|------------|---------------|
| **Backend** | Laravel 12 + PHP 8.3+ | Core platform requirement |
| **Frontend (Admin)** | Vue 3 + Inertia.js | Existing desktop stack |
| **Testing** | PestPHP | TDD compliance, better DX |
| **Database** | PostgreSQL (Tenant DB) | Multi-tenancy compliance |
| **Authentication** | Laravel Session (web) | Desktop admin authentication |
| **Styling** | Tailwind CSS + Existing Admin UI | Consistency |

---

## **üìä PHASE 1 DELIVERABLES MATRIX**

| Component | Backend | Frontend (Vue) | Tests | Priority |
|-----------|---------|----------------|-------|----------|
| **Card Issuance** | Complete | Create UI | Pest Feature | P0 |
| **Card Listing** | Complete | DataTable | Pest Feature | P0 |
| **Card Activation** | Complete | Action Button | Pest Unit | P1 |
| **Card Revocation** | Complete | Action Modal | Pest Unit | P1 |
| **Card Details View** | Complete | Modal/Page | Pest Feature | P1 |
| **Business Rule Enforcement** | Complete | Validation Feedback | Pest Unit | P0 |
| **QR Code Display** | Complete | Component | Pest Integration | P2 |

---

## **üîß BACKEND IMPLEMENTATION DETAILS**

### **Week 3, Days 1-2: Complete Domain Model & Business Rules**

```php
// 1. ENHANCE DIGITALCARD AGGREGATE WITH COMPLETE BUSINESS LOGIC
<?php
// app/Contexts/DigitalCard/Domain/Services/CardIssuancePolicy.php

declare(strict_types=1);

namespace App\Contexts\DigitalCard\Domain\Services;

use App\Contexts\DigitalCard\Domain\Repositories\DigitalCardRepository;
use App\Contexts\DigitalCard\Domain\ValueObjects\MemberId;

final class CardIssuancePolicy
{
    public function __construct(
        private DigitalCardRepository $repository
    ) {}
    
    /**
     * CORE BUSINESS RULE: One active card per member
     * This is a DOMAIN SERVICE because it needs repository access
     */
    public function assertSingleActiveCardPerMember(MemberId $memberId): void
    {
        $existingCards = $this->repository->byMember($memberId);
        
        $activeCards = array_filter($existingCards, fn($card) => 
            $card->status()->isValid() // Using our enum method
        );
        
        if (count($activeCards) > 0) {
            throw new \DomainException(
                'Member already has an active digital card. ' .
                'Revoke the existing card before issuing a new one.'
            );
        }
    }
    
    /**
     * Calculate default expiry (business rule)
     */
    public function calculateDefaultExpiry(\DateTimeImmutable $issuedAt): \DateTimeImmutable
    {
        // Business rule: Cards expire 1 year from issue by default
        return $issuedAt->modify('+1 year');
    }
    
    /**
     * Validate custom expiry date
     */
    public function validateExpiryDate(
        \DateTimeImmutable $issuedAt, 
        \DateTimeImmutable $expiresAt
    ): void {
        // Minimum validity period: 1 day
        $minExpiry = $issuedAt->modify('+1 day');
        if ($expiresAt < $minExpiry) {
            throw new \DomainException('Card must be valid for at least 1 day');
        }
        
        // Maximum validity period: 2 years
        $maxExpiry = $issuedAt->modify('+2 years');
        if ($expiresAt > $maxExpiry) {
            throw new \DomainException('Card cannot be valid for more than 2 years');
        }
    }
}
```

```php
// 2. COMPLETE APPLICATION LAYER HANDLERS
<?php
// app/Contexts/DigitalCard/Application/Handlers/IssueCardHandler.php

declare(strict_types=1);

namespace App\Contexts\DigitalCard\Application\Handlers;

use App\Contexts\DigitalCard\Application\Commands\IssueCardCommand;
use App\Contexts\DigitalCard\Application\DTOs\CardDTO;
use App\Contexts\DigitalCard\Domain\Services\CardIssuancePolicy;
use App\Contexts\DigitalCard\Domain\Services\CardValidationService;
use App\Contexts\DigitalCard\Infrastructure\Services\SecureQRCodeGenerator;
// ... other imports

final class IssueCardHandler
{
    public function __construct(
        private DigitalCardRepository $repository,
        private CardIssuancePolicy $issuancePolicy,
        private SecureQRCodeGenerator $qrGenerator,
        private ClockInterface $clock,
        private EventDispatcherInterface $dispatcher
    ) {}
    
    public function handle(IssueCardCommand $command): CardDTO
    {
        // 1. Validate member exists (Anti-Corruption Layer)
        $memberId = MemberId::fromString($command->memberId);
        $this->validateMemberExists($memberId);
        
        // 2. Enforce business rules
        $this->issuancePolicy->assertSingleActiveCardPerMember($memberId);
        
        // 3. Calculate dates
        $issuedAt = new \DateTimeImmutable($this->clock->now());
        $expiresAt = $command->expiresAt 
            ? new \DateTimeImmutable($command->expiresAt)
            : $this->issuancePolicy->calculateDefaultExpiry($issuedAt);
            
        $this->issuancePolicy->validateExpiryDate($issuedAt, $expiresAt);
        
        // 4. Create aggregate
        $cardId = CardId::generate();
        $qrCode = $this->qrGenerator->generateForCard($cardId, $memberId);
        
        $card = DigitalCard::issue(
            cardId: $cardId,
            memberId: $memberId,
            qrCode: QRCode::fromString($qrCode),
            issuedAt: $issuedAt,
            expiresAt: $expiresAt
        );
        
        // 5. Persist
        $this->repository->save($card);
        
        // 6. Dispatch events
        foreach ($card->releaseEvents() as $event) {
            $this->dispatcher->dispatch($event);
        }
        
        // 7. Return DTO
        return new CardDTO(
            cardId: $card->id()->toString(),
            memberId: $card->memberId()->toString(),
            status: $card->status()->value,
            issuedAt: $card->issuedAt()->format(\DateTimeInterface::ATOM),
            expiresAt: $card->expiresAt()->format(\DateTimeInterface::ATOM),
            qrCode: $card->qrCode()->toString(),
            activatedAt: $card->activatedAt()?->format(\DateTimeInterface::ATOM),
            revokedAt: $card->revokedAt()?->format(\DateTimeInterface::ATOM)
        );
    }
    
    /**
     * ANTI-CORRUPTION LAYER: Validate member exists without hard dependency
     */
    private function validateMemberExists(MemberId $memberId): void
    {
        // Option A: Eventual consistency (preferred)
        // We assume validation happened upstream
        
        // Option B: Synchronous check via dedicated client
        // $exists = $this->membershipClient->memberExists($memberId);
        // if (!$exists) { throw new MemberNotFoundException(); }
        
        // For Phase 1: Log and rely on foreign key constraint
        \Log::debug('Issuing card for member', ['member_id' => $memberId->toString()]);
    }
}
```

### **Week 3, Days 3-4: Complete CRUD Operations & API**

```php
// 3. COMPLETE REST API (CASE 4: /{tenant}/api/v1/cards/*)
<?php
// routes/tenant/api.digitalcard.php

declare(strict_types=1);

use App\Contexts\DigitalCard\Infrastructure\Http\Controllers\DigitalCardController;
use Illuminate\Support\Facades\Route;

Route::prefix('{tenant}/api/v1/cards')
    ->middleware([
        'tenant.resolve',  // Your tenant middleware
        'auth',            // Web session auth for desktop
        'verified',        // If using email verification
        'can:manage-digital-cards', // Policy-based authorization
    ])
    ->group(function () {
        
        // CRUD Operations
        Route::get('/', [DigitalCardController::class, 'index']);      // List cards
        Route::post('/', [DigitalCardController::class, 'store']);     // Issue card
        Route::get('/{card}', [DigitalCardController::class, 'show']); // Card details
        Route::put('/{card}/activate', [DigitalCardController::class, 'activate']);
        Route::put('/{card}/revoke', [DigitalCardController::class, 'revoke']);
        
        // Bulk operations
        Route::post('/bulk-issue', [DigitalCardController::class, 'bulkIssue']);
        Route::post('/bulk-revoke', [DigitalCardController::class, 'bulkRevoke']);
        
        // Reports
        Route::get('/export', [DigitalCardController::class, 'export']);
        Route::get('/stats', [DigitalCardController::class, 'stats']);
    });

// 4. POLICY FOR AUTHORIZATION
<?php
// app/Policies/DigitalCardPolicy.php

declare(strict_types=1);

namespace App\Policies;

use App\Models\User;
use App\Contexts\DigitalCard\Domain\Entities\DigitalCard;

class DigitalCardPolicy
{
    public function viewAny(User $user): bool
    {
        // Tenant committee admins can view cards
        return $user->hasPermissionTo('view-digital-cards') 
            && $user->tenant_id === app('currentTenant')->id;
    }
    
    public function issue(User $user): bool
    {
        // Only specific roles can issue cards
        return $user->hasRole(['committee_admin', 'platform_admin'])
            && $user->tenant_id === app('currentTenant')->id;
    }
    
    public function revoke(User $user, DigitalCard $card): bool
    {
        // Can revoke if you issued it OR are platform admin
        return $user->id === $card->issued_by 
            || $user->hasRole('platform_admin');
    }
}
```

### **Week 3, Days 5: Enhanced Repository & Query Optimization**

```php
// 5. ENHANCED REPOSITORY WITH QUERY OPTIMIZATION
<?php
// app/Contexts/DigitalCard/Infrastructure/Persistence/EloquentDigitalCardRepository.php

declare(strict_types=1);

namespace App\Contexts\DigitalCard\Infrastructure\Persistence;

// ... imports

final class EloquentDigitalCardRepository implements DigitalCardRepository
{
    public function findByMemberWithStatus(
        MemberId $memberId, 
        CardStatus $status
    ): array {
        // Optimized query with specific status
        return EloquentDigitalCard::query()
            ->where('member_id', $memberId->toString())
            ->where('status', $status->value)
            ->orderBy('issued_at', 'desc')
            ->get()
            ->map(fn($model) => $this->toAggregate($model))
            ->all();
    }
    
    public function paginateForTenant(
        int $perPage = 20,
        array $filters = []
    ): LengthAwarePaginator {
        $query = EloquentDigitalCard::query();
        
        // Apply filters
        if ($memberId = $filters['member_id'] ?? null) {
            $query->where('member_id', $memberId);
        }
        
        if ($status = $filters['status'] ?? null) {
            $query->where('status', $status);
        }
        
        if ($dateFrom = $filters['issued_from'] ?? null) {
            $query->where('issued_at', '>=', $dateFrom);
        }
        
        // Always scope to current tenant (safety check)
        $this->ensureTenantScope($query);
        
        return $query->paginate($perPage)
            ->through(fn($model) => $this->toDTO($model));
    }
    
    /**
     * SECURITY: Ensure all queries are tenant-scoped
     */
    private function ensureTenantScope(Builder $query): void
    {
        // This assumes your EloquentDigitalCard model has tenant scope
        // If not, you need tenant_id column and scope
        $query->where('tenant_id', app('currentTenant')->id);
    }
}
```

---

## **üé® FRONTEND IMPLEMENTATION (VUE 3 + INERTIA)**

### **Week 4, Days 1-2: Card Management Interface**

```vue
<!-- 1. MAIN CARD MANAGEMENT COMPONENT -->
<!-- resources/js/Pages/Tenant/DigitalCards/Index.vue -->

<template>
  <TenantLayout title="Digital Cards Management">
    <template #header>
      <div class="flex justify-between items-center">
        <h2 class="font-semibold text-xl text-gray-800 leading-tight">
          Digital Cards
        </h2>
        
        <PrimaryButton 
          @click="showIssueModal = true"
          v-if="$page.props.can.issue"
        >
          <PlusIcon class="w-4 h-4 mr-2" />
          Issue New Card
        </PrimaryButton>
      </div>
    </template>

    <div class="py-6">
      <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
        
        <!-- Filters -->
        <CardFilters 
          :filters="filters"
          @filter="applyFilters"
          @reset="resetFilters"
        />
        
        <!-- Stats Summary -->
        <CardStats :stats="stats" />
        
        <!-- Cards Table -->
        <div class="bg-white overflow-hidden shadow-sm sm:rounded-lg">
          <CardDataTable 
            :cards="cards.data"
            :meta="cards.meta"
            @sort="sortTable"
            @revoke="confirmRevoke"
            @activate="confirmActivate"
            @view="viewCardDetails"
          />
        </div>
        
        <!-- Pagination -->
        <Pagination :meta="cards.meta" />
      </div>
    </div>
    
    <!-- Modals -->
    <IssueCardModal 
      :show="showIssueModal"
      :members="eligibleMembers"
      @close="showIssueModal = false"
      @issued="handleCardIssued"
    />
    
    <CardDetailsModal 
      :show="!!selectedCard"
      :card="selectedCard"
      @close="selectedCard = null"
    />
    
    <ConfirmationModal 
      :show="showRevokeConfirmation"
      @confirm="executeRevoke"
      @cancel="showRevokeConfirmation = false"
    >
      Are you sure you want to revoke this card?
    </ConfirmationModal>
  </TenantLayout>
</template>

<script setup>
import { ref, computed, watch } from 'vue'
import { usePage, router } from '@inertiajs/vue3'
import TenantLayout from '@/Layouts/TenantLayout.vue'
import CardDataTable from './Components/CardDataTable.vue'
import CardFilters from './Components/CardFilters.vue'
import CardStats from './Components/CardStats.vue'
import IssueCardModal from './Components/IssueCardModal.vue'
import CardDetailsModal from './Components/CardDetailsModal.vue'
import ConfirmationModal from '@/Components/ConfirmationModal.vue'
import PrimaryButton from '@/Components/PrimaryButton.vue'
import Pagination from '@/Components/Pagination.vue'
import { PlusIcon } from '@heroicons/vue/outline'

// Props
const props = defineProps({
  cards: Object,
  filters: Object,
  stats: Object,
  eligibleMembers: Array
})

// State
const showIssueModal = ref(false)
const selectedCard = ref(null)
const showRevokeConfirmation = ref(false)
const cardToAction = ref(null)
const actionType = ref('')

// Methods
const applyFilters = (newFilters) => {
  router.get(route('tenant.digital-cards.index'), newFilters, {
    preserveState: true,
    preserveScroll: true
  })
}

const sortTable = (column, direction) => {
  router.get(route('tenant.digital-cards.index'), {
    ...props.filters,
    sort: column,
    direction
  }, {
    preserveState: true,
    preserveScroll: true
  })
}

const confirmRevoke = (card) => {
  cardToAction.value = card
  actionType.value = 'revoke'
  showRevokeConfirmation.value = true
}

const confirmActivate = (card) => {
  cardToAction.value = card
  actionType.value = 'activate'
  showRevokeConfirmation.value = true
}

const executeRevoke = () => {
  if (!cardToAction.value) return
  
  router.put(route('tenant.digital-cards.revoke', cardToAction.value.id), {}, {
    onSuccess: () => {
      showRevokeConfirmation.value = false
      cardToAction.value = null
      // Show success notification
    },
    onError: (errors) => {
      // Show error notification
    }
  })
}

const handleCardIssued = (newCard) => {
  showIssueModal.value = false
  // Refresh data or optimistically update
  router.reload({ only: ['cards', 'stats'] })
}

const viewCardDetails = (card) => {
  router.get(route('tenant.digital-cards.show', card.id), {}, {
    preserveState: true,
    preserveScroll: true,
    onSuccess: (page) => {
      selectedCard.value = page.props.card
    }
  })
}
</script>
```

```vue
<!-- 2. QR CODE DISPLAY COMPONENT -->
<!-- resources/js/Components/DigitalCard/QRCodeDisplay.vue -->

<template>
  <div class="relative">
    <!-- QR Code Canvas -->
    <div ref="qrContainer" class="bg-white p-4 rounded-lg border">
      <canvas ref="qrCanvas" class="mx-auto"></canvas>
    </div>
    
    <!-- Card Info Overlay -->
    <div class="mt-4 text-center space-y-2">
      <div class="text-sm text-gray-600">
        Card ID: {{ truncateId(cardId) }}
      </div>
      <div class="text-xs text-gray-500">
        Issued: {{ formatDate(issuedAt) }}
      </div>
      <Badge :type="statusBadgeType" class="inline-block">
        {{ statusLabel }}
      </Badge>
    </div>
    
    <!-- Actions -->
    <div v-if="showActions" class="mt-4 flex justify-center space-x-2">
      <SecondaryButton size="sm" @click="downloadQR">
        <DownloadIcon class="w-4 h-4 mr-1" />
        Download
      </SecondaryButton>
      <SecondaryButton size="sm" @click="refreshQR" v-if="canRefresh">
        <RefreshIcon class="w-4 h-4 mr-1" />
        Refresh
      </SecondaryButton>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, watch, computed } from 'vue'
import QRCode from 'qrcode'
import SecondaryButton from '@/Components/SecondaryButton.vue'
import Badge from '@/Components/Badge.vue'
import { DownloadIcon, RefreshIcon } from '@heroicons/vue/outline'

const props = defineProps({
  qrData: {
    type: String,
    required: true
  },
  cardId: {
    type: String,
    required: true
  },
  status: {
    type: String,
    default: 'issued'
  },
  issuedAt: {
    type: String,
    required: true
  },
  showActions: {
    type: Boolean,
    default: true
  },
  canRefresh: {
    type: Boolean,
    default: false
  }
})

const emit = defineEmits(['refresh', 'downloaded'])

const qrCanvas = ref(null)

// Computed
const statusLabel = computed(() => {
  const labels = {
    issued: 'Issued',
    active: 'Active',
    revoked: 'Revoked',
    expired: 'Expired'
  }
  return labels[props.status] || props.status
})

const statusBadgeType = computed(() => {
  const types = {
    issued: 'warning',
    active: 'success',
    revoked: 'danger',
    expired: 'gray'
  }
  return types[props.status] || 'gray'
})

// Methods
const generateQR = async () => {
  if (!qrCanvas.value) return
  
  try {
    await QRCode.toCanvas(qrCanvas.value, props.qrData, {
      width: 256,
      margin: 2,
      color: {
        dark: '#000000',
        light: '#FFFFFF'
      }
    })
  } catch (error) {
    console.error('QR generation failed:', error)
  }
}

const downloadQR = async () => {
  try {
    const dataUrl = await QRCode.toDataURL(props.qrData, {
      width: 512,
      margin: 2
    })
    
    const link = document.createElement('a')
    link.href = dataUrl
    link.download = `card-${props.cardId.slice(0, 8)}.png`
    link.click()
    
    emit('downloaded', props.cardId)
  } catch (error) {
    console.error('QR download failed:', error)
  }
}

const refreshQR = () => {
  emit('refresh', props.cardId)
}

const truncateId = (id) => {
  return id.length > 12 ? `${id.slice(0, 8)}...${id.slice(-4)}` : id
}

const formatDate = (dateString) => {
  return new Date(dateString).toLocaleDateString()
}

// Lifecycle
onMounted(() => {
  generateQR()
})

watch(() => props.qrData, () => {
  generateQR()
})
</script>
```

### **Week 4, Days 3-4: Advanced Components & Real-time Updates**

```vue
<!-- 3. REAL-TIME CARD STATUS UPDATES WITH WEBSOCKETS -->
<!-- resources/js/Composables/useDigitalCardUpdates.js -->

import { ref, onMounted, onUnmounted } from 'vue'
import Echo from 'laravel-echo'
import Pusher from 'pusher-js'

export function useDigitalCardUpdates(tenantId) {
  const updates = ref([])
  const isConnected = ref(false)
  
  const connect = () => {
    if (isConnected.value) return
    
    window.Pusher = Pusher
    
    const echo = new Echo({
      broadcaster: 'pusher',
      key: process.env.MIX_PUSHER_APP_KEY,
      cluster: process.env.MIX_PUSHER_APP_CLUSTER,
      wsHost: window.location.hostname,
      wsPort: 6001,
      forceTLS: false,
      enabledTransports: ['ws', 'wss'],
      authEndpoint: `/${tenantId}/api/v1/broadcasting/auth`,
      auth: {
        headers: {
          'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
        }
      }
    })
    
    // Listen for card events
    echo.private(`tenant.${tenantId}.digital-cards`)
      .listen('.CardIssued', (event) => {
        updates.value.push({
          type: 'issued',
          cardId: event.card.id,
          memberId: event.card.member_id,
          timestamp: new Date(),
          message: `New card issued for member ${event.card.member_name}`
        })
      })
      .listen('.CardActivated', (event) => {
        updates.value.push({
          type: 'activated',
          cardId: event.card.id,
          timestamp: new Date(),
          message: `Card ${event.card.id.slice(0, 8)} activated`
        })
      })
      .listen('.CardRevoked', (event) => {
        updates.value.push({
          type: 'revoked',
          cardId: event.card.id,
          reason: event.reason,
          timestamp: new Date(),
          message: `Card ${event.card.id.slice(0, 8)} revoked: ${event.reason}`
        })
      })
    
    isConnected.value = true
  }
  
  const disconnect = () => {
    if (window.Echo) {
      window.Echo.leave(`tenant.${tenantId}.digital-cards`)
    }
    isConnected.value = false
  }
  
  const clearUpdates = () => {
    updates.value = []
  }
  
  onMounted(() => {
    if (process.env.MIX_PUSHER_ENABLED === 'true') {
      connect()
    }
  })
  
  onUnmounted(() => {
    disconnect()
  })
  
  return {
    updates,
    isConnected,
    connect,
    disconnect,
    clearUpdates
  }
}
```

### **Week 4, Days 5: Mobile-Friendly Admin Interface**

```vue
<!-- 4. RESPONSIVE CARD MANAGEMENT -->
<!-- resources/js/Pages/Tenant/DigitalCards/Index.vue (Mobile enhancements) -->

<template>
  <!-- Mobile view -->
  <div class="lg:hidden">
    <div class="space-y-4">
      <div v-for="card in cards.data" :key="card.id" 
           class="bg-white rounded-lg border p-4">
        
        <!-- Mobile Card Item -->
        <div class="flex items-start justify-between">
          <div>
            <div class="font-medium text-gray-900">
              {{ truncateId(card.card_id) }}
            </div>
            <div class="text-sm text-gray-600 mt-1">
              Member: {{ card.member_name || truncateId(card.member_id) }}
            </div>
            <div class="flex items-center mt-2 space-x-2">
              <Badge :type="getStatusType(card.status)" size="sm">
                {{ card.status }}
              </Badge>
              <span class="text-xs text-gray-500">
                {{ formatDate(card.issued_at) }}
              </span>
            </div>
          </div>
          
          <!-- Mobile Actions Dropdown -->
          <Dropdown align="right" width="48">
            <template #trigger>
              <button class="text-gray-400 hover:text-gray-600">
                <DotsVerticalIcon class="w-5 h-5" />
              </button>
            </template>
            
            <template #content>
              <DropdownLink @click="viewCardDetails(card)">
                View Details
              </DropdownLink>
              <DropdownLink 
                v-if="card.status === 'issued' && $page.props.can.activate"
                @click="confirmActivate(card)"
              >
                Activate
              </DropdownLink>
              <DropdownLink 
                v-if="['issued', 'active'].includes(card.status) && $page.props.can.revoke"
                @click="confirmRevoke(card)"
                class="text-red-600"
              >
                Revoke
              </DropdownLink>
            </template>
          </Dropdown>
        </div>
        
        <!-- QR Preview (Mobile) -->
        <div class="mt-3 flex justify-center" v-if="card.status === 'active'">
          <div class="w-32 h-32 bg-gray-100 rounded flex items-center justify-center">
            <QrCodeIcon class="w-12 h-12 text-gray-400" />
            <span class="sr-only">QR Code Preview</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>
```

---

## **üß™ COMPREHENSIVE TESTING STRATEGY**

### **Test Structure for Phase 1**

```
tests/
‚îú‚îÄ‚îÄ Unit/
‚îÇ   ‚îî‚îÄ‚îÄ Contexts/
‚îÇ       ‚îî‚îÄ‚îÄ DigitalCard/
‚îÇ           ‚îú‚îÄ‚îÄ Domain/
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ DigitalCardTest.php          # Aggregate tests
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ CardIssuancePolicyTest.php   # Business rules
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ ValueObjects/                # VO validation
‚îÇ           ‚îî‚îÄ‚îÄ Application/
‚îÇ               ‚îî‚îÄ‚îÄ Handlers/IssueCardHandlerTest.php
‚îî‚îÄ‚îÄ Feature/
    ‚îî‚îÄ‚îÄ Contexts/
        ‚îî‚îÄ‚îÄ DigitalCard/
            ‚îú‚îÄ‚îÄ IssueCardTest.php               # API tests
            ‚îú‚îÄ‚îÄ ManageCardsTest.php             # CRUD operations
            ‚îú‚îÄ‚îÄ MobileCardAccessTest.php        # Mobile API (future)
            ‚îî‚îÄ‚îÄ TenantIsolationTest.php         # Multi-tenancy
```

### **Critical Test Cases for Phase 1**

```php
<?php
// tests/Feature/Contexts/DigitalCard/TenantIsolationTest.php

declare(strict_types=1);

// This test is CRITICAL for multi-tenant security

public function test_admin_cannot_access_other_tenant_cards(): void
{
    // Given two separate tenants
    $tenantA = Tenant::factory()->create(['slug' => 'tenant-a']);
    $tenantB = Tenant::factory()->create(['slug' => 'tenant-b']);
    
    $adminA = User::factory()->for($tenantA)->create();
    $adminB = User::factory()->for($tenantB)->create();
    
    // Create card in Tenant A
    $this->actingAs($adminA);
    $responseA = $this->postJson("/{$tenantA->slug}/api/v1/cards", [
        'member_id' => MemberId::generate()->toString(),
    ]);
    $cardId = $responseA->json('data.card_id');
    
    // Switch to Tenant B admin
    $this->actingAs($adminB);
    
    // Attempt all operations - ALL should fail
    $this->getJson("/{$tenantB->slug}/api/v1/cards/{$cardId}")
        ->assertNotFound();
    
    $this->putJson("/{$tenantB->slug}/api/v1/cards/{$cardId}/activate")
        ->assertNotFound();
    
    $this->putJson("/{$tenantB->slug}/api/v1/cards/{$cardId}/revoke")
        ->assertNotFound();
    
    // Verify Tenant B's database is empty
    $this->assertDatabaseCount('digital_cards', 0, 'tenant_b_connection');
}
```

---

## **üöÄ DEPLOYMENT & MONITORING PLAN**

### **Phase 1 Deployment Checklist**

```yaml
# deploy-phase1.yml
steps:
  - name: "Run Phase 1 Test Suite"
    command: "php artisan test --testsuite=phase1 --coverage-html=coverage"
    coverage_threshold: 90%
    
  - name: "Database Migrations (Tenant DBs)"
    command: "php artisan tenants:migrate --context=DigitalCard"
    
  - name: "Frontend Assets Build"
    command: "npm run build"
    
  - name: "Cache Configuration"
    command: |
      php artisan config:cache
      php artisan route:cache
      php artisan event:cache
    
  - name: "Queue Workers Restart"
    command: "php artisan queue:restart"
    
  - name: "Health Check"
    url: "/health"
    expected_status: 200
    
  - name: "Feature Flag Enable"
    command: "php artisan feature:enable digital-cards-admin"
```

### **Monitoring Metrics for Phase 1**

```php
<?php
// app/Contexts/DigitalCard/Infrastructure/Monitoring/CardMetrics.php

declare(strict_types=1);

class CardMetrics
{
    public static function recordCardIssued(MemberId $memberId): void
    {
        \Log::channel('metrics')->info('card.issued', [
            'member_id' => $memberId->toString(),
            'tenant_id' => app('currentTenant')->id,
            'timestamp' => now()->toISOString(),
        ]);
        
        // Increment Prometheus counter
        if (class_exists(\Prometheus\CollectorRegistry::class)) {
            app('prometheus')->inc('cards_issued_total', [
                'tenant' => app('currentTenant')->slug,
            ]);
        }
    }
    
    public static function recordApiLatency(string $endpoint, float $milliseconds): void
    {
        app('prometheus')->histogram('api_request_duration_seconds', $milliseconds / 1000, [
            'endpoint' => $endpoint,
            'context' => 'digitalcard',
        ]);
    }
    
    public static function getDashboardMetrics(): array
    {
        return [
            'cards_issued_today' => DigitalCard::whereDate('issued_at', today())->count(),
            'active_cards' => DigitalCard::where('status', 'active')->count(),
            'avg_card_lifetime' => DB::table('digital_cards')
                ->whereNotNull('revoked_at')
                ->selectRaw('AVG(EXTRACT(EPOCH FROM (revoked_at - issued_at))) as avg_seconds')
                ->value('avg_seconds'),
            'error_rate' => self::calculateErrorRate(),
        ];
    }
}
```

---

## **üîê SECURITY AUDIT POINTS FOR PHASE 1**

1. **Authorization**: All endpoints must have Policy checks
2. **Tenant Isolation**: Every query must be tenant-scoped
3. **Input Validation**: Request classes for all API endpoints
4. **QR Code Security**: Phase 1 uses simple UUID-based QR (Phase 3 will implement signatures)
5. **Audit Logging**: All state changes must be logged
6. **Rate Limiting**: API endpoints should have rate limits
7. **CSRF Protection**: Web forms must have CSRF tokens
8. **XSS Prevention**: Vue components must sanitize outputs

---

## **üìà SUCCESS CRITERIA FOR PHASE 1 COMPLETION**

| Criteria | Measurement | Target |
|----------|-------------|---------|
| **Test Coverage** | PestPHP coverage report | ‚â• 90% |
| **API Performance** | P95 response time | < 200ms |
| **Mobile Responsive** | Lighthouse score | ‚â• 90 |
| **Business Rules** | All invariants enforced | 100% |
| **Tenant Isolation** | Zero cross-tenant leaks | 0 incidents |
| **User Acceptance** | Admin usability testing | ‚â• 4/5 score |
| **Deployment Stability** | Zero downtime deployment | 100% uptime |

---

## **‚ö†Ô∏è RISK MITIGATION PLAN**

| Risk | Probability | Impact | Mitigation |
|------|-------------|---------|------------|
| **Business rule complexity** | Medium | High | Implement in Policy classes, extensive unit testing |
| **Mobile responsiveness issues** | Low | Medium | Mobile-first CSS, extensive browser testing |
| **Performance with many cards** | Low | High | Pagination, database indexing, query optimization |
| **QR code generation bottleneck** | Low | Medium | Queue-based generation, caching |
| **Tenant data leak** | Low | Critical | Automated tenant isolation tests, query scoping middleware |

---

## **üéØ NEXT STEPS AFTER PHASE 1**

Upon successful Phase 1 completion:

1. **Stakeholder Demo**: Show admin interface to product owners
2. **Performance Review**: Analyze metrics and optimize bottlenecks
3. **Phase 2 Planning**: Begin mobile app API design
4. **Documentation**: Update API docs and user guides
5. **Training**: Train committee admins on new interface

**Ready to begin Phase 1 implementation?** I can generate the specific test files or implementation code for any component you'd like to start with. Which area would you like to tackle first?