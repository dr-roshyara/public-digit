**CRITICAL ISSUE:** Tests are running on **WRONG DATABASE**!

**The Problem:**
- Tests are using `testing` database connection
- Trying to recreate ALL platform tables (`users`, `permissions`, `migrations`, etc.)
- This is **landlord database** behavior, not **tenant database**

**Evidence:**
```
Connection: testing, SQL: drop table "public"."cache", "public"."cache_locks"...
SQLSTATE[42P07]: Duplicate table: 7 FEHLER:  Relation »users« existiert bereits
```

## **Root Cause:**
Your `DigitalCardWalkingSkeletonTest` is **NOT** using tenant database context. It's running `RefreshDatabase` trait which tries to rebuild entire landlord schema.

## **Solution:**

**1. Update Test to Use Tenant Database:**

```php
final class DigitalCardWalkingSkeletonTest extends TestCase
{
    // ❌ REMOVE: use RefreshDatabase;
    
    protected Tenant $tenant;
    
    protected function setUp(): void
    {
        parent::setUp();
        
        // Create/get test tenant
        $this->tenant = Tenant::firstOrCreate(
            ['slug' => 'digitalcard-test'],
            [
                'name' => 'DigitalCard Test Tenant',
                'database_name' => 'tenant_digitalcard_test',
            ]
        );
        
        // Switch to tenant database connection
        config(['database.connections.tenant.database' => $this->tenant->database_name]);
        DB::purge('tenant');
        
        // Set tenant context
        app()->instance('currentTenant', $this->tenant);
        
        // Run ONLY DigitalCard migration on tenant database
        Artisan::call('migrate', [
            '--path' => 'app/Contexts/DigitalCard/Infrastructure/Database/Migrations',
            '--database' => 'tenant',
            '--force' => true,
        ]);
    }
    
    protected function tearDown(): void
    {
        // Clean up: drop DigitalCard table only
        Schema::connection('tenant')->dropIfExists('digital_cards');
        
        parent::tearDown();
    }
}
```

**2. Configure Test Database in `phpunit.xml`:**

```xml
<php>
    <env name="DB_CONNECTION" value="pgsql"/>
    <env name="DB_DATABASE" value="testing"/> <!-- Landlord test DB -->
    
    <!-- Tenant connection config -->
    <env name="TENANT_DB_CONNECTION" value="tenant"/>
    <env name="TENANT_DB_PREFIX" value="tenant_test_"/>
</php>
```

**3. Run Correct Test Command:**

```bash
# First ensure landlord test database exists
php artisan db:create testing

# Run tests with tenant context
cd packages/laravel-backend
php artisan test --filter=DigitalCardWalkingSkeletonTest
```

**Key Principle:** DigitalCard tests should **ONLY** touch tenant database, not rebuild entire landlord schema. Use `RefreshDatabase` only for landlord tests, not tenant context tests.
#########################
**PROGRESS!** The error changed - now it's about **tenant lookup failing**, not database dropping/creation.

**New Error:** `Relation »tenants« existiert nicht` (tenants table doesn't exist)

**This means:**
1. ✅ **Tenant database switching** is working (connection: `pgsql`, not `testing`)
2. ❌ **Landlord database schema** is missing (no `tenants` table)

**Solution:** Need to **seed landlord database** before tests.

## **Fix Test Setup:**

```php
protected function setUp(): void
{
    parent::setUp();
    
    // 1. Run landlord migrations (tenants table must exist)
    Artisan::call('migrate', ['--database' => 'pgsql', '--force' => true]);
    
    // 2. Create/get test tenant
    $this->tenant = Tenant::firstOrCreate(
        ['slug' => 'digitalcard-test'],
        [
            'name' => 'DigitalCard Test Tenant',
            'database_name' => 'tenant_digitalcard_test',
        ]
    );
    
    // 3. Configure tenant database connection
    config(['database.connections.tenant.database' => $this->tenant->database_name]);
    DB::purge('tenant');
    
    // 4. Create tenant database if doesn't exist
    try {
        DB::connection('tenant')->getPdo();
    } catch (\Exception $e) {
        // Create tenant database
        Artisan::call('tenants:create', ['--tenant' => $this->tenant->id]);
    }
    
    // 5. Run DigitalCard migration on tenant database
    Artisan::call('migrate', [
        '--path' => 'app/Contexts/DigitalCard/Infrastructure/Database/Migrations',
        '--database' => 'tenant',
        '--force' => true,
    ]);
    
    // 6. Set tenant context
    $this->tenant->makeCurrent();
}
```

## **Alternative: Use DatabaseTransactions instead:**

```php
use Illuminate\Foundation\Testing\DatabaseTransactions;

final class DigitalCardWalkingSkeletonTest extends TestCase
{
    use DatabaseTransactions; // Rolls back after test, doesn't rebuild schema
    
    protected function setUp(): void
    {
        parent::setUp();
        
        // Assumes landlord DB already has schema
        // Assumes tenant exists and has database
        $this->tenant = Tenant::where('slug', 'digitalcard-test')->firstOrFail();
        $this->tenant->makeCurrent();
    }
}
```

## **Quick Fix Now:**

```bash
# 1. Create landlord database with schema
cd packages/laravel-backend
php artisan migrate:fresh --database=pgsql --force

# 2. Create test tenant
php artisan tinker
>>> \App\Models\Tenant::create([
...     'slug' => 'digitalcard-test',
...     'name' => 'DigitalCard Test Tenant',
...     'database_name' => 'tenant_digitalcard_test',
... ]);

# 3. Create tenant database
php artisan tenants:create --tenant=digitalcard-test

# 4. Run DigitalCard migration on tenant
php artisan tenants:migrate --tenant=digitalcard-test

# 5. Now run tests
php artisan test --filter=DigitalCardWalkingSkeletonTest
```

**Which approach do you want?** Fix test setup or run commands first?
**Edit `DigitalCardWalkingSkeletonTest.php` setup:**

```php
protected function setUp(): void
{
    parent::setUp();
    
    // 1. Ensure landlord database has tenants table
    // Use DatabaseTransactions to avoid rebuilding schema
    // Add at class level: use Illuminate\Foundation\Testing\DatabaseTransactions;
    
    // 2. Create test tenant if doesn't exist
    $this->tenant = Tenant::firstOrCreate(
        ['slug' => 'digitalcard-test'],
        [
            'name' => 'DigitalCard Test Tenant',
            'database_name' => 'tenant_digitalcard_test',
            // Add other required fields from Tenant model
        ]
    );
    
    // 3. Check if tenant database exists, create if needed
    try {
        // Test connection to tenant database
        DB::connection('tenant')->getPdo();
    } catch (\Exception $e) {
        // Tenant database doesn't exist - this is expected
        // In Phase 0 tests, we'll skip rather than create DB
        $this->markTestSkipped(
            'Tenant database not found. Run: ' .
            'php artisan tenants:create --tenant=digitalcard-test'
        );
    }
    
    // 4. Run DigitalCard migration on tenant database
    Artisan::call('migrate', [
        '--path' => 'app/Contexts/DigitalCard/Infrastructure/Database/Migrations',
        '--database' => 'tenant',
        '--force' => true,
    ]);
    
    // 5. Set tenant context
    $this->tenant->makeCurrent();
}
```

**But better: Simplify for Phase 0:**

```php
use Illuminate\Foundation\Testing\DatabaseTransactions;

final class DigitalCardWalkingSkeletonTest extends TestCase
{
    use DatabaseTransactions; // IMPORTANT: Rolls back changes, doesn't rebuild
    
    protected Tenant $tenant;
    
    protected function setUp(): void
    {
        parent::setUp();
        
        // PREREQUISITE: Landlord DB must have tenants table
        // PREREQUISITE: Tenant 'digitalcard-test' must exist with database
        
        $this->tenant = Tenant::where('slug', 'digitalcard-test')->first();
        
        if (!$this->tenant) {
            $this->markTestSkipped(
                'Test tenant not found. Create with: ' .
                'php artisan tinker then: ' .
                'App\Models\Tenant::create([\'slug\' => \'digitalcard-test\', ...])'
            );
        }
        
        // Switch to tenant database
        config(['database.connections.tenant.database' => $this->tenant->database_name]);
        DB::purge('tenant');
        
        $this->tenant->makeCurrent();
    }
    
    protected function tearDown(): void
    {
        $this->tenant->forgetCurrent();
        parent::tearDown();
    }
}
```

**Key changes:**
1. **Add `use DatabaseTransactions`** - prevents landlord schema rebuild
2. **Skip if tenant missing** - with clear instructions
3. **Assume prerequisites** - landlord schema exists, tenant exists

**Make this edit now.**