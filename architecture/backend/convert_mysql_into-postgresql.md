# Converting MySQL Laravel Project to PostgreSQL: Step-by-Step Guide

## ðŸ“‹ Pre-Migration Checklist

### 1. **Backup Everything**
```bash
# Backup MySQL database
mysqldump -u [username] -p [database_name] > backup_mysql.sql

# Backup Laravel project files
tar -czf laravel_backup.tar.gz /path/to/your/project
```

### 2. **Install PostgreSQL**
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install postgresql postgresql-contrib
sudo systemctl start postgresql

# macOS (Homebrew)
brew install postgresql
brew services start postgresql

# Windows
# Download from https://www.postgresql.org/download/windows/
```

### 3. **Create PostgreSQL Database & User**
```bash
# Switch to postgres user
sudo -i -u postgres

# Create database and user
createuser --interactive --pwprompt
# Enter: your_database_user

createdb your_database_name

# Grant privileges
psql -c "GRANT ALL PRIVILEGES ON DATABASE your_database_name TO your_database_user;"
```

---

## ðŸ”§ Laravel Configuration Changes

### 1. **Update `.env` File**
```env
# Change from MySQL to PostgreSQL
DB_CONNECTION=pgsql
DB_HOST=127.0.0.1
DB_PORT=5432
DB_DATABASE=your_database_name
DB_USERNAME=your_database_user
DB_PASSWORD=your_database_password

# Remove MySQL-specific settings
# DB_SOCKET=
```

### 2. **Update `config/database.php`**
```php
// In config/database.php
'pgsql' => [
    'driver' => 'pgsql',
    'url' => env('DATABASE_URL'),
    'host' => env('DB_HOST', '127.0.0.1'),
    'port' => env('DB_PORT', '5432'),
    'database' => env('DB_DATABASE', 'forge'),
    'username' => env('DB_USERNAME', 'forge'),
    'password' => env('DB_PASSWORD', ''),
    'charset' => 'utf8',
    'prefix' => '',
    'prefix_indexes' => true,
    'search_path' => 'public', // PostgreSQL specific
    'sslmode' => 'prefer',
],
```

### 3. **Install PostgreSQL PHP Extension**
```bash
# Ubuntu/Debian
sudo apt install php-pgsql
# Restart PHP-FPM/Apache
sudo systemctl restart php8.3-fpm  # Adjust PHP version

# macOS
pecl install pdo_pgsql
# Add to php.ini: extension=pdo_pgsql.so

# Windows
# Uncomment extension=pgsql and extension=pdo_pgsql in php.ini
```

---

## ðŸš€ Database Migration Strategy

### **Option A: Fresh Start (Recommended for New Features)**
```bash
# 1. Drop all tables in PostgreSQL (if any)
php artisan db:wipe

# 2. Run migrations
php artisan migrate

# 3. Seed data
php artisan db:seed
```

### **Option B: Migrate Existing Data**

#### Step 1: Export MySQL Data
```bash
# Export schema
mysqldump -u root -p --no-data your_database > schema.sql

# Export data
mysqldump -u root -p --no-create-info your_database > data.sql
```

#### Step 2: Convert SQL Syntax
Create a conversion script `convert_mysql_to_pgsql.php`:
```php
<?php
$mysql_sql = file_get_contents('schema.sql');

// Common conversions
$conversions = [
    // Auto-increment
    '/AUTO_INCREMENT/' => 'GENERATED BY DEFAULT AS IDENTITY',
    
    // Engine specifications
    '/ENGINE=InnoDB/' => '',
    '/DEFAULT CHARSET=utf8mb4/' => '',
    
    // Backticks to quotes
    '/`([^`]+)`/' => '"$1"',
    
    // Data types
    '/TINYINT\(1\)/' => 'BOOLEAN',
    '/INT\(\d+\)/' => 'INTEGER',
    '/DATETIME/' => 'TIMESTAMP',
    '/TEXT\(\d+\)/' => 'TEXT',
    
    // Comments
    '/COMMENT \'.*\',/' => ',',
];

$pgsql_sql = preg_replace(
    array_keys($conversions),
    array_values($conversions),
    $mysql_sql
);

file_put_contents('schema_pgsql.sql', $pgsql_sql);
echo "Conversion complete!\n";
```

#### Step 3: Import to PostgreSQL
```bash
# Import converted schema
psql -U your_database_user -d your_database_name -f schema_pgsql.sql

# For data migration, consider using a tool
pgloader mysql://user:pass@localhost/mydb pgsql://user:pass@localhost/mydb
```

---

## ðŸ” Codebase Changes Required

### 1. **Update Database Queries**
```php
// MySQL-specific functions to change:

// DATE_FORMAT â†’ TO_CHAR
// MySQL:
DB::raw("DATE_FORMAT(created_at, '%Y-%m')")
// PostgreSQL:
DB::raw("TO_CHAR(created_at, 'YYYY-MM')")

// NOW() â†’ CURRENT_TIMESTAMP
DB::raw("NOW()") // Change to
DB::raw("CURRENT_TIMESTAMP")

// IFNULL â†’ COALESCE
DB::raw("IFNULL(column, 'default')") // Change to
DB::raw("COALESCE(column, 'default')")

// LIMIT with OFFSET syntax
// MySQL: LIMIT 10 OFFSET 20
// PostgreSQL: LIMIT 10 OFFSET 20 (same, but verify)
```

### 2. **Update Eloquent Models**
```php
// If you have MySQL-specific casts or attributes
class Member extends Model
{
    // Change MySQL JSON casting if needed
    protected $casts = [
        'metadata' => 'array', // Works in both
        'settings' => 'object',
    ];
    
    // PostgreSQL doesn't support unsigned integers in same way
    // Remove unsigned from migrations
}
```

### 3. **Update Migrations**
Create a new migration to fix any issues:
```bash
php artisan make:migration ConvertToPostgreSQL
```

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Facades\DB;

return new class extends Migration
{
    public function up(): void
    {
        // Remove MySQL-specific attributes
        Schema::table('users', function (Blueprint $table) {
            // PostgreSQL doesn't need charset/collation
            $table->string('email')->change(); // Just ensure no MySQL options
            
            // Change JSON column defaults if needed
            $table->json('preferences')->default('{}')->change();
        });
        
        // Fix any auto-increment issues
        Schema::table('table_name', function (Blueprint $table) {
            if (DB::connection() instanceof \Illuminate\Database\PostgresConnection) {
                // PostgreSQL specific adjustments
                $table->bigIncrements('id')->change(); // Should work
            }
        });
    }
    
    public function down(): void
    {
        // Revert if needed
    }
};
```

---

## ðŸ§ª Testing the Migration

### 1. **Run Basic Tests**
```bash
# Test database connection
php artisan tinker
>>> DB::connection()->getPdo()->getAttribute(PDO::ATTR_DRIVER_NAME)
# Should return: "pgsql"

# Test basic queries
>>> \App\Models\User::count()
```

### 2. **Test Your Application**
```bash
# Clear caches
php artisan config:clear
php artisan cache:clear
php artisan route:clear
php artisan view:clear

# Run migrations
php artisan migrate:status

# Run tests
php artisan test

# If using Dusk for browser tests
php artisan dusk
```

### 3. **Verify Data Integrity**
```php
// Create a verification script
$tables = ['users', 'members', 'org_units'];
foreach ($tables as $table) {
    $mysqlCount = DB::connection('mysql')->table($table)->count();
    $pgsqlCount = DB::connection('pgsql')->table($table)->count();
    
    if ($mysqlCount === $pgsqlCount) {
        echo "âœ“ Table {$table}: {$pgsqlCount} records migrated\n";
    } else {
        echo "âœ— Table {$table}: MySQL({$mysqlCount}) â‰  PostgreSQL({$pgsqlCount})\n";
    }
}
```

---

## ðŸ› ï¸ PostgreSQL-Specific Optimizations

### 1. **Enable Extensions (for your project)**
```php
// Create migration for extensions
php artisan make:migration AddPostgreSQLExtensions

// In the migration:
public function up()
{
    DB::statement('CREATE EXTENSION IF NOT EXISTS "ltree"');
    DB::statement('CREATE EXTENSION IF NOT EXISTS "pg_trgm"');
    DB::statement('CREATE EXTENSION IF NOT EXISTS "uuid-ossp"');
}
```

### 2. **Update Composer Dependencies**
```json
{
    "require": {
        "doctrine/dbal": "^3.0", // Required for column modifications
        "laravel/framework": "^10.0|^11.0"
    },
    "require-dev": {
        "fakerphp/faker": "^1.9.1"
    }
}
```

### 3. **Update Queue/Jobs if Using Database Queue**
```bash
# Recreate jobs table for PostgreSQL
php artisan queue:table
php artisan migrate
```

---

## ðŸ“Š Common Issues & Solutions

### **Issue 1: "Column not found" after migration**
```bash
# Refresh the database
php artisan migrate:refresh
# Or
php artisan migrate:fresh
```

### **Issue 2: JSON column problems**
```php
// In migration, always set default for JSON columns
$table->json('metadata')->default('{}');
```

### **Issue 3: Case sensitivity**
```php
// PostgreSQL is case-sensitive for column names
// Always use snake_case in migrations and queries
```

### **Issue 4: Date format differences**
```php
// Set proper timezone in .env
APP_TIMEZONE="Asia/Kathmandu"
DB_TIMEZONE="+05:45"
```

---

## ðŸš€ Production Deployment Checklist

1. **âœ… Backup completed**
2. **âœ… PostgreSQL installed and running**
3. **âœ… Database user created with proper permissions**
4. **âœ… `.env` updated with PostgreSQL credentials**
5. **âœ… PHP PostgreSQL extension installed**
6. **âœ… Data migrated and verified**
7. **âœ… Application tested with PostgreSQL**
8. **âœ… MySQL dependencies removed**
9. **âœ… PostgreSQL extensions enabled (ltree, pg_trgm)**
10. **âœ… Performance tested**

---

## âš¡ Quick Migration Script

Create `switch_to_postgresql.sh`:
```bash
#!/bin/bash

echo "Switching Laravel project from MySQL to PostgreSQL..."

# Backup
echo "Backing up MySQL..."
mysqldump -u root -p your_database > backup_$(date +%Y%m%d).sql

# Update .env
echo "Updating .env file..."
sed -i 's/DB_CONNECTION=mysql/DB_CONNECTION=pgsql/g' .env
sed -i 's/DB_PORT=3306/DB_PORT=5432/g' .env

# Install PostgreSQL extension
echo "Installing PostgreSQL PHP extension..."
sudo apt install php-pgsql
sudo systemctl restart php8.3-fpm

# Clear caches
echo "Clearing Laravel caches..."
php artisan config:clear
php artisan cache:clear

# Run migrations
echo "Running migrations on PostgreSQL..."
php artisan migrate:fresh

echo "Migration complete! Test your application."
```

---

## ðŸ“ž Support Resources

- **Laravel PostgreSQL Documentation**: https://laravel.com/docs/database#postgresql-configuration
- **PostgreSQL Documentation**: https://www.postgresql.org/docs/
- **Doctrine DBAL**: For schema changes https://www.doctrine-project.org/projects/dbal.html

**Estimated Time:** 2-4 hours for a medium-sized Laravel project  
**Risk Level:** Medium (with proper backups)  
**Rollback Strategy:** Switch `.env` back to MySQL and restore backup

Would you like me to create specific migration scripts for your project structure, particularly for the `ltree` and materialized path implementation we discussed?