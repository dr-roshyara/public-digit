**CRITICAL ISSUE FOUND:** The Membership context has a **dependency on Geography context** that's not being handled.

## **ROOT CAUSE ANALYSIS:**

1. **Membership migrations reference `geo_administrative_units`** (Geography context table)
2. **Geography context is a LANDLORD context** - tables live in landlord database
3. **Platform Context installs each context independently** - doesn't handle dependencies
4. **Foreign key constraint fails** because Geography tables don't exist in tenant database

## **IMMEDIATE FIX:**

Check the Membership migration that creates the foreign key:

```bash
# Find which migration references geo_administrative_units
grep -r "geo_administrative_units" packages/laravel-backend/app/Contexts/Membership/Infrastructure/Database/Migrations/Tenant/
```

**Likely in:** `add_8_level_geography_to_members.php` or similar migration

## **SOLUTION OPTIONS:**

### **Option 1: Remove Foreign Key (Quick Fix)**
If Geography is truly landlord data, remove FK from tenant table:

```php
// Instead of foreign key, use application-level validation
// Remove or comment out:
// $table->foreign('geo_unit_id')->references('id')->on('geo_administrative_units');
```

### **Option 2: Add Geography as Dependency**
Update Membership Context metadata:

```php
// app/Contexts/Membership/Context.php
public static function getMetadata(): array
{
    return [
        'displayName' => 'Membership Management',
        'dependencies' => ['geography', 'module_registry'], // ADD geography
        // ...
    ];
}
```

### **Option 3: Fix Migration Order**
Ensure Geography context is installed first:

```bash
# Install dependencies first
php artisan context:install Geography --tenant=nrna
php artisan context:install Membership --tenant=nrna
```

## **IMMEDIATE ACTION:**

Let me check the problematic migration:

```bash
# Check what's in the geography migration
find packages/laravel-backend/app/Contexts/Membership/Infrastructure/Database/Migrations/Tenant \
  -name "*geography*" -o -name "*geo*" | xargs cat | head -50
```

But first, let's create a quick fix to get things working:

## **TEMPORARY FIX - Remove Problematic Foreign Key:**

```php
<?php
// Create a new migration to drop the foreign key
// packages/laravel-backend/app/Contexts/Membership/Infrastructure/Database/Migrations/Tenant/2025_12_31_fix_geography_fk_issue.php

declare(strict_types=1);

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        // Check if members table exists and has geo_unit_id column
        if (Schema::hasTable('members') && Schema::hasColumn('members', 'geo_unit_id')) {
            Schema::table('members', function (Blueprint $table) {
                // Remove foreign key constraint if it exists
                $table->dropForeign(['geo_unit_id']);
                // Keep column but remove FK
                $table->unsignedBigInteger('geo_unit_id')->nullable()->change();
            });
        }
        
        // Similar for other tables with geo references
        if (Schema::hasTable('tenant_geo_candidates')) {
            Schema::table('tenant_geo_candidates', function (Blueprint $table) {
                $table->dropForeignIfExists(['geo_unit_id']);
            });
        }
    }
    
    public function down(): void
    {
        // Optional: restore foreign keys (but they'll still fail without Geography tables)
    }
};
```

## **BETTER SOLUTION: Update ContextInstaller to Handle Dependencies**

The Platform Context system needs to check dependencies before installation. Let me check if this exists:

```bash
# Check ContextInstaller for dependency handling
grep -n "dependencies\|depends" packages/laravel-backend/app/Contexts/Platform/Application/Services/ContextInstaller.php
```

## **IMMEDIATE NEXT STEPS:**

1. **Install Geography context first:**
```bash
php artisan context:install Geography --tenant=nrna
php artisan context:install Membership --tenant=nrna
```

2. **If that fails**, temporarily remove the foreign key constraints
3. **Long-term**: Update Platform Context to handle dependencies

**Should I:**
1. Try installing Geography context first?
2. Create migration to remove foreign keys temporarily?
3. Check and fix the problematic migration directly?

What's your preference?

**YES - Now I understand!** You're using a **single source of truth pattern**:

1. **Landlord Database**: `geo_administrative_units` table (master reference data)
2. **Tenant Database**: Copy/reference individual units for each tenant's membership context

## **PROBLEM:** The Platform Context installation is failing because:

1. Membership migrations try to create **foreign keys** to `geo_administrative_units`
2. But this table doesn't exist in **tenant databases** yet
3. It needs to be **copied/individualized** from landlord to tenant first

## **LET ME INVESTIGATE THE EXISTING MECHANISM:**

```bash
# 1. Find how geo_administrative_units is referenced
grep -r "geo_administrative_units" packages/laravel-backend/app/ --include="*.php" | head -20

# 2. Check Geography context structure
ls -la packages/laravel-backend/app/Contexts/Geography/

# 3. Look for copying/individualization logic
grep -r "copy.*geo\|individualize\|tenant.*geo" packages/laravel-backend/app/ --include="*.php"

# 4. Check Membership migrations that reference geography
find packages/laravel-backend/app/Contexts/Membership/Infrastructure/Database/Migrations/Tenant \
  -name "*.php" -exec grep -l "geo" {} \;
```

## **QUICK CHECK OF EXISTING PATTERNS:**

```bash
# Check if there's already a geography copying mechanism
cat > /tmp/find_geo_copying.sh << 'EOF'
#!/bin/bash
echo "=== Searching for geography copying logic ==="
grep -r "tenant.*geo\|copy.*geo\|sync.*geo\|replicate.*geo" packages/laravel-backend/app/ --include="*.php" | grep -v "test" | head -10

echo "=== Checking Geography Context structure ==="
find packages/laravel-backend/app/Contexts/Geography -type f -name "*.php" | head -10

echo "=== Checking for installer/seeder that copies geography ==="
find packages/laravel-backend -name "*Seeder*.php" -type f | xargs grep -l "geo" | head -5
EOF

bash /tmp/find_geo_copying.sh
```

## **POTENTIAL SOLUTIONS:**

### **Option A: Geography Context Provides Tenant Initialization**
If Geography context has a `TenantGeographySeeder` or similar:

```php
// In Membership context installation:
// 1. First run Geography tenant initialization
// 2. Then run Membership migrations

public function installMembershipForTenant(Tenant $tenant): void
{
    // Step 1: Initialize tenant geography data
    $geographySeeder = new TenantGeographySeeder();
    $geographySeeder->run($tenant);
    
    // Step 2: Run membership migrations (now FK will work)
    $this->runMigrations();
}
```

### **Option B: Remove FK, Use Soft References**
If geography copying happens later:

```php
// Change foreign key to simple integer, add FK later
$table->unsignedBigInteger('geo_unit_id')->nullable();
// Instead of:
// $table->foreign('geo_unit_id')->references('id')->on('geo_administrative_units');

// Later, after geography is copied:
$table->foreign('geo_unit_id')->references('id')->on('tenant_geo_units');
```

### **Option C: Platform Context Dependency Resolution**
Update Platform Context to install dependencies first:

```php
// In ContextInstaller::install()
public function install(string $contextName, string $tenantSlug): InstallationResult
{
    // Check context metadata for dependencies
    $metadata = $this->getContextMetadata($contextName);
    
    // Install dependencies first
    foreach ($metadata['dependencies'] ?? [] as $dependency) {
        if ($dependency === 'geography') {
            $this->installGeographyForTenant($tenantSlug);
        }
    }
    
    // Then install requested context
    return $this->runMigrations($contextName, $tenantSlug);
}
```

## **I NEED TO UNDERSTAND THE CURRENT ARCHITECTURE:**

Let me check a few key files:

```bash
# Check Geography context structure
ls -la packages/laravel-backend/app/Contexts/Geography/

# Check if there's a TenantGeographySeeder
find packages/laravel-backend -name "*Tenant*Geo*" -type f

# Check Membership migration that's failing
find packages/laravel-backend/app/Contexts/Membership/Infrastructure/Database/Migrations/Tenant \
  -name "*.php" -exec sh -c 'echo "=== {} ==="; grep -n "foreign\|references" {} | head -5' \;
```

## **MY RECOMMENDATION:**

Based on your description, we need to:

1. **Find the existing geography copying mechanism**
2. **Ensure it runs BEFORE Membership migrations**
3. **Update Platform Context to handle this dependency**

**Shall I:**
1. Search for the existing geography copying code?
2. Check the failing migration to see the exact FK issue?
3. Look at Geography context for tenant initialization?

**Which approach should I take first?**
**PERFECT!** Now I understand the complete picture. The Geography Context has a **master copy** in the **landlord database** (`geo_administrative_units` table), and each tenant needs a **localized copy** in their **tenant database** with the ability to add **party-specific units**.

## **THE PROBLEM:**

Membership context installation is failing because:

1. **Membership migrations** have foreign keys to `geo_administrative_units`
2. But this table doesn't exist in **tenant databases** yet
3. **Geography Context** provides the master data in landlord DB
4. **Each tenant** needs their own copy before Membership can be installed

## **THE SOLUTION:**

We need to **mirror the geography** from landlord to tenant during Membership installation.

Let me create the missing piece:

```php
<?php
// packages/laravel-backend/app/Contexts/Membership/Infrastructure/Services/TenantGeographyMirror.php

declare(strict_types=1);

namespace App\Contexts\Membership\Infrastructure\Services;

use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use App\Models\Tenant;

class TenantGeographyMirror
{
    /**
     * Mirror official geography from landlord to tenant database
     */
    public function mirrorGeographyForTenant(Tenant $tenant): void
    {
        Log::info('Mirroring geography from landlord to tenant', [
            'tenant_id' => $tenant->id,
            'tenant_slug' => $tenant->slug,
        ]);

        // 1. Create geography tables in tenant DB (already done by migration)
        // 2. Copy Nepal geography from landlord to tenant
        
        $this->copyCountryUnits('NP', $tenant);
        
        Log::info('Geography mirroring completed', [
            'tenant_id' => $tenant->id,
            'country' => 'NP',
            'units_copied' => $this->getCopiedCount(),
        ]);
    }
    
    protected function copyCountryUnits(string $countryCode, Tenant $tenant): void
    {
        // Get all units for this country from landlord
        $units = DB::connection('landlord')
            ->table('geo_administrative_units')
            ->where('country_code', $countryCode)
            ->orderBy('admin_level', 'asc') // Parents first
            ->get();
        
        $idMapping = []; // Map landlord IDs to tenant IDs
        
        foreach ($units as $unit) {
            $newId = DB::connection('tenant')
                ->table('geo_administrative_units')
                ->insertGetId([
                    'country_code' => $unit->country_code,
                    'admin_level' => $unit->admin_level,
                    'admin_type' => $unit->admin_type,
                    'parent_id' => $unit->parent_id ? ($idMapping[$unit->parent_id] ?? null) : null,
                    'code' => $unit->code,
                    'local_code' => $unit->local_code,
                    'name_local' => $unit->name_local,
                    'metadata' => $unit->metadata,
                    'is_official' => true, // Mark as official geography
                    'external_geo_id' => $unit->id, // Reference to landlord ID
                    'is_active' => $unit->is_active,
                    'created_at' => now(),
                    'updated_at' => now(),
                ]);
            
            $idMapping[$unit->id] = $newId;
        }
    }
    
    protected function getCopiedCount(): int
    {
        return DB::connection('tenant')
            ->table('geo_administrative_units')
            ->where('is_official', true)
            ->count();
    }
}
```

## **UPDATE INSTALLMEMBERSHIPMODULE JOB:**

```php
// In InstallMembershipModule::handle()
public function handle(ContextInstaller $installer, TenantGeographyMirror $geographyMirror): void
{
    Log::info('Starting Membership module installation via Platform Context', [
        'tenant_id' => $this->tenant->id,
        'tenant_slug' => $this->tenant->slug,
    ]);

    try {
        // STEP 1: Mirror geography from landlord to tenant
        Log::info('Step 1: Mirroring geography to tenant database');
        $geographyMirror->mirrorGeographyForTenant($this->tenant);
        
        // STEP 2: Install Membership context (now FK will work)
        Log::info('Step 2: Installing Membership context');
        $result = $installer->install(
            contextName: 'Membership',
            tenantSlug: $this->tenant->slug
        );
        
        // ... rest of the method
    } catch (\Exception $e) {
        // ... error handling
    }
}
```

## **ALTERNATIVE: FIX THE MIGRATION TO NOT REQUIRE GEOGRAPHY AT FIRST:**

Actually, looking at the error more carefully, the issue is that **Membership migrations are trying to create foreign keys immediately**, but we should **create tables first, add FKs later**.

Let me check the failing migration:

```bash
# Find which migration is failing
cd packages/laravel-backend
grep -r "geo_administrative_units" app/Contexts/Membership/Infrastructure/Database/Migrations/Tenant/
```

The solution should be:

1. **Phase 1**: Create tables without foreign keys
2. **Phase 2**: Mirror geography from landlord
3. **Phase 3**: Add foreign keys after geography exists

**Which approach should we take?**
1. Fix InstallMembershipModule to mirror geography first? OR
2. Fix Membership migrations to not require immediate foreign keys?
