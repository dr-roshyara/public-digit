# üöÄ **Starting Implementation: Phase 0 - Foundation**

Let's begin with the foundation. I'll create all the necessary files step by step.

## üì¶ **Step 1: Database Migrations**

### **1.1 Create Subscription Contexts Table**
```bash
php artisan make:migration create_subscription_contexts_table
```

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('subscription_contexts', function (Blueprint $table) {
            $table->string('slug', 100)->primary();
            $table->string('name', 200);
            $table->text('description')->nullable();
            $table->string('icon', 50)->nullable();
            $table->string('category', 100)->nullable();
            $table->boolean('is_active')->default(true);
            $table->json('metadata')->nullable();
            $table->timestamps();
            
            $table->index('is_active');
            $table->index('category');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('subscription_contexts');
    }
};
```

### **1.2 Create Context Plans Table**
```bash
php artisan make:migration create_context_plans_table
```

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('context_plans', function (Blueprint $table) {
            $table->uuid('id')->primary();
            $table->string('context_slug', 100);
            $table->string('slug', 50);
            $table->string('name', 200);
            $table->text('description')->nullable();
            $table->decimal('price_monthly', 10, 2)->default(0);
            $table->decimal('price_yearly', 10, 2)->default(0);
            $table->integer('trial_days')->default(0);
            $table->json('features')->nullable(); // Array of feature slugs
            $table->json('limits')->nullable();   // {"max_cards": 100, "qr_scans": 1000}
            $table->boolean('is_active')->default(true);
            $table->integer('sort_order')->default(0);
            $table->timestamps();
            
            $table->foreign('context_slug')
                  ->references('slug')
                  ->on('subscription_contexts')
                  ->onDelete('cascade');
                  
            $table->unique(['context_slug', 'slug']);
            $table->index(['context_slug', 'is_active']);
            $table->index('sort_order');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('context_plans');
    }
};
```

### **1.3 Create Tenant Context Subscriptions Table**
```bash
php artisan make:migration create_tenant_context_subscriptions_table
```

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('tenant_context_subscriptions', function (Blueprint $table) {
            $table->uuid('id')->primary();
            $table->uuid('tenant_id');
            $table->string('context_slug', 100);
            $table->string('plan_slug', 50);
            $table->enum('status', ['trialing', 'active', 'canceled', 'past_due', 'unpaid'])
                  ->default('active');
            $table->timestamp('trial_ends_at')->nullable();
            $table->timestamp('current_period_ends_at')->nullable();
            $table->string('stripe_subscription_id')->nullable();
            $table->string('esewa_reference')->nullable(); // For Nepal payments
            $table->string('khalti_reference')->nullable(); // For Nepal payments
            $table->json('metadata')->nullable();
            $table->timestamps();
            
            $table->foreign('tenant_id')
                  ->references('id')
                  ->on('tenants')
                  ->onDelete('cascade');
                  
            $table->foreign('context_slug')
                  ->references('slug')
                  ->on('subscription_contexts')
                  ->onDelete('cascade');
                  
            $table->unique(['tenant_id', 'context_slug']);
            $table->index(['status', 'current_period_ends_at']);
            $table->index(['context_slug', 'status']);
            $table->index('trial_ends_at');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('tenant_context_subscriptions');
    }
};
```

### **1.4 Create Subscription Installations Table**
```bash
php artisan make:migration create_subscription_installations_table
```

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('subscription_installations', function (Blueprint $table) {
            $table->uuid('id')->primary();
            $table->uuid('tenant_id');
            $table->string('context_slug', 100);
            $table->string('version', 20);
            $table->enum('status', ['installed', 'uninstalled', 'failed', 'upgrading'])
                  ->default('installed');
            $table->timestamp('installed_at')->useCurrent();
            $table->timestamp('uninstalled_at')->nullable();
            $table->json('installation_log')->nullable();
            $table->json('error_details')->nullable();
            $table->timestamps();
            
            $table->foreign('tenant_id')
                  ->references('id')
                  ->on('tenants')
                  ->onDelete('cascade');
                  
            $table->foreign('context_slug')
                  ->references('slug')
                  ->on('subscription_contexts')
                  ->onDelete('cascade');
                  
            $table->unique(['tenant_id', 'context_slug']);
            $table->index(['context_slug', 'status']);
            $table->index('installed_at');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('subscription_installations');
    }
};
```

### **1.5 Create Feature Usage Tracking Table**
```bash
php artisan make:migration create_feature_usage_table
```

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('feature_usage', function (Blueprint $table) {
            $table->uuid('id')->primary();
            $table->uuid('tenant_id');
            $table->string('context_slug', 100);
            $table->string('feature_slug', 100);
            $table->integer('usage_count')->default(0);
            $table->string('period', 7); // Format: YYYY-MM for monthly reset
            $table->timestamp('last_used_at')->nullable();
            $table->timestamps();
            
            $table->foreign('tenant_id')
                  ->references('id')
                  ->on('tenants')
                  ->onDelete('cascade');
                  
            $table->foreign('context_slug')
                  ->references('slug')
                  ->on('subscription_contexts')
                  ->onDelete('cascade');
                  
            $table->unique(['tenant_id', 'context_slug', 'feature_slug', 'period']);
            $table->index(['context_slug', 'feature_slug', 'period']);
            $table->index('last_used_at');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('feature_usage');
    }
};
```

### **1.6 Create Pending Payments Table (for Nepal payments)**
```bash
php artisan make:migration create_pending_payments_table
```

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('pending_payments', function (Blueprint $table) {
            $table->uuid('id')->primary();
            $table->uuid('tenant_id');
            $table->string('context_slug', 100);
            $table->string('plan_slug', 50);
            $table->decimal('amount', 10, 2);
            $table->decimal('vat_amount', 10, 2)->default(0); // 13% for Nepal
            $table->string('currency', 3)->default('NPR');
            $table->string('provider', 50); // 'esewa', 'khalti', 'stripe'
            $table->string('transaction_id')->unique();
            $table->enum('status', ['pending', 'completed', 'failed', 'refunded'])
                  ->default('pending');
            $table->json('provider_data')->nullable(); // Raw provider response
            $table->timestamp('verified_at')->nullable();
            $table->timestamp('expires_at')->nullable(); // Payments expire after 30 minutes
            $table->timestamps();
            
            $table->foreign('tenant_id')
                  ->references('id')
                  ->on('tenants')
                  ->onDelete('cascade');
                  
            $table->foreign('context_slug')
                  ->references('slug')
                  ->on('subscription_contexts')
                  ->onDelete('cascade');
                  
            $table->index(['provider', 'status']);
            $table->index('transaction_id');
            $table->index('expires_at');
            $table->index(['created_at', 'status']);
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('pending_payments');
    }
};
```

## üèóÔ∏è **Step 2: Create Subscription Context Structure**

### **2.1 Create Subscription Context Directory**
```bash
# Create the subscription context structure
mkdir -p app/Subscription/Core/{Contracts,Services,Models,Events,Exceptions}
mkdir -p app/Subscription/Infrastructure/{Installers,PaymentProviders,Repositories}
mkdir -p app/Subscription/UI/Components
mkdir -p config/modules
```

### **2.2 Create Core Contracts (Interfaces)**

**Contract 1: SubscriptionCheckerInterface**
```php
<?php

namespace App\Subscription\Core\Contracts;

use App\Models\Tenant;

interface SubscriptionCheckerInterface
{
    public function canAccessFeature(Tenant $tenant, string $contextSlug, string $featureSlug): bool;
    
    public function getRemainingLimit(Tenant $tenant, string $contextSlug, string $limitSlug): int;
    
    public function incrementUsage(Tenant $tenant, string $contextSlug, string $featureSlug, int $amount = 1): void;
    
    public function isTrialActive(Tenant $tenant, string $contextSlug): bool;
    
    public function getTrialDaysLeft(Tenant $tenant, string $contextSlug): int;
}
```

**Contract 2: PaymentProcessorInterface**
```php
<?php

namespace App\Subscription\Core\Contracts;

use App\Models\Tenant;
use App\Subscription\Core\Models\SubscriptionContext;
use App\Subscription\Core\Models\ContextPlan;

interface PaymentProcessorInterface
{
    public function getProviderId(): string;
    
    public function getProviderName(): string;
    
    public function getSupportedCountries(): array;
    
    public function getSupportedCurrencies(): array;
    
    public function initiatePayment(
        Tenant $tenant,
        SubscriptionContext $context,
        ContextPlan $plan
    ): PaymentIntent;
    
    public function verifyPayment(string $transactionId): PaymentVerification;
    
    public function refundPayment(string $paymentId, float $amount): RefundResult;
    
    public function isAvailableForCountry(string $countryCode): bool;
}
```

**Contract 3: ModuleInstallerInterface**
```php
<?php

namespace App\Subscription\Core\Contracts;

use App\Models\Tenant;

interface ModuleInstallerInterface
{
    public function install(string $moduleSlug, Tenant $tenant, string $planSlug): InstallationResult;
    
    public function uninstall(string $moduleSlug, Tenant $tenant): UninstallationResult;
    
    public function upgrade(string $moduleSlug, Tenant $tenant, string $fromPlan, string $toPlan): UpgradeResult;
    
    public function isInstalled(Tenant $tenant, string $moduleSlug): bool;
    
    public function getInstallationStatus(Tenant $tenant, string $moduleSlug): ?InstallationStatus;
}
```

### **2.3 Create Core Models**

**Model 1: SubscriptionContext**
```php
<?php

namespace App\Subscription\Core\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\HasMany;

class SubscriptionContext extends Model
{
    protected $table = 'subscription_contexts';
    
    protected $primaryKey = 'slug';
    
    public $incrementing = false;
    
    protected $keyType = 'string';
    
    protected $fillable = [
        'slug',
        'name',
        'description',
        'icon',
        'category',
        'is_active',
        'metadata',
    ];
    
    protected $casts = [
        'is_active' => 'boolean',
        'metadata' => 'array',
    ];
    
    public function plans(): HasMany
    {
        return $this->hasMany(ContextPlan::class, 'context_slug', 'slug')
                    ->where('is_active', true)
                    ->orderBy('sort_order');
    }
    
    public function activePlans(): HasMany
    {
        return $this->plans()->where('is_active', true);
    }
    
    public function getFreePlan(): ?ContextPlan
    {
        return $this->plans()->where('price_monthly', 0)->first();
    }
    
    public function getPlanBySlug(string $slug): ?ContextPlan
    {
        return $this->plans()->where('slug', $slug)->first();
    }
}
```

**Model 2: ContextPlan**
```php
<?php

namespace App\Subscription\Core\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

class ContextPlan extends Model
{
    protected $table = 'context_plans';
    
    protected $keyType = 'string';
    
    public $incrementing = false;
    
    protected $fillable = [
        'context_slug',
        'slug',
        'name',
        'description',
        'price_monthly',
        'price_yearly',
        'trial_days',
        'features',
        'limits',
        'is_active',
        'sort_order',
    ];
    
    protected $casts = [
        'price_monthly' => 'decimal:2',
        'price_yearly' => 'decimal:2',
        'trial_days' => 'integer',
        'features' => 'array',
        'limits' => 'array',
        'is_active' => 'boolean',
        'sort_order' => 'integer',
    ];
    
    public function context(): BelongsTo
    {
        return $this->belongsTo(SubscriptionContext::class, 'context_slug', 'slug');
    }
    
    public function hasFeature(string $feature): bool
    {
        $features = $this->features ?? [];
        return in_array($feature, $features);
    }
    
    public function getLimit(string $limitSlug, $default = null)
    {
        return $this->limits[$limitSlug] ?? $default;
    }
    
    public function isFree(): bool
    {
        return $this->price_monthly == 0 && $this->price_yearly == 0;
    }
    
    public function getMonthlyPriceWithVat(string $countryCode = 'NP'): float
    {
        $price = $this->price_monthly;
        
        // Apply Nepal VAT (13%)
        if ($countryCode === 'NP' && $price > 0) {
            return $price * 1.13;
        }
        
        return $price;
    }
}
```

**Model 3: TenantSubscription**
```php
<?php

namespace App\Subscription\Core\Models;

use App\Models\Tenant;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

class TenantSubscription extends Model
{
    protected $table = 'tenant_context_subscriptions';
    
    protected $keyType = 'string';
    
    public $incrementing = false;
    
    protected $fillable = [
        'tenant_id',
        'context_slug',
        'plan_slug',
        'status',
        'trial_ends_at',
        'current_period_ends_at',
        'stripe_subscription_id',
        'esewa_reference',
        'khalti_reference',
        'metadata',
    ];
    
    protected $casts = [
        'trial_ends_at' => 'datetime',
        'current_period_ends_at' => 'datetime',
        'metadata' => 'array',
    ];
    
    public function tenant(): BelongsTo
    {
        return $this->belongsTo(Tenant::class);
    }
    
    public function context(): BelongsTo
    {
        return $this->belongsTo(SubscriptionContext::class, 'context_slug', 'slug');
    }
    
    public function plan(): BelongsTo
    {
        return $this->belongsTo(ContextPlan::class, 'context_slug', 'context_slug')
                    ->where('slug', $this->plan_slug);
    }
    
    public function isActive(): bool
    {
        return in_array($this->status, ['active', 'trialing']);
    }
    
    public function isTrialing(): bool
    {
        return $this->status === 'trialing';
    }
    
    public function isTrialActive(): bool
    {
        if (!$this->isTrialing()) {
            return false;
        }
        
        return $this->trial_ends_at && $this->trial_ends_at->isFuture();
    }
    
    public function getTrialDaysLeft(): int
    {
        if (!$this->trial_ends_at) {
            return 0;
        }
        
        return max(0, now()->diffInDays($this->trial_ends_at, false));
    }
    
    public function needsPayment(): bool
    {
        return in_array($this->status, ['past_due', 'unpaid']) || 
               ($this->isTrialing() && !$this->isTrialActive());
    }
}
```

## üìù **Step 3: Create Digital Card Module YAML Definition**

### **3.1 Create Digital Card Module YAML**
```yaml
# config/modules/digital_card.yaml
module:
  slug: digital_card
  name: Digital Membership Cards
  description: Create and manage digital membership cards with QR codes
  icon: id-card
  category: membership
  version: "1.0.0"
  
  # Paths to existing Digital Card context
  context_class: App\Contexts\DigitalCard\DigitalCardContext
  migrations_path: "app/Contexts/DigitalCard/Infrastructure/Database/Migrations"
  seeders_path: "app/Contexts/DigitalCard/Infrastructure/Database/Seeders"
  views_path: "resources/views/contexts/digital-card"
  
  dependencies: []
  
  features:
    - slug: create_card
      name: Create Card
      description: Create new digital membership cards
      category: core
      
    - slug: basic_templates
      name: Basic Templates
      description: Access to basic card templates
      category: design
      
    - slug: advanced_templates
      name: Advanced Templates
      description: Access to premium card templates
      category: design
      
    - slug: qr_code_generation
      name: QR Code Generation
      description: Generate QR codes for cards
      category: sharing
      
    - slug: share_via_link
      name: Share via Link
      description: Share cards via unique links
      category: sharing
      
    - slug: custom_branding
      name: Custom Branding
      description: Add custom logos and colors
      category: branding
      
    - slug: batch_generation
      name: Batch Generation
      description: Generate multiple cards at once
      category: productivity
      
    - slug: basic_analytics
      name: Basic Analytics
      description: View card usage statistics
      category: analytics
      
    - slug: advanced_analytics
      name: Advanced Analytics
      description: Detailed analytics and reports
      category: analytics
      
    - slug: api_access
      name: API Access
      description: Access cards via API
      category: integration
      
    - slug: white_label
      name: White Label
      description: Remove platform branding
      category: branding
      
    - slug: webhook_integrations
      name: Webhook Integrations
      description: Real-time webhook notifications
      category: integration
  
  plans:
    free:
      name: Free
      price_monthly: 0
      price_yearly: 0
      trial_days: 0
      features:
        - create_card
        - basic_templates
        - qr_code_generation
        - share_via_link
      limits:
        max_cards: 100
        max_templates: 3
        qr_scans_per_month: 1000
        api_calls_per_day: 100
      sort_order: 1
      
    pro:
      name: Professional
      price_monthly: 499
      price_yearly: 4990  # ~2 months free with annual
      trial_days: 30
      features:
        - create_card
        - basic_templates
        - advanced_templates
        - qr_code_generation
        - share_via_link
        - custom_branding
        - batch_generation
        - basic_analytics
      limits:
        max_cards: 1000
        max_templates: 20
        qr_scans_per_month: 10000
        api_calls_per_day: 1000
      sort_order: 2
      
    business:
      name: Business
      price_monthly: 1499
      price_yearly: 14990  # ~2 months free with annual
      trial_days: 30
      features:
        - create_card
        - basic_templates
        - advanced_templates
        - qr_code_generation
        - share_via_link
        - custom_branding
        - batch_generation
        - basic_analytics
        - advanced_analytics
        - api_access
        - white_label
        - webhook_integrations
      limits:
        max_cards: 10000
        max_templates: unlimited
        qr_scans_per_month: 100000
        api_calls_per_day: 10000
      sort_order: 3
  
  installation:
    type: database
    requires_tenant_database: true
    migrations:
      - CreateDigitalCardsTable
      - CreateDigitalCardTemplatesTable
      - CreateDigitalCardAnalyticsTable
    seeders:
      - DigitalCardBasicTemplatesSeeder
    after_install:
      - create_default_admin_card
      - send_welcome_email
    rollback_steps:
      - remove_all_cards
      - drop_tables
  
  payment_providers:
    - esewa
    - khalti
    - stripe
  
  tax_config:
    nepal:
      vat_rate: 0.13
      requires_pan: true
    default:
      tax_rate: 0.00
  
  metadata:
    card_formats: ["PNG", "PDF", "JPG"]
    default_qr_size: "300x300"
    supported_languages: ["en", "ne"]
```

## üîß **Step 4: Create Module Registry Service**

```php
<?php

namespace App\Subscription\Core\Services;

use Illuminate\Support\Collection;
use Illuminate\Support\Facades\Cache;
use Symfony\Component\Yaml\Yaml;

class ModuleRegistry
{
    protected array $modules = [];
    
    protected string $cacheKey = 'subscription_modules_registry';
    
    public function __construct()
    {
        $this->loadModules();
    }
    
    public function loadModules(): void
    {
        $this->modules = Cache::remember($this->cacheKey, 3600, function () {
            return $this->loadModulesFromFilesystem();
        });
    }
    
    protected function loadModulesFromFilesystem(): array
    {
        $modules = [];
        $moduleFiles = glob(config_path('modules/*.yaml'));
        
        foreach ($moduleFiles as $file) {
            $config = Yaml::parseFile($file);
            $slug = basename($file, '.yaml');
            
            $modules[$slug] = $this->createModuleDefinition($slug, $config);
        }
        
        return $modules;
    }
    
    protected function createModuleDefinition(string $slug, array $config): ModuleDefinition
    {
        return new ModuleDefinition([
            'slug' => $slug,
            'name' => $config['module']['name'] ?? $slug,
            'description' => $config['module']['description'] ?? '',
            'icon' => $config['module']['icon'] ?? 'box',
            'category' => $config['module']['category'] ?? 'general',
            'version' => $config['module']['version'] ?? '1.0.0',
            'context_class' => $config['module']['context_class'] ?? null,
            'migrations_path' => $config['module']['migrations_path'] ?? null,
            'seeders_path' => $config['module']['seeders_path'] ?? null,
            'views_path' => $config['module']['views_path'] ?? null,
            'dependencies' => $config['module']['dependencies'] ?? [],
            'features' => $this->parseFeatures($config['module']['features'] ?? []),
            'plans' => $this->parsePlans($config['module']['plans'] ?? []),
            'installation' => $config['module']['installation'] ?? [],
            'payment_providers' => $config['module']['payment_providers'] ?? [],
            'tax_config' => $config['module']['tax_config'] ?? [],
            'metadata' => $config['module']['metadata'] ?? [],
        ]);
    }
    
    protected function parseFeatures(array $features): Collection
    {
        return collect($features)->map(function ($feature) {
            if (is_string($feature)) {
                return [
                    'slug' => $feature,
                    'name' => ucfirst(str_replace('_', ' ', $feature)),
                    'description' => '',
                    'category' => 'general',
                ];
            }
            
            return $feature;
        });
    }
    
    protected function parsePlans(array $plans): Collection
    {
        return collect($plans)->map(function ($plan, $slug) {
            return [
                'slug' => $slug,
                'name' => $plan['name'] ?? ucfirst($slug),
                'price_monthly' => $plan['price_monthly'] ?? 0,
                'price_yearly' => $plan['price_yearly'] ?? 0,
                'trial_days' => $plan['trial_days'] ?? 0,
                'features' => $plan['features'] ?? [],
                'limits' => $plan['limits'] ?? [],
                'sort_order' => $plan['sort_order'] ?? 0,
            ];
        })->sortBy('sort_order');
    }
    
    public function getModule(string $slug): ?ModuleDefinition
    {
        return $this->modules[$slug] ?? null;
    }
    
    public function getAvailableModules(): array
    {
        return array_keys($this->modules);
    }
    
    public function getModulesByCategory(string $category): Collection
    {
        return collect($this->modules)->filter(function ($module) use ($category) {
            return $module->category === $category;
        });
    }
    
    public function clearCache(): void
    {
        Cache::forget($this->cacheKey);
        $this->loadModules();
    }
    
    public function registerModule(string $slug, array $config): void
    {
        $this->modules[$slug] = $this->createModuleDefinition($slug, $config);
        $this->saveToCache();
    }
    
    protected function saveToCache(): void
    {
        Cache::put($this->cacheKey, $this->modules, 3600);
    }
}

class ModuleDefinition
{
    public function __construct(
        public readonly string $slug,
        public readonly string $name,
        public readonly string $description,
        public readonly string $icon,
        public readonly string $category,
        public readonly string $version,
        public readonly ?string $context_class,
        public readonly ?string $migrations_path,
        public readonly ?string $seeders_path,
        public readonly ?string $views_path,
        public readonly array $dependencies,
        public readonly Collection $features,
        public readonly Collection $plans,
        public readonly array $installation,
        public readonly array $payment_providers,
        public readonly array $tax_config,
        public readonly array $metadata,
    ) {}
    
    public function hasMigration(): bool
    {
        return !empty($this->migrations_path) && file_exists(base_path($this->migrations_path));
    }
    
    public function getFreePlan(): ?array
    {
        return $this->plans->firstWhere('price_monthly', 0);
    }
    
    public function getPlan(string $slug): ?array
    {
        return $this->plans->firstWhere('slug', $slug);
    }
    
    public function getFeature(string $slug): ?array
    {
        return $this->features->firstWhere('slug', $slug);
    }
}
```

## üì¶ **Step 5: Create Service Provider**

```php
<?php

namespace App\Providers;

use App\Subscription\Core\Services\ModuleRegistry;
use Illuminate\Support\ServiceProvider;

class SubscriptionServiceProvider extends ServiceProvider
{
    public function register(): void
    {
        // Register Module Registry as singleton
        $this->app->singleton(ModuleRegistry::class, function ($app) {
            return new ModuleRegistry();
        });
        
        // Register subscription services
        $this->app->singleton(\App\Subscription\Core\Contracts\SubscriptionCheckerInterface::class, 
            \App\Subscription\Core\Services\SubscriptionService::class);
            
        $this->app->singleton(\App\Subscription\Core\Contracts\ModuleInstallerInterface::class,
            \App\Subscription\Infrastructure\Installers\ModuleInstaller::class);
    }
    
    public function boot(): void
    {
        // Register commands
        if ($this->app->runningInConsole()) {
            $this->commands([
                \App\Subscription\Console\Commands\InstallModuleCommand::class,
                \App\Subscription\Console\Commands\SyncModulesCommand::class,
                \App\Subscription\Console\Commands\CheckSubscriptionsCommand::class,
            ]);
        }
        
        // Publish configuration
        $this->publishes([
            __DIR__.'/../config/modules.php' => config_path('modules.php'),
        ], 'subscription-config');
        
        // Load migrations
        $this->loadMigrationsFrom(__DIR__.'/../database/migrations');
        
        // Register routes
        $this->loadRoutesFrom(__DIR__.'/../routes/web.php');
        $this->loadRoutesFrom(__DIR__.'/../routes/api.php');
    }
}
```

## üöÄ **Step 6: Run Migrations and Test**

```bash
# Run the migrations
php artisan migrate

# Create a test command to verify setup
php artisan make:command TestSubscriptionSetup
```

```php
<?php

namespace App\Console\Commands;

use App\Subscription\Core\Services\ModuleRegistry;
use Illuminate\Console\Command;

class TestSubscriptionSetup extends Command
{
    protected $signature = 'subscription:test-setup';
    protected $description = 'Test the subscription system setup';
    
    public function handle(ModuleRegistry $registry): void
    {
        $this->info('Testing Subscription System Setup...');
        
        // Test 1: Check if module registry loads
        $this->info('1. Checking module registry...');
        $modules = $registry->getAvailableModules();
        
        if (empty($modules)) {
            $this->error('No modules found in registry!');
            $this->info('Make sure you have YAML files in config/modules/');
            return;
        }
        
        $this->info('‚úì Found modules: ' . implode(', ', $modules));
        
        // Test 2: Check Digital Card module
        $this->info('2. Checking Digital Card module...');
        $digitalCard = $registry->getModule('digital_card');
        
        if (!$digitalCard) {
            $this->error('Digital Card module not found!');
            return;
        }
        
        $this->info('‚úì Digital Card module loaded successfully');
        $this->info('   Name: ' . $digitalCard->name);
        $this->info('   Plans: ' . $digitalCard->plans->count());
        $this->info('   Features: ' . $digitalCard->features->count());
        
        // Test 3: Check database tables
        $this->info('3. Checking database tables...');
        
        $tables = [
            'subscription_contexts',
            'context_plans',
            'tenant_context_subscriptions',
            'subscription_installations',
            'feature_usage',
            'pending_payments',
        ];
        
        foreach ($tables as $table) {
            if (\Schema::hasTable($table)) {
                $this->info("   ‚úì Table '{$table}' exists");
            } else {
                $this->error("   ‚úó Table '{$table}' missing!");
            }
        }
        
        $this->info('');
        $this->info('‚úÖ Subscription system setup completed successfully!');
        $this->info('');
        $this->info('Next steps:');
        $this->info('1. Seed subscription contexts: php artisan db:seed --class=SubscriptionContextSeeder');
        $this->info('2. Test module installation: php artisan subscription:install digital_card --tenant=1');
        $this->info('3. Create admin interface for module management');
    }
}
```

## üìã **Immediate Next Steps:**

1. **Run the migrations:**
```bash
php artisan migrate
```

2. **Create a seeder for subscription contexts:**
```bash
php artisan make:seeder SubscriptionContextSeeder
```

3. **Test the setup:**
```bash
php artisan subscription:test-setup
```

4. **Create the Digital Card installer:**
```php
// app/Subscription/Infrastructure/Installers/DigitalCardInstaller.php
```

**Ready to proceed?** Should I:
1. Create the SubscriptionContextSeeder
2. Create the DigitalCardInstaller
3. Create the admin controller for module management
4. Create the Vue components for the module marketplace

**Which one should we do next?**