Based on our analysis, here's the **CLAUDE CLI instruction** to solve these problems:

## **CLAUDE CLI INSTRUCTION: FIX TENANT MOCKING IN MEMBERSHIP TESTS**

### **PROBLEM:** 
The test `MemberRegistrationTest.php` is trying to mock `Tenant::shouldReceive('current')` but `Tenant` is an Eloquent model, not a mockable facade. This causes `BadMethodCallException: Call to undefined method App\Models\Tenant::shouldReceive()`.

### **ROOT CAUSE:**
1. Line 62 in the test uses `Tenant::shouldReceive()` which only works for Facades, not regular Eloquent models
2. The `Tenant` model doesn't have a mockable static `current()` method
3. We need to mock the tenant context differently

### **SOLUTION:**

Edit the test file and replace the problematic mocking approach with proper container binding:

```bash
# Backup the test file
cp packages/laravel-backend/tests/Feature/Membership/MemberRegistrationTest.php packages/laravel-backend/tests/Feature/Membership/MemberRegistrationTest.php.backup

# Edit the test to fix Tenant mocking
cat > packages/laravel-backend/tests/Feature/Membership/MemberRegistrationTest.php << 'EOF'
<?php

namespace Tests\Feature\Membership;

use App\Contexts\Geography\Application\Services\GeographyService;
use App\Models\Tenant;
use Illuminate\Support\Facades\DB;
use Mockery;
use Tests\TestCase;

/**
 * Member Registration Test Suite (Using Existing tenant_test1 Database)
 *
 * Tests the MemberRegistrationService with geography validation.
 */
class MemberRegistrationTest extends TestCase
{
    private string $testDatabaseName = 'tenant_test1';
    private string $testTenantId;

    protected function setUp(): void
    {
        parent::setUp();

        // Generate test tenant ID
        $this->testTenantId = 'test-tenant-' . uniqid();

        // Configure tenant_test connection to use existing tenant_test1 database
        config(['database.connections.tenant_test' => [
            'driver' => 'mysql',
            'host' => env('DB_HOST', '127.0.0.1'),
            'port' => env('DB_PORT', '3306'),
            'database' => $this->testDatabaseName,
            'username' => env('DB_USERNAME', 'root'),
            'password' => env('DB_PASSWORD', ''),
            'charset' => 'utf8mb4',
            'collation' => 'utf8mb4_unicode_ci',
            'prefix' => '',
            'strict' => true,
        ]]);

        // Set default connection to tenant_test
        config(['database.default' => 'tenant_test']);
        DB::purge('tenant_test');
        DB::reconnect('tenant_test');

        // Clean up any existing test data
        DB::connection('tenant_test')->table('members')->truncate();

        // Mock Tenant model for Tenant::current() calls
        $tenantMock = Mockery::mock(Tenant::class);
        $tenantMock->id = $this->testTenantId;
        $tenantMock->slug = 'TEST-PARTY';
        $tenantMock->shouldReceive('getAttribute')->with('id')->andReturn($this->testTenantId);
        $tenantMock->shouldReceive('getAttribute')->with('slug')->andReturn('TEST-PARTY');
        $tenantMock->shouldIgnoreMissing();

        // Bind to container - this is the key fix
        $this->app->instance(Tenant::class, $tenantMock);
        
        // Also bind to 'tenant' alias if used
        $this->app->instance('tenant', $tenantMock);
    }

    protected function tearDown(): void
    {
        Mockery::close();
        parent::tearDown();
    }

    /**
     * Test 1: Service can be instantiated
     *
     * @test
     * @group membership
     * @group tdd-red
     */
    public function member_registration_service_can_be_instantiated(): void
    {
        // Arrange: Mock GeographyService
        $geographyServiceMock = Mockery::mock(GeographyService::class);

        // Act: Try to instantiate service (will fail - class doesn't exist)
        $service = new \App\Contexts\Membership\Application\Services\MemberRegistrationService(
            $geographyServiceMock
        );

        // Assert: Service exists
        $this->assertInstanceOf(
            \App\Contexts\Membership\Application\Services\MemberRegistrationService::class,
            $service
        );
    }

    /**
     * Test 2: Can register member with valid geography
     *
     * @test
     * @group membership
     */
    public function can_register_member_with_valid_geography(): void
    {
        // Arrange: Mock GeographyService to return valid
        $geographyServiceMock = Mockery::mock(GeographyService::class);
        $geographyServiceMock->shouldReceive('validateGeographyHierarchy')
            ->with('NP', [1, 10])
            ->once()
            ->andReturn(true);

        $service = new \App\Contexts\Membership\Application\Services\MemberRegistrationService(
            $geographyServiceMock
        );

        // Act: Register member via service
        $member = $service->register([
            'full_name' => 'John Doe',
            'country_code' => 'NP',
            'admin_unit_level1_id' => 1, // Koshi Province
            'admin_unit_level2_id' => 10, // Dhankuta District
            'membership_type' => 'full',
        ]);

        // Assert: Member created successfully
        $this->assertInstanceOf(\App\Contexts\Membership\Domain\Models\Member::class, $member);
        $this->assertEquals('John Doe', $member->full_name);
        $this->assertEquals('NP', $member->country_code);
        $this->assertEquals(1, $member->admin_unit_level1_id);
        $this->assertEquals(10, $member->admin_unit_level2_id);

        // Assert: Member saved in database
        $this->assertDatabaseHas('members', [
            'full_name' => 'John Doe',
            'country_code' => 'NP',
            'admin_unit_level1_id' => 1,
            'admin_unit_level2_id' => 10,
            'membership_type' => 'full',
        ]);
    }

    /**
     * Test 3: Cannot register member with invalid geography
     *
     * @test
     * @group membership
     * @group tdd-red
     */
    public function cannot_register_member_with_invalid_geography(): void
    {
        // Arrange: Mock GeographyService to return invalid
        $geographyServiceMock = Mockery::mock(GeographyService::class);
        $geographyServiceMock->shouldReceive('validateGeographyHierarchy')
            ->with('NP', [1, 25])
            ->once()
            ->andReturn(false);

        $this->app->instance(GeographyService::class, $geographyServiceMock);

        // Act: Try to register with invalid geography
        $response = $this->postJson('/api/members/register', [
            'full_name' => 'Jane Doe',
            'country_code' => 'NP',
            'admin_unit_level1_id' => 1, // Koshi Province
            'admin_unit_level2_id' => 25, // Kathmandu District (WRONG - in Bagmati)
            'membership_type' => 'full',
        ]);

        // Assert: Validation fails
        $response->assertStatus(422);
        $response->assertJsonValidationErrors(['admin_unit_level2_id']);
    }

    /**
     * Test 4: Membership number is generated correctly
     *
     * @test
     * @group membership
     * @group tdd-red
     */
    public function membership_number_is_generated_correctly(): void
    {
        // Arrange: Mock GeographyService
        $geographyServiceMock = Mockery::mock(GeographyService::class);
        $geographyServiceMock->shouldReceive('validateGeographyHierarchy')
            ->andReturn(true);

        $this->app->instance(GeographyService::class, $geographyServiceMock);

        // Mock tenant for membership number generation
        $tenant = Mockery::mock(Tenant::class);
        $tenant->id = 'test-tenant-uuid';
        $tenant->slug = 'test-party';
        $tenant->numeric_id = 1;

        // Bind tenant mock to container
        $this->app->instance(Tenant::class, $tenant);

        $service = new \App\Contexts\Membership\Application\Services\MemberRegistrationService(
            $geographyServiceMock
        );

        // Act & Assert: Membership number format
        // This test will fail initially
        $member = $service->register([
            'full_name' => 'Test User',
            'country_code' => 'NP',
            'admin_unit_level1_id' => 1,
            'admin_unit_level2_id' => 10,
            'membership_type' => 'full',
        ]);

        // Format: TEST-PARTY-2025-000001
        $this->assertStringStartsWith('TEST-PARTY-', strtoupper($member->membership_number));
        $this->assertMatchesRegularExpression('/^[A-Z-]+-\d{4}-\d{6}$/', $member->membership_number);
    }

    /**
     * Test 5: Province and District are required
     *
     * @test
     * @group membership
     * @group tdd-red
     */
    public function province_and_district_are_required(): void
    {
        // Act: Try to register without required geography
        $response = $this->postJson('/api/members/register', [
            'full_name' => 'Test User',
            'country_code' => 'NP',
            // Missing admin_unit_level1_id (province)
            // Missing admin_unit_level2_id (district)
            'membership_type' => 'full',
        ]);

        // Assert: Validation fails
        $response->assertStatus(422);
        $response->assertJsonValidationErrors(['admin_unit_level1_id', 'admin_unit_level2_id']);
    }

    /**
     * Test 6: Local level and ward are optional
     *
     * @test
     * @group membership
     * @group tdd-red
     */
    public function local_level_and_ward_are_optional(): void
    {
        // Arrange: Mock GeographyService
        $geographyServiceMock = Mockery::mock(GeographyService::class);
        $geographyServiceMock->shouldReceive('validateGeographyHierarchy')
            ->with('NP', [1, 10])
            ->once()
            ->andReturn(true);

        $this->app->instance(GeographyService::class, $geographyServiceMock);

        // Act: Register with only province and district (no local level/ward)
        $response = $this->postJson('/api/members/register', [
            'full_name' => 'Test User',
            'country_code' => 'NP',
            'admin_unit_level1_id' => 1,
            'admin_unit_level2_id' => 10,
            // No admin_unit_level3_id (optional)
            // No admin_unit_level4_id (optional)
            'membership_type' => 'full',
        ]);

        // Assert: Registration succeeds without level 3 & 4
        $response->assertStatus(201);
    }
}
EOF

echo "Test file updated. Now run the test:"
cd packages/laravel-backend && ./vendor/bin/phpunit tests/Feature/Membership/MemberRegistrationTest.php
```

### **KEY CHANGES MADE:**

1. **Removed** the problematic line: `Tenant::shouldReceive('current')->andReturn($tenantMock);`
2. **Added** proper container binding: `$this->app->instance(Tenant::class, $tenantMock);`
3. **Also bound** to 'tenant' alias: `$this->app->instance('tenant', $tenantMock);`
4. **Fixed** test 4 to use container binding instead of static method mocking

### **WHY THIS WORKS:**

- `Tenant` is an Eloquent model, not a facade, so `::shouldReceive()` doesn't work
- When code calls `Tenant::current()` or resolves `Tenant` from the container, it will get our mock
- The container binding ensures any dependency injection or service container resolution gets the mock

### **NEXT STEP AFTER FIX:**

After applying this fix, run the test:
```bash
cd packages/laravel-backend
./vendor/bin/phpunit tests/Feature/Membership/MemberRegistrationTest.php
```

The tests should now fail for the **right reasons** (missing functionality implementation) instead of mocking errors. This puts us back in the **TDD Red phase** where we can implement the missing features to make tests pass.