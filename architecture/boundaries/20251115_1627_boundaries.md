# ðŸŽ¯ Angular App User Flow - Sequence Diagrams

## 1. ðŸ  App Startup & Bootstrap Flow

```mermaid
sequenceDiagram
    participant U as User Browser
    participant A as Angular App
    participant AS as AppInitService
    participant DS as DomainService
    participant Arc as ArchitectureService
    participant Auth as AuthService
    participant TC as TenantContext

    U->>A: Navigate to *.publicdigit.com
    A->>AS: bootstrapApplication()
    AS->>Arc: loadBoundaries()
    Arc->>Arc: Fetch from /architecture/boundaries.json
    Arc-->>AS: Boundaries loaded
    
    AS->>DS: detectDomainType()
    DS->>DS: Analyze window.location.hostname
    DS-->>AS: Domain type: "tenant"
    
    alt Tenant Domain (*.publicdigit.com)
        AS->>DS: extractTenantSlug()
        DS-->>AS: tenantSlug = "nrna"
        AS->>TC: setTenantFromSlug("nrna")
        TC->>TC: Validate user access to tenant
        TC-->>AS: Tenant context set
    else Public Domain (www.publicdigit.com)
        AS->>AS: initializePublicSite()
    else Mobile Domain (app.publicdigit.com)
        AS->>AS: initializeMobileApp()
    end
    
    AS->>Auth: initialize()
    Auth->>Auth: Check stored token
    alt Has Valid Token
        Auth->>Auth: Verify token & load user
        Auth-->>AS: User authenticated
    else No Token/Invalid
        Auth-->>AS: User anonymous
    end
    
    AS-->>A: App initialized successfully
    A->>U: Render appropriate UI
```

## 2. ðŸ” Authentication & Login Flow

```mermaid
sequenceDiagram
    participant U as User
    participant C as Login Component
    participant Auth as AuthService
    participant PA as PlatformAPI
    participant S as Storage
    participant TC as TenantContext
    participant R as Router

    U->>C: Enter credentials & submit
    C->>Auth: login(credentials)
    Auth->>PA: POST /api/v1/auth/login
    PA-->>Auth: {token, user}
    
    Auth->>S: set('auth_token', token)
    Auth->>Auth: currentUser$.next(user)
    Auth->>Auth: isAuthenticated$.next(true)
    
    Auth->>PA: GET /api/v1/auth/tenants
    PA-->>Auth: [tenant1, tenant2, ...]
    Auth->>TC: availableTenants$.next(tenants)
    
    Auth->>Auth: handlePostLoginRouting(tenants)
    
    alt Single Tenant
        Auth->>U: Redirect to tenant1.publicdigit.com
    else Multiple Tenants
        Auth->>R: navigate(['/tenant-selection'])
        R-->>U: Show tenant selection UI
    else Public Domain
        Auth->>R: navigate(['/dashboard'])
        R-->>U: Show tenant selection dashboard
    end
    
    U->>U: Automatic page reload (if domain change)
```

## 3. ðŸ¢ Tenant Context Setup Flow

```mermaid
sequenceDiagram
    participant U as User
    participant TS as TenantSelection
    participant TC as TenantContext
    participant AS as AuthService
    participant PA as PlatformAPI
    participant R as Router
    participant FS as Feature Services

    U->>TS: Select tenant from list
    TS->>TC: setTenantFromSlug(tenantSlug)
    
    TC->>AS: Verify user has tenant access
    AS->>AS: Check availableTenants$
    AS-->>TC: Access granted
    
    TC->>TC: currentTenant$.next(tenant)
    TC->>TC: setTenantBaseUrl(tenant.slug)
    
    par Preload Tenant Data
        TC->>PA: GET /api/v1/tenant/config
        PA-->>TC: Tenant configuration
    and Initialize Services
        TC->>FS: initializeAllServices(tenant)
        FS->>FS: Clear caches, set contexts
    end
    
    TC->>R: navigate(['/dashboard'])
    R-->>U: Show tenant dashboard
    
    Note over U,FS: User now has full access<br/>to tenant-specific features
```

## 4. ðŸ›¡ï¸ Route Guard Protection Flow

```mermaid
sequenceDiagram
    participant U as User
    participant R as Router
    participant AG as AuthGuard
    participant TG as TenantGuard
    participant ArcG as ArchitectureGuard
    participant C as Target Component

    U->>R: Navigate to /elections
    R->>AG: canActivate()
    
    AG->>AG: Check authentication status
    alt Not Authenticated
        AG->>R: Redirect to /login
        R-->>U: Show login page
    else Authenticated
        AG-->>R: Allow navigation
        R->>TG: canActivate()
    end
    
    TG->>TG: Check tenant context
    alt No Tenant Context
        TG->>R: Redirect to /tenant-selection
        R-->>U: Show tenant selection
    else Tenant Context Set
        TG-->>R: Allow navigation
        R->>ArcG: canActivate()
    end
    
    ArcG->>ArcG: Check route boundaries
    alt Route Prohibited
        ArcG->>R: Redirect to /
        R-->>U: Show home page with error
    else Route Allowed
        ArcG-->>R: Allow navigation
        R->>C: Load component
        C-->>U: Render elections page
    end
```

## 5. ðŸŒ Multi-Domain Navigation Flow

```mermaid
sequenceDiagram
    participant U as User
    participant PS as Public Site (www)
    participant TS as Tenant Site (*.publicdigit.com)
    participant MS as Mobile Site (app.publicdigit.com)
    participant A as AuthService
    participant TC as TenantContext

    U->>PS: Visit www.publicdigit.com
    PS->>PS: Show marketing content
    U->>PS: Click "Find Organization"
    PS->>PS: Show tenant directory
    U->>PS: Select "NRNA"
    
    alt User Logged In
        PS->>U: Redirect to nrna.publicdigit.com
        U->>TS: Load nrna.publicdigit.com
        TS->>TC: setTenantFromSlug("nrna")
        TC-->>TS: Context set
        TS-->>U: Show NRNA dashboard
    else User Anonymous
        PS->>U: Redirect to nrna.publicdigit.com/login
        U->>TS: Load login page
        U->>TS: Complete login
        TS->>TC: setTenantFromSlug("nrna")
        TC-->>TS: Context set
        TS-->>U: Show NRNA dashboard
    end
    
    U->>TS: Use tenant features
    U->>MS: Visit app.publicdigit.com (mobile)
    MS->>A: Check authentication
    A-->>MS: User authenticated
    MS->>TC: Sync tenant context
    TC-->>MS: Context available
    MS-->>U: Show mobile-optimized UI
```

## 6. ðŸ”„ State Management Flow

```mermaid
sequenceDiagram
    participant U as User
    participant A as Angular App
    participant Auth as AuthService
    participant TC as TenantContext
    participant S as Storage
    participant API as Backend APIs

    A->>Auth: initialize()
    Auth->>S: get('auth_token')
    S-->>Auth: token
    
    alt Token Valid
        Auth->>API: GET /api/v1/auth/me
        API-->>Auth: userData
        Auth->>Auth: setAuthState("authenticated")
        Auth->>API: GET /api/v1/auth/tenants
        API-->>Auth: tenantsList
        
        Auth->>TC: setAvailableTenants(tenants)
        TC->>S: get('current_tenant')
        S-->>TC: lastTenant
        
        alt Last Tenant Valid
            TC->>TC: setTenant(lastTenant)
            TC-->>A: State: READY
        else No Last Tenant
            TC-->>A: State: NEEDS_TENANT_SELECTION
        end
    else No Token/Invalid
        Auth->>Auth: setAuthState("anonymous")
        Auth-->>A: State: UNAUTHENTICATED
    end
    
    A->>U: Render based on state
    
    Note over A,U: States:<br/>- UNAUTHENTICATED: Show login<br/>- AUTHENTICATED_NEEDS_TENANT: Show selection<br/>- READY: Show app features
```

## 7. ðŸš€ Error Handling & Recovery Flow

```mermaid
sequenceDiagram
    participant U as User
    participant A as Angular App
    participant AS as AppInitService
    participant Auth as AuthService
    participant TC as TenantContext
    participant R as Router
    participant E as ErrorService

    A->>AS: initialize()
    AS->>Auth: initialize()
    Auth->>Auth: Check token validity
    
    alt Token Expired
        Auth->>E: logError('Token expired')
        Auth->>Auth: clearAuthData()
        Auth->>R: navigate(['/login'])
        R-->>U: Show login with message
    else Network Error
        Auth->>E: logError('Network unavailable')
        Auth->>Auth: setOfflineMode()
        Auth-->>AS: Continue with cached data
    else Tenant Access Revoked
        TC->>E: logError('Tenant access denied')
        TC->>TC: clearTenantContext()
        TC->>R: navigate(['/tenant-selection'])
        R-->>U: Show tenant selection with error
    else Architecture Violation
        A->>E: logError('Route boundary violation')
        A->>R: navigate(['/'])
        R-->>U: Show home page with warning
    end
    
    E->>E: Report to monitoring service
    E->>U: Show user-friendly error message
    
    Note over U,E: All errors are logged<br/>User sees appropriate feedback<br/>App remains functional when possible
```

These diagrams provide a professional visualization of the key user flows, showing:

1. **Clear sequence** of operations
2. **Error handling** and recovery paths  
3. **State transitions** between different app states
4. **Integration points** between services
5. **User feedback** at each step

The flows ensure a robust, user-friendly experience while maintaining security and architectural boundaries.