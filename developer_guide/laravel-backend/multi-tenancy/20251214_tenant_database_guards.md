 Create file
╭───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ packages\laravel-backend\docs\tenant-provisioning-safety-architecture.md                                                                                                                                      │
│                                                                                                                                                                                                               │
│ # Tenant Provisioning Safety Architecture                                                                                                                                                                     │
│                                                                                                                                                                                                               │
│ ## Overview                                                                                                                                                                                                   │
│                                                                                                                                                                                                               │
│ This document describes the safety mechanisms implemented to prevent accidental changes to the tenant application process and ensure correct database selection during development/debugging.                 │
│                                                                                                                                                                                                               │
│ ## Architecture Diagram                                                                                                                                                                                       │
│                                                                                                                                                                                                               │
│ ```                                                                                                                                                                                                           │
│ ┌─────────────────────────────────────────────────────────────────────────┐                                                                                                                                   │
│ │                        TENANT PROVISIONING FLOW                          │                                                                                                                                  │
│ ├─────────────────────────────────────────────────────────────────────────┤                                                                                                                                   │
│ │                                                                         │                                                                                                                                   │
│ │  ┌─────────────────┐     ┌──────────────────────┐     ┌──────────────┐  │                                                                                                                                   │
│ │  │  Application    │────▶│  Platform Context    │────▶│  TenantAuth  │  │                                                                                                                                   │
│ │  │    Submission   │     │  (Orchestration)     │     │   Context    │  │                                                                                                                                   │
│ │  └─────────────────┘     └──────────────────────┘     └──────────────┘  │                                                                                                                                   │
│ │         │                        │                            │         │                                                                                                                                   │
│ │         │                        │                            │         │                                                                                                                                   │
│ │         ▼                        ▼                            ▼         │                                                                                                                                   │
│ │  ┌─────────────────┐     ┌──────────────────────┐     ┌──────────────┐  │                                                                                                                                   │
│ │  │ tenant_         │     │ ProvisionTenantJob   │     │ SafeTenant   │  │                                                                                                                                   │
│ │  │ applications    │     │ (Queue)              │     │ Database     │  │                                                                                                                                   │
│ │  └─────────────────┘     └──────────────────────┘     └──────────────┘  │                                                                                                                                   │
│ │         │                        │                     Selector         │                                                                                                                                   │
│ │         │                        │                            │         │                                                                                                                                   │
│ │         └────────────────────────┼────────────────────────────┘         │                                                                                                                                   │
│ │                                  ▼                                      │                                                                                                                                   │
│ │                         ┌─────────────────┐                            │                                                                                                                                    │
│ │                         │ Tenant Database │                            │                                                                                                                                    │
│ │                         │   tenant_{slug} │                            │                                                                                                                                    │
│ │                         └─────────────────┘                            │                                                                                                                                    │
│ │                                                                         │                                                                                                                                   │
│ └─────────────────────────────────────────────────────────────────────────┘                                                                                                                                   │
│ ```                                                                                                                                                                                                           │
│                                                                                                                                                                                                               │
│ ## Safety Components                                                                                                                                                                                          │
│                                                                                                                                                                                                               │
│ ### 1. TenantProvisioningGuard (`Platform Context`)                                                                                                                                                           │
│ **Location**: `app/Contexts/Platform/Application/Services/TenantProvisioningGuard.php`                                                                                                                        │
│                                                                                                                                                                                                               │
│ **Responsibilities**:                                                                                                                                                                                         │
│ - Validate provisioning flow context                                                                                                                                                                          │
│ - Verify database connections are correct                                                                                                                                                                     │
│ - Validate tenant database switches                                                                                                                                                                           │
│ - Validate provisioning data structure                                                                                                                                                                        │
│ - Comprehensive logging with caller information                                                                                                                                                               │
│                                                                                                                                                                                                               │
│ **Key Methods**:                                                                                                                                                                                              │
│ - `validateProvisioningFlow()` - Ensures we're in correct context                                                                                                                                             │
│ - `validateTenantDatabaseSwitch()` - Pre-flight checks for DB switching                                                                                                                                       │
│ - `validateProvisioningData()` - Validates all required fields                                                                                                                                                │
│                                                                                                                                                                                                               │
│ ### 2. SafeTenantDatabaseSelector (`TenantAuth Context`)                                                                                                                                                      │
│ **Location**: `app/Contexts/TenantAuth/Infrastructure/Database/SafeTenantDatabaseSelector.php`                                                                                                                │
│                                                                                                                                                                                                               │
│ **Responsibilities**:                                                                                                                                                                                         │
│ - Safe switching to tenant databases with validation                                                                                                                                                          │
│ - History tracking of all database switches                                                                                                                                                                   │
│ - Pre-flight checks (tenant exists, database exists)                                                                                                                                                          │
│ - Connection safety and validation                                                                                                                                                                            │
│                                                                                                                                                                                                               │
│ **Key Methods**:                                                                                                                                                                                              │
│ - `switchToTenant()` - Main safe switching method                                                                                                                                                             │
│ - `getSelectionHistory()` - View switch history                                                                                                                                                               │
│ - `getCurrentTenantDatabase()` - Get current tenant DB                                                                                                                                                        │
│ - `isConnectedToTenant()` - Check if connected to tenant                                                                                                                                                      │
│                                                                                                                                                                                                               │
│ ### 3. TenantSafeDebug CLI Command                                                                                                                                                                            │
│ **Location**: `app/Console/Commands/TenantSafeDebug.php`                                                                                                                                                      │
│                                                                                                                                                                                                               │
│ **Responsibilities**:                                                                                                                                                                                         │
│ - Safe debugging and repair operations                                                                                                                                                                        │
│ - Confirmation prompts for modifying actions                                                                                                                                                                  │
│ - Uses SafeTenantDatabaseSelector for all DB operations                                                                                                                                                       │
│ - Comprehensive logging                                                                                                                                                                                       │
│                                                                                                                                                                                                               │
│ **Available Actions**:                                                                                                                                                                                        │
│ - `view` - Show tenant information                                                                                                                                                                            │
│ - `repair` - Run tenant migrations                                                                                                                                                                            │
│ - `fix-admin` - Create/repair admin user                                                                                                                                                                      │
│ - `list-history` - Show DB switch history                                                                                                                                                                     │
│ - `reset-history` - Clear switch history                                                                                                                                                                      │
│                                                                                                                                                                                                               │
│ ## Safety Flow                                                                                                                                                                                                │
│                                                                                                                                                                                                               │
│ ### Provisioning Flow with Guards                                                                                                                                                                             │
│                                                                                                                                                                                                               │
│ ```                                                                                                                                                                                                           │
│ 1. Application Submission                                                                                                                                                                                     │
│    ↓                                                                                                                                                                                                          │
│ 2. Platform Context Validation                                                                                                                                                                                │
│    ├── TenantProvisioningGuard::validateProvisioningFlow()                                                                                                                                                    │
│    ├── Verify main database connection                                                                                                                                                                        │
│    └── Ensure not in tenant context                                                                                                                                                                           │
│    ↓                                                                                                                                                                                                          │
│ 3. ProvisionTenantJob Execution                                                                                                                                                                               │
│    ├── TenantProvisioningGuard::validateProvisioningData()                                                                                                                                                    │
│    ├── Verify all required fields                                                                                                                                                                             │
│    └── Log critical errors if flow broken                                                                                                                                                                     │
│    ↓                                                                                                                                                                                                          │
│ 4. Tenant Database Creation                                                                                                                                                                                   │
│    ↓                                                                                                                                                                                                          │
│ 5. Safe Database Switching                                                                                                                                                                                    │
│    ├── SafeTenantDatabaseSelector::switchToTenant()                                                                                                                                                           │
│    ├── Validate tenant exists                                                                                                                                                                                 │
│    ├── Validate database exists                                                                                                                                                                               │
│    └── Record switch in history                                                                                                                                                                               │
│    ↓                                                                                                                                                                                                          │
│ 6. Tenant Operations                                                                                                                                                                                          │
│    └── All operations use safe selector                                                                                                                                                                       │
│ ```                                                                                                                                                                                                           │
│                                                                                                                                                                                                               │
│ ### Database Switching Safety                                                                                                                                                                                 │
│                                                                                                                                                                                                               │
│ ```                                                                                                                                                                                                           │
│ Before Switch:                                                                                                                                                                                                │
│ 1. Check tenant exists in landlord DB                                                                                                                                                                         │
│ 2. Check database exists via INFORMATION_SCHEMA                                                                                                                                                               │
│ 3. Validate caller context                                                                                                                                                                                    │
│                                                                                                                                                                                                               │
│ During Switch:                                                                                                                                                                                                │
│ 1. Configure connection safely                                                                                                                                                                                │
│ 2. Purge and reconnect connection                                                                                                                                                                             │
│ 3. Verify connection works                                                                                                                                                                                    │
│                                                                                                                                                                                                               │
│ After Switch:                                                                                                                                                                                                 │
│ 1. Record in selection history                                                                                                                                                                                │
│ 2. Log successful switch                                                                                                                                                                                      │
│ 3. Track caller information                                                                                                                                                                                   │
│ ```                                                                                                                                                                                                           │
│                                                                                                                                                                                                               │
│ ## Critical Safety Rules                                                                                                                                                                                      │
│                                                                                                                                                                                                               │
│ ### 1. Context Separation                                                                                                                                                                                     │
│ - **Platform Context**: Tenant applications, provisioning orchestration                                                                                                                                       │
│ - **TenantAuth Context**: Tenant database operations, user management                                                                                                                                         │
│ - **Never mix contexts** - Each has clearly defined responsibilities                                                                                                                                          │
│                                                                                                                                                                                                               │
│ ### 2. Database Safety                                                                                                                                                                                        │
│ - **Main Database (mysql)**: `tenants`, `tenant_applications` tables                                                                                                                                          │
│ - **Tenant Databases**: `tenant_{slug}` databases with tenant-specific data                                                                                                                                   │
│ - **All switching** must use `SafeTenantDatabaseSelector`                                                                                                                                                     │
│ - **Never hardcode** database names                                                                                                                                                                           │
│                                                                                                                                                                                                               │
│ ### 3. Validation Requirements                                                                                                                                                                                │
│ - **Always validate** before provisioning operations                                                                                                                                                          │
│ - **Check all required fields**: `first_name`, `last_name`, `admin_email`, `organization_name`, `slug`                                                                                                        │
│ - **Validate formats**: Email format, slug format                                                                                                                                                             │
│ - **Log everything** - especially validation failures                                                                                                                                                         │
│                                                                                                                                                                                                               │
│ ### 4. Error Handling                                                                                                                                                                                         │
│ - **Throw exceptions** with clear messages                                                                                                                                                                    │
│ - **Never silent failures** - always log errors                                                                                                                                                               │
│ - **Rollback transactions** on failure                                                                                                                                                                        │
│ - **Clean up partial resources**                                                                                                                                                                              │
│                                                                                                                                                                                                               │
│ ## Usage Examples                                                                                                                                                                                             │
│                                                                                                                                                                                                               │
│ ### Safe Tenant Debugging                                                                                                                                                                                     │
│ ```bash                                                                                                                                                                                                       │
│ # View tenant information                                                                                                                                                                                     │
│ php artisan tenant:debug uml --action=view                                                                                                                                                                    │
│                                                                                                                                                                                                               │
│ # Run tenant migrations (with confirmation)                                                                                                                                                                   │
│ php artisan tenant:debug uml --action=repair                                                                                                                                                                  │
│                                                                                                                                                                                                               │
│ # Create/repair admin user (with confirmation)                                                                                                                                                                │
│ php artisan tenant:debug uml --action=fix-admin                                                                                                                                                               │
│                                                                                                                                                                                                               │
│ # View switch history                                                                                                                                                                                         │
│ php artisan tenant:debug uml --action=list-history                                                                                                                                                            │
│ ```                                                                                                                                                                                                           │
│                                                                                                                                                                                                               │
│ ### Programmatic Usage                                                                                                                                                                                        │
│ ```php                                                                                                                                                                                                        │
│ // Validate provisioning flow                                                                                                                                                                                 │
│ \App\Contexts\Platform\Application\Services\TenantProvisioningGuard::validateProvisioningFlow();                                                                                                              │
│                                                                                                                                                                                                               │
│ // Safely switch to tenant database                                                                                                                                                                           │
│ \App\Contexts\TenantAuth\Infrastructure\Database\SafeTenantDatabaseSelector::switchToTenant('uml');                                                                                                           │
│                                                                                                                                                                                                               │
│ // Validate provisioning data                                                                                                                                                                                 │
│ $tenantData = ['first_name' => 'John', 'last_name' => 'Doe', ...];                                                                                                                                            │
│ \App\Contexts\Platform\Application\Services\TenantProvisioningGuard::validateProvisioningData($tenantData);                                                                                                   │
│ ```                                                                                                                                                                                                           │
│                                                                                                                                                                                                               │
│ ## Monitoring and Logging                                                                                                                                                                                     │
│                                                                                                                                                                                                               │
│ ### What Gets Logged                                                                                                                                                                                          │
│ 1. **All database switches** - Tenant, database, timestamp, caller                                                                                                                                            │
│ 2. **Validation failures** - Missing fields, wrong context, etc.                                                                                                                                              │
│ 3. **Modifying actions** - Migrations, user creation, repairs                                                                                                                                                 │
│ 4. **Critical errors** - Wrong service usage, missing databases                                                                                                                                               │
│                                                                                                                                                                                                               │
│ ### Log Locations                                                                                                                                                                                             │
│ - `storage/logs/laravel.log` - All safety-related logs                                                                                                                                                        │
│ - `SafeTenantDatabaseSelector::$selectionHistory` - In-memory switch history                                                                                                                                  │
│ - CLI command output - User-friendly feedback                                                                                                                                                                 │
│                                                                                                                                                                                                               │
│ ## Code Review Checklist                                                                                                                                                                                      │
│                                                                                                                                                                                                               │
│ ### Before Merging Tenant-Related Code                                                                                                                                                                        │
│ - [ ] Uses `SafeTenantDatabaseSelector` for all tenant DB switching                                                                                                                                           │
│ - [ ] Validates provisioning flow with `TenantProvisioningGuard`                                                                                                                                              │
│ - [ ] Includes all required fields in provisioning data                                                                                                                                                       │
│ - [ ] No hardcoded database names                                                                                                                                                                             │
│ - [ ] Proper error handling and logging                                                                                                                                                                       │
│ - [ ] Follows context separation (Platform vs TenantAuth)                                                                                                                                                     │
│                                                                                                                                                                                                               │
│ ### Database Safety                                                                                                                                                                                           │
│ - [ ] Main DB for tenant records                                                                                                                                                                              │
│ - [ ] Tenant DB for tenant-specific data                                                                                                                                                                      │
│ - [ ] No cross-database queries                                                                                                                                                                               │
│ - [ ] Safe connection switching                                                                                                                                                                               │
│                                                                                                                                                                                                               │
│ ### Error Handling                                                                                                                                                                                            │
│ - [ ] Transactions with rollback                                                                                                                                                                              │
│ - [ ] No silent failures                                                                                                                                                                                      │
│ - [ ] Clear error messages                                                                                                                                                                                    │
│ - [ ] Comprehensive logging                                                                                                                                                                                   │
│                                                                                                                                                                                                               │
│ ## Testing the Safety System                                                                                                                                                                                  │
│                                                                                                                                                                                                               │
│ ### Manual Tests                                                                                                                                                                                              │
│ ```bash                                                                                                                                                                                                       │
│ # Test safe debug command                                                                                                                                                                                     │
│ php artisan tenant:debug uml --action=view                                                                                                                                                                    │
│                                                                                                                                                                                                               │
│ # Test validation                                                                                                                                                                                             │
│ php artisan tinker                                                                                                                                                                                            │
│ >>> \App\Contexts\Platform\Application\Services\TenantProvisioningGuard::validateProvisioningFlow();                                                                                                          │
│                                                                                                                                                                                                               │
│ # Check logs                                                                                                                                                                                                  │
│ tail -n 50 storage/logs/laravel.log | grep -i "safe\|tenant.*switch\|validation"                                                                                                                              │
│ ```                                                                                                                                                                                                           │
│                                                                                                                                                                                                               │
│ ### Automated Tests                                                                                                                                                                                           │
│ - Unit tests for `TenantProvisioningGuard`                                                                                                                                                                    │
│ - Integration tests for `SafeTenantDatabaseSelector`                                                                                                                                                          │
│ - Feature tests for `TenantSafeDebug` command                                                                                                                                                                 │
│ - Flow tests for complete provisioning process                                                                                                                                                                │
│                                                                                                                                                                                                               │
│ ## Emergency Procedures                                                                                                                                                                                       │
│                                                                                                                                                                                                               │
│ ### If Safety System Blocks Legitimate Operation                                                                                                                                                              │
│ 1. Check logs for specific error                                                                                                                                                                              │
│ 2. Verify tenant exists in landlord DB                                                                                                                                                                        │
│ 3. Verify database exists                                                                                                                                                                                     │
│ 4. Check caller context is correct                                                                                                                                                                            │
│ 5. Use `tenant:debug --action=view` to diagnose                                                                                                                                                               │
│                                                                                                                                                                                                               │
│ ### If Database Connection Issues                                                                                                                                                                             │
│ 1. Use `SafeTenantDatabaseSelector::getCurrentTenantDatabase()`                                                                                                                                               │
│ 2. Check `SafeTenantDatabaseSelector::getSelectionHistory()`                                                                                                                                                  │
│ 3. Verify main database credentials                                                                                                                                                                           │
│ 4. Check INFORMATION_SCHEMA for database existence                                                                                                                                                            │
│                                                                                                                                                                                                               │
│ ## Maintenance                                                                                                                                                                                                │
│                                                                                                                                                                                                               │
│ ### Adding New Safety Checks                                                                                                                                                                                  │
│ 1. Add to `TenantProvisioningGuard` for validation                                                                                                                                                            │
│ 2. Update architecture documentation                                                                                                                                                                          │
│ 3. Add to code review checklist                                                                                                                                                                               │
│ 4. Create corresponding tests                                                                                                                                                                                 │
│                                                                                                                                                                                                               │
│ ### Updating Safety Rules                                                                                                                                                                                     │
│ 1. Update all three components consistently                                                                                                                                                                   │
│ 2. Update documentation                                                                                                                                                                                       │
│ 3. Run comprehensive tests                                                                                                                                                                                    │
│ 4. Communicate changes to team                                                                                                                                                                                │
│                                                                                                                                                                                                               │
│ ## Version History                                                                                                                                                                                            │
│                                                                                                                                                                                                               │
│ ### v1.0.0 (Initial Implementation)                                                                                                                                                                           │
│ - `TenantProvisioningGuard` service                                                                                                                                                                           │
│ - `SafeTenantDatabaseSelector` class                                                                                                                                                                          │
│ - `TenantSafeDebug` CLI command                                                                                                                                                                               │
│ - Comprehensive architecture documentation                                                                                                                                                                    │
│ - Code review checklist                                                                                                                                                                                       │
│                                                                                                                                                                                                               │
│ ---                                                                                                                                                                                                           │
│                                                                                                                                                                                                               │
│ **Last Updated**: 2025-12-14                                                                                                                                                                                  │
│ **Maintainer**: Platform Architecture Team                                                                                                                                                                    │
│ **Status**: Production Ready                                                                                                                                                                                  │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
 Do you want to create tenant-provisioning-safety-architecture.md?
 > 1. Yes
   2. Yes, allow all edits during this session (alt+m)
   3. Type here to tell Claude what to do differently