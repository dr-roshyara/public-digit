# ðŸŒ **DEVELOPER GUIDE: GEOGRAPHY & MEMBERSHIP CONTEXTS**

## **ðŸ“‹ ARCHITECTURE OVERVIEW**

### **Current System Status: 70% Complete**
```
âœ… COMPLETED:
â”œâ”€â”€ Geography Context (Production Ready)
â”‚   â”œâ”€â”€ Global polymorphic geography schema
â”‚   â”œâ”€â”€ Nepal data seeded
â”‚   â”œâ”€â”€ 44 API integration tests
â”‚   â”œâ”€â”€ 68 unit/feature tests
â”‚   â””â”€â”€ GeographyService with caching
â”‚
â””â”€â”€ Membership Context (In Progress - TDD Phase)
    â”œâ”€â”€ Database migration (ready)
    â”œâ”€â”€ Domain models (ready)
    â”œâ”€â”€ Application service (ready)
    â””â”€â”€ Tests (RED phase - failing)
```

---

## **ðŸ—ºï¸ GEOGRAPHY CONTEXT**

### **Purpose:**
Centralized geographic infrastructure for ALL bounded contexts. Serves as **Shared Kernel**.

### **Key Features:**
- Single polymorphic table for ALL countries (`geo_administrative_units`)
- Country-specific hierarchy configuration
- Nepal fully supported, India/US ready for future
- Redis caching (24h TTL for hierarchy data)
- Spatial query support (radius, containment)

### **Database Schema:**
```sql
-- Landlord Database
CREATE TABLE geo_administrative_units (
    country_code CHAR(2),      -- 'NP', 'IN', 'US'
    admin_level TINYINT,       -- 1, 2, 3, 4 (not "province", "state")
    admin_type VARCHAR(50),    -- 'province', 'state', 'district'
    name_local JSON,           -- {"en": "Koshi", "np": "à¤•à¥‹à¤¶à¥€"}
    parent_id BIGINT,          -- Hierarchical relationship
    PARTITION BY KEY(country_code)
);
```

### **API Endpoints:**
```bash
GET    /api/geography/countries                 # List all countries
GET    /api/geography/countries/{code}          # Get country details
GET    /api/geography/countries/{code}/hierarchy # Full hierarchy
GET    /api/geography/units/{id}                # Get specific unit
GET    /api/geography/units/code/{code}         # Get unit by code
POST   /api/geography/validate/hierarchy        # Validate geography
```

### **Usage Example:**
```php
use App\Contexts\Geography\Application\Services\GeographyService;

$service = app(GeographyService::class);

// Get Nepal hierarchy
$hierarchy = $service->getCountryHierarchy('NP');

// Validate: Koshi â†’ Dhankuta â†’ Municipality â†’ Ward
$isValid = $service->validateGeographyHierarchy('NP', [1, 10, 100, 1001]);
```

---

## **ðŸ‘¥ MEMBERSHIP CONTEXT**

### **Purpose:**
Political party membership management for Nepal (extensible to other countries).

### **Architecture (DDD):**
```
app/Contexts/Membership/
â”œâ”€â”€ Domain/                          # Business rules
â”‚   â”œâ”€â”€ Models/Member.php            # Aggregate Root
â”‚   â””â”€â”€ Exceptions/InvalidGeographyException.php
â”œâ”€â”€ Application/                     # Use cases
â”‚   â”œâ”€â”€ Services/MemberRegistrationService.php
â”‚   â””â”€â”€ DTOs/RegisterMemberDTO.php   # (Coming soon)
â””â”€â”€ Infrastructure/
    â””â”€â”€ Database/Migrations/create_members_table.php
```

### **Database Schema (Tenant DB):**
```sql
CREATE TABLE members (
    -- Geography references to landlord.geo_administrative_units
    country_code CHAR(2) DEFAULT 'NP',
    admin_unit_level1_id BIGINT,     -- Province (REQUIRED)
    admin_unit_level2_id BIGINT,     -- District (REQUIRED)
    admin_unit_level3_id BIGINT NULL,-- Local Level (optional)
    admin_unit_level4_id BIGINT NULL,-- Ward (optional)
    
    -- Member details
    membership_number VARCHAR(50) UNIQUE,  -- NCP-NEPAL-2025-000001
    membership_type ENUM('full', 'associate', 'youth', 'student'),
    status ENUM('active', 'suspended', 'expired')
);
```

### **Business Rules:**
1. **Geography:** Province + District required (levels 1-2), Local Level + Ward optional (3-4)
2. **Membership Number:** Format: `{TENANT_SLUG}-{YEAR}-{SEQUENCE}` (e.g., `NCP-NEPAL-2025-000001`)
3. **Tenant User:** Optional link (`tenant_user_id` nullable) - some members have accounts, some don't
4. **Validation:** Uses GeographyService for hierarchy validation

### **Usage Example:**
```php
use App\Contexts\Membership\Application\Services\MemberRegistrationService;

$service = app(MemberRegistrationService::class);

$member = $service->register([
    'full_name' => 'John Doe',
    'country_code' => 'NP',
    'admin_unit_level1_id' => 1,     // Koshi Province
    'admin_unit_level2_id' => 10,    // Dhankuta District
    'admin_unit_level3_id' => 100,   // Dhankuta Municipality (optional)
    'admin_unit_level4_id' => 1001,  // Ward 1 (optional)
    'membership_type' => 'full',
]);
```

---

## **ðŸ§ª TESTING STATUS (TDD APPROACH)**

### **Geography Tests: âœ… ALL PASSING**
```bash
# Run geography tests
php artisan test tests/Feature/Geography/

# 44 integration tests
# 68 unit/feature tests
# All passing
```

### **Membership Tests: ðŸ”´ RED PHASE (FAILING)**
```bash
# Current status: Tests failing (as expected in TDD)
php artisan test tests/Feature/Membership/

# Expected output: Tests fail because:
# 1. API endpoints not created
# 2. RegisterMemberDTO missing
# 3. Controller not implemented
```

### **TDD Progress:**
```
RED PHASE (Current) â†’ GREEN PHASE (Next) â†’ REFACTOR
1. âœ… Create failing tests
2. âœ… Create domain models
3. âœ… Create application service
4. âŒ Create DTOs and controllers
5. âŒ Make tests pass
```

---

## **ðŸ”§ DEVELOPMENT WORKFLOW**

### **1. Environment Setup:**
```bash
# Use landlord database for geography
DB_CONNECTION=mysql
DB_DATABASE=landlord_db

# Tenant databases created dynamically
# via Spatie Multitenancy
```

### **2. Running Migrations:**
```bash
# Geography migrations (landlord)
php artisan migrate --database=landlord \
  --path=app/Contexts/Geography/Infrastructure/Database/Migrations

# Membership migrations (run per-tenant when module installed)
# Will be executed by MembershipContextInstaller
```

### **3. Seeding Data:**
```bash
# Seed countries and Nepal geography
php artisan db:seed --database=landlord \
  --class=App\\Contexts\\Geography\\Infrastructure\\Database\\Seeders\\CountriesSeeder

php artisan db:seed --database=landlord \
  --class=App\\Contexts\\Geography\\Infrastructure\\Database\\Seeders\\NepalGeographySeeder
```

### **4. Running Tests:**
```bash
# Geography tests
php artisan test tests/Feature/Geography/

# Membership tests (currently failing)
php artisan test tests/Feature/Membership/ --stop-on-failure

# Specific test class
php artisan test tests/Feature/Membership/MemberRegistrationTest.php
```

---

## **ðŸš€ NEXT DEVELOPMENT STEPS**

### **Immediate (Today):**
1. **Create RegisterMemberDTO** - Data transfer object for API
2. **Create API Controller** - REST endpoints for member registration
3. **Create Routes** - API routing
4. **Make Tests Pass** - TDD GREEN phase

### **Files to Create:**
```bash
# 1. DTO
touch app/Contexts/Membership/Application/DTOs/RegisterMemberDTO.php

# 2. Controller
touch app/Contexts/Membership/Http/Controllers/MemberController.php

# 3. Routes file
touch routes/membership-api.php

# 4. Add to RouteServiceProvider
```

### **API Design:**
```php
// POST /api/members/register
{
    "full_name": "John Doe",
    "country_code": "NP",
    "admin_unit_level1_id": 1,    // Province (required)
    "admin_unit_level2_id": 10,   // District (required)
    "admin_unit_level3_id": 100,  // Local Level (optional)
    "admin_unit_level4_id": 1001, // Ward (optional)
    "membership_type": "full",
    "tenant_user_id": null        // Optional
}
```

---

## **ðŸŽ¯ KEY ARCHITECTURAL DECISIONS**

### **1. Geography as Shared Kernel**
- Single source of truth in Landlord DB
- All contexts reference it (no duplication)
- Cached for performance

### **2. Multi-Tenant Membership**
- Each party has isolated database
- Membership data in tenant DBs
- Geography references to landlord DB (no FKs)

### **3. Nepal-First Approach**
- Complete Nepal geography implemented
- India/US schemas ready for future
- Country-specific validation rules

### **4. TDD Discipline**
- Tests written before implementation
- Red â†’ Green â†’ Refactor cycle
- 112+ tests already written

---

## **âš ï¸ KNOWN ISSUES & TODO**

### **Geography Context:**
- [ ] Spatial queries need optimization
- [ ] Cache invalidation on data changes
- [ ] Admin panel for geography management

### **Membership Context:**
- [ ] API endpoints not implemented
- [ ] DTOs not created
- [ ] No authentication/authorization
- [ ] Committee management (deferred)

### **Integration:**
- [ ] Frontend geo-detection integration
- [ ] Geographic analytics dashboard
- [ ] Multi-country support beyond Nepal

---

## **ðŸ“ž SUPPORT & DOCUMENTATION**

### **Useful Commands:**
```bash
# Check geography data
php artisan tinker
App\Contexts\Geography\Domain\Models\Country::where('is_supported', true)->get()

# Test geography validation
$service = app(\App\Contexts\Geography\Application\Services\GeographyService::class)
$service->validateGeographyHierarchy('NP', [1, 10])

# Check test coverage
php artisan test --coverage --min=80
```

### **Key Files Reference:**
- **Geography Service:** `app/Contexts/Geography/Application/Services/GeographyService.php`
- **Member Registration:** `app/Contexts/Membership/Application/Services/MemberRegistrationService.php`
- **Tests:** `tests/Feature/Membership/MemberRegistrationTest.php`
- **Migrations:** `app/Contexts/Membership/Infrastructure/Database/Migrations/2025_12_18_103600_create_members_table.php`

---

## **ðŸŽ¯ READY FOR PRODUCTION?**

### **Geography Context: âœ… YES**
- Production-ready
- Fully tested
- Scalable design

### **Membership Context: ðŸŸ¡ PARTIAL**
- Core domain logic ready
- Needs API layer
- Needs frontend integration

**Next 2 hours:** Complete API layer and make tests pass â†’ MVP ready.