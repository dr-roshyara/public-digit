
# ðŸŽ¯ **COMPLETE TUTORIAL: Multi-Tenant RBAC with Spatie & DDD**

## ðŸ“ **ARCHITECTURE OVERVIEW**

```
DATABASES:
â”œâ”€â”€ ðŸ”µ LANDLORD DATABASE (election)
â”‚   â””â”€â”€ tenants table only (list of all tenants)
â”‚
â””â”€â”€ ðŸŸ¢ TENANT DATABASES (each tenant has own)
    â”œâ”€â”€ tenant_nrna (for NRNA organization)
    â”‚   â”œâ”€â”€ roles table (with custom columns)
    â”‚   â”œâ”€â”€ permissions table (with custom columns)  
    â”‚   â”œâ”€â”€ users table
    â”‚   â””â”€â”€ other tenant-specific tables
    â”‚
    â””â”€â”€ tenant_uml (for UML party)
        â”œâ”€â”€ roles table (different roles for political party)
        â”œâ”€â”€ permissions table
        â”œâ”€â”€ users table
        â””â”€â”€ other tenant-specific tables
```

## ðŸŽ¯ **GOLDEN RULE: What Goes Where?**

| Item | Database | Why |
|------|----------|-----|
| `tenants` table | **Landlord** | One list of all tenants |
| `roles` table | **Tenant** | Each tenant has own roles |
| `permissions` table | **Tenant** | Each tenant has own permissions |
| Users, products, orders | **Tenant** | Tenant-specific data |
| System settings | **Landlord** | Global system config |

## ðŸš€ **PART 1: SIMPLE SETUP (No DDD Complexity)**

### **Step 1: Install Packages**
```bash
composer require spatie/laravel-multitenancy spatie/laravel-permission
```

### **Step 2: Publish Configs**
```bash
php artisan vendor:publish --provider="Spatie\Multitenancy\MultitenancyServiceProvider" --tag="multitenancy-config"
php artisan vendor:publish --provider="Spatie\Permission\PermissionServiceProvider" --tag="permission-config"
```

### **Step 3: Create Landlord Database Tables**
```bash
# Create tenants table in landlord DB
php artisan migrate
# This creates: tenants table in your landlord database
```

### **Step 4: Create a Tenant**
```bash
php artisan tinker
>>> \App\Models\Tenant::create([
...     'name' => 'NRNA Organization',
...     'slug' => 'nrna',
...     'domain' => 'nrna.localhost',
...     'database_name' => 'tenant_nrna',
... ]);
>>> exit
```

### **Step 5: Create Tenant Database**
```bash
mysql -e "CREATE DATABASE tenant_nrna;"
```

### **Step 6: Run Spatie Permission Migrations on Tenant**
```bash
# This runs Spatie's RBAC tables in tenant_nrna database
php artisan tenants:artisan "migrate --database=tenant" --tenant=nrna
```

**âœ… Done!** You now have:
- `tenants` table in landlord DB
- `roles`, `permissions` tables in `tenant_nrna` DB

## ðŸ—ï¸ **PART 2: ADD CUSTOM COLUMNS (Your Needs)**

### **Create Migration to Add Tenant-Aware Columns:**
```bash
php artisan make:migration add_tenant_columns_to_rbac_tables
```

```php
// database/migrations/xxxx_add_tenant_columns_to_rbac_tables.php
public function up()
{
    // This runs in TENANT databases
    
    // Add to roles table
    if (Schema::hasTable('roles') && !Schema::hasColumn('roles', 'tenant_id')) {
        Schema::table('roles', function ($table) {
            $table->unsignedBigInteger('tenant_id')->nullable()->after('id');
            $table->string('code', 50)->nullable()->after('name');
            $table->enum('scope_type', ['global', 'unit'])->default('unit');
            $table->boolean('is_system_role')->default(false);
        });
    }
    
    // Add to permissions table  
    if (Schema::hasTable('permissions') && !Schema::hasColumn('permissions', 'tenant_id')) {
        Schema::table('permissions', function ($table) {
            $table->unsignedBigInteger('tenant_id')->nullable()->after('id');
            $table->boolean('is_global')->default(false);
        });
    }
}
```

### **Run on Tenant:**
```bash
php artisan tenants:artisan "migrate --database=tenant" --tenant=nrna
```

## ðŸ”§ **PART 3: CREATE CUSTOM MODELS (Simple Way)**

### **Custom Role Model:**
```php
// app/Models/TenantRole.php
<?php

namespace App\Models;

use Spatie\Permission\Models\Role;

class TenantRole extends Role
{
    protected $fillable = [
        'name', 'guard_name', 'tenant_id', 'code', 'scope_type', 'is_system_role'
    ];
    
    public function tenant()
    {
        return $this->belongsTo(Tenant::class);
    }
}
```

### **Update Config:**
```php
// config/permission.php
'models' => [
    'role' => \App\Models\TenantRole::class,
    'permission' => \App\Models\TenantPermission::class,
],
```

## ðŸŽ¯ **PART 4: DDD CONTEXTS SIMPLIFIED**

### **Option A: Keep It Simple (Recommended)**
```
app/
â”œâ”€â”€ Models/           # All models here
â”‚   â”œâ”€â”€ Tenant.php    # Landlord model
â”‚   â”œâ”€â”€ TenantRole.php # Tenant RBAC model
â”‚   â””â”€â”€ TenantUser.php # Tenant user model
â””â”€â”€ Contexts/         # Business logic only
    â””â”€â”€ TenantAuth/
        â””â”€â”€ Services/ # Service classes
```

### **Option B: Full DDD with Contexts**
```
app/Contexts/
â”œâ”€â”€ Platform/                 # Landlord/system context
â”‚   â””â”€â”€ Domain/Models/
â”‚       â””â”€â”€ Tenant.php       # Only landlord models here
â”‚
â””â”€â”€ TenantAuth/              # Tenant RBAC context  
    â””â”€â”€ Domain/Models/
        â”œâ”€â”€ TenantRole.php   # Tenant RBAC models
        â”œâ”€â”€ TenantPermission.php
        â””â”€â”€ TenantUser.php
```

**Rule:** Models go where their **database tables** live:
- `Tenant` model â†’ `app/Platform/Domain/Models/` (landlord DB)
- `TenantRole` model â†’ `app/TenantAuth/Domain/Models/` (tenant DBs)

## ðŸš€ **PART 5: PRACTICAL WORKFLOW EXAMPLES**

### **Example 1: New Tenant Setup**
```bash
# 1. Add to landlord tenants table
php artisan tinker
>>> \App\Models\Tenant::create([
...     'name' => 'UML Party',
...     'slug' => 'uml',
...     'database_name' => 'tenant_uml',
... ]);

# 2. Create database
mysql -e "CREATE DATABASE tenant_uml;"

# 3. Run RBAC migrations
php artisan tenants:artisan "migrate --database=tenant" --tenant=uml

# 4. Create default roles
php artisan tinker
>>> $tenant = \App\Models\Tenant::where('slug', 'uml')->first();
>>> $tenant->makeCurrent();
>>> \App\Models\TenantRole::create([
...     'name' => 'Party Admin',
...     'code' => 'party_admin',
...     'tenant_id' => $tenant->id,
... ]);
```

### **Example 2: Assign Role to User**
```php
// In your controller
$tenant = Tenant::where('slug', 'uml')->first();
$tenant->makeCurrent(); // Switch to tenant_uml database

$user = TenantUser::find(1);
$role = TenantRole::where('code', 'party_admin')->first();

$user->assignRole($role); // Spatie handles this
```

### **Example 3: Check Permission**
```php
$tenant->makeCurrent();

if ($user->hasPermissionTo('elections.create')) {
    // User can create elections in this tenant
}
```

## ðŸ“Š **PART 6: CONTEXT DECISION TREE**

```
Is the data SHARED across all tenants?
    â”œâ”€â”€ YES â†’ Landlord database (election)
    â”‚   â””â”€â”€ Models in: app/Platform/Domain/Models/
    â”‚
    â””â”€â”€ NO â†’ Tenant database (tenant_xxx)
        â”œâ”€â”€ Is it RBAC related? â†’ app/TenantAuth/Domain/Models/
        â”œâ”€â”€ Is it user data? â†’ app/TenantAuth/Domain/Models/
        â””â”€â”€ Is it business data? â†’ app/Election/Domain/Models/
```

## ðŸ”§ **PART 7: COMMON COMMANDS CHEATSHEET**

```bash
# LANDLORD operations
php artisan migrate                          # Run on landlord DB
php artisan db:seed                          # Seed landlord DB
php artisan tinker                           # Connects to landlord DB

# TENANT operations  
php artisan tenants:artisan "migrate" --tenant=nrna      # Run migrations on tenant
php artisan tenants:artisan "db:seed" --tenant=nrna      # Seed tenant DB
php artisan tenants:artisan "tinker" --tenant=nrna       # Connect to tenant DB

# Create new tenant
php artisan tenant:create --name="NRNA" --slug="nrna"

# Run command on ALL tenants
php artisan tenants:artisan "migrate:status"
```

## ðŸŽ¯ **PART 8: REAL-WORLD EXAMPLE**

Let's build a **voting system** for political parties:

### **Landlord Database (`election`):**
```sql
-- Only this table
tenants
â”œâ”€â”€ id
â”œâ”€â”€ name (UML Party, NRNA, etc.)
â”œâ”€â”€ slug (uml, nrna)
â””â”€â”€ database_name (tenant_uml, tenant_nrna)
```

### **UML Tenant Database (`tenant_uml`):**
```sql
roles
â”œâ”€â”€ id
â”œâ”€â”€ name (Party President, Ward Coordinator)
â”œâ”€â”€ code (president, ward_coord)
â”œâ”€â”€ tenant_id (links to tenants.id)
â””â”€â”€ scope_type (global, unit)

permissions
â”œâ”€â”€ id  
â”œâ”€â”€ name (candidates.approve, votes.count)
â”œâ”€â”€ tenant_id
â””â”€â”€ is_global

users
â”œâ”€â”€ id
â”œâ”€â”€ name
â”œâ”€â”€ email
â””â”€â”€ tenant_id
```

### **NRNA Tenant Database (`tenant_nrna`):**
```sql
-- Same structure, different data
roles
â”œâ”€â”€ id
â”œâ”€â”€ name (Chapter President, Member)
â”œâ”€â”€ code (chapter_president, member)
â””â”€â”€ ...

-- NRNA has DIFFERENT permissions
permissions
â”œâ”€â”€ name (membership.approve, donations.view)
â””â”€â”€ ...
```

## âœ… **SUMMARY: 5 SIMPLE RULES**

1. **One `tenants` table** in landlord DB only
2. **Each tenant gets own database** with own RBAC tables
3. **Add `tenant_id` to tenant tables** for isolation
4. **Use `tenants:artisan`** for tenant operations
5. **Keep models with their tables** (landlord vs tenant)

## ðŸš¨ **COMMON MISTAKES & FIXES:**

**Mistake:** Running `php artisan migrate` expecting tenant tables
**Fix:** Use `php artisan tenants:artisan "migrate" --tenant=xxx`

**Mistake:** Creating duplicate `roles` tables
**Fix:** Let Spatie create them, then add your columns

**Mistake:** Mixing landlord and tenant data
**Fix:** Always check: "Is this shared?" â†’ landlord, "Is this per-tenant?" â†’ tenant DB

## ðŸŽ‰ **YOU'RE READY!**

Start with the **Simple Setup** (Part 1), get it working, then add complexity as needed. The key is understanding: **One tenants table, many tenant databases, each with their own RBAC.**

Want me to implement any specific part with actual code?