# Mobile App Testing Guide

**Date:** November 15, 2025, 09:45 UTC
**Version:** 1.0.1
**Status:** Ready for Testing

---

## Overview

This guide provides comprehensive testing procedures for the PublicDigit Election Platform mobile application with multi-tenant architecture and fixed type safety.

---

## Prerequisites

### Backend Setup

1. **Laravel Backend Running:**
   ```bash
   cd packages/laravel-backend
   php artisan serve
   # Should be running on http://localhost:8000
   ```

2. **Database Configured:**
   - Landlord database with tenants table
   - At least one active tenant (e.g., `nrna`)

3. **Test User Exists:**
   - Email: `test@test.com`
   - Password: `password123` (or your test password)

### Frontend Setup

1. **Dependencies Installed:**
   ```bash
   cd apps/mobile
   npm install
   ```

2. **Environment Configured:**
   - Auto-detection enabled in `environment.dev.ts`
   - API URL properly set

---

## Test Suite 1: Build Verification

### 1.1 TypeScript Compilation

**Objective:** Verify build compiles without errors

**Steps:**
```bash
nx build mobile --configuration=development
```

**Expected Results:**
- ‚úÖ Browser application bundle generation complete
- ‚úÖ Copying assets complete
- ‚úÖ Index html generation complete
- ‚úÖ **0 TypeScript errors**
- ‚úÖ Build time: ~10-15 seconds
- ‚úÖ Bundle size: ~3.90 MB

**Pass Criteria:**
- Build completes successfully
- No TypeScript errors
- Only minor warnings about unused files (acceptable)

**Screenshot:**
```
‚úî Browser application bundle generation complete.
‚úî Copying assets complete.
‚úî Index html generation complete.

‚úÖ Successfully ran target build for project mobile
```

---

## Test Suite 2: Browser Testing

### 2.1 Development Server

**Objective:** Start development server and verify app loads

**Steps:**
```bash
npm start
# or
nx serve mobile
```

**Expected Results:**
- ‚úÖ Server starts on http://localhost:4200
- ‚úÖ No compilation errors
- ‚úÖ Browser opens automatically

**Pass Criteria:**
- Development server running without errors
- Console shows no critical errors

---

### 2.2 Landing Page Load

**Objective:** Verify landing page displays correctly

**URL:** `http://localhost:4200`

**Expected Results:**
- ‚úÖ Landing page displays with purple gradient
- ‚úÖ "Welcome to PublicDigit" heading visible
- ‚úÖ "Login" and "Learn More" buttons present
- ‚úÖ No console errors

**Console Logs to Check:**
```
üåê Environment: Browser (localhost)
üìç API URL: http://localhost:8000/api/v1
```

**Pass Criteria:**
- Page renders completely
- All UI elements visible
- No JavaScript errors in console

---

### 2.3 Login Flow (No Subdomain)

**Objective:** Test login with manual tenant input

**Steps:**
1. Navigate to `http://localhost:4200`
2. Click "Login" button
3. Login form should display
4. Verify "Organization ID" field is visible
5. Enter credentials:
   - Organization ID: `nrna`
   - Email: `test@test.com`
   - Password: `password123`
6. Click "Sign In"

**Expected Console Logs:**
```
üì± No tenant context, showing tenant input field
üè¢ Setting tenant context before login: nrna
üíæ Tenant context stored: nrna
üîÄ Tenant Interceptor: Injected X-Tenant-Slug for /api/v1/auth/login
‚úÖ Login successful
üíæ Auth session stored securely
```

**Expected Results:**
- ‚úÖ Login form displays with Organization ID field
- ‚úÖ Login succeeds
- ‚úÖ Redirects to dashboard
- ‚úÖ User info displayed on dashboard
- ‚úÖ Token stored in localStorage

**Verification:**
```javascript
// Open browser console
localStorage.getItem('auth_token')  // Should return token
localStorage.getItem('current_user')  // Should return user JSON
localStorage.getItem('tenant_slug')  // Should return 'nrna'
```

**Pass Criteria:**
- Login completes successfully
- Dashboard loads with user data
- Token and tenant context stored

---

### 2.4 Login Flow (With Subdomain)

**Objective:** Test automatic tenant detection from subdomain

**Setup:**
1. Add to hosts file (`C:\Windows\System32\drivers\etc\hosts`):
   ```
   127.0.0.1 nrna.localhost
   ```

**Steps:**
1. Navigate to `http://nrna.localhost:4200`
2. Click "Login" button
3. Verify "Organization ID" field is **hidden**
4. Verify "Logging into: nrna" message displays
5. Enter credentials:
   - Email: `test@test.com`
   - Password: `password123`
6. Click "Sign In"

**Expected Console Logs:**
```
üåê Detected subdomain tenant: nrna
üíæ Tenant context stored: nrna
üè¢ Tenant context auto-detected from subdomain
‚úÖ Login successful
```

**Expected Results:**
- ‚úÖ Organization ID field hidden
- ‚úÖ "Logging into: nrna" message displayed
- ‚úÖ Login succeeds without manual tenant input
- ‚úÖ Redirects to dashboard

**Pass Criteria:**
- Subdomain automatically detected
- No need to enter organization ID
- Login successful
- Dashboard displays correctly

---

### 2.5 Dashboard Display

**Objective:** Verify dashboard loads and displays user data

**Expected Elements:**
- ‚úÖ Welcome message with user name
- ‚úÖ User email displayed
- ‚úÖ Logout button visible
- ‚úÖ Stats cards:
  - Active Elections
  - Votes Cast
  - Upcoming
- ‚úÖ Navigation cards:
  - Elections
  - My Profile
  - Results
  - Settings

**Expected Console Logs:**
```
Loading user data...
Loading stats...
```

**API Calls to Verify:**
```
GET /api/v1/auth/me
GET /api/v1/elections/active
GET /api/v1/elections
```

**Pass Criteria:**
- All UI elements render correctly
- User data displayed
- No layout issues
- Stats load (even if 0)

---

### 2.6 Logout Flow

**Objective:** Test logout functionality

**Steps:**
1. From dashboard, click "Logout" button
2. Wait for logout to complete

**Expected Console Logs:**
```
‚úÖ Logged out (tenant context preserved)
```

**Expected Results:**
- ‚úÖ User redirected to landing page
- ‚úÖ Auth token removed from storage
- ‚úÖ User data cleared
- ‚úÖ **Tenant context preserved** (important!)

**Verification:**
```javascript
// Open browser console
localStorage.getItem('auth_token')  // Should be null
localStorage.getItem('current_user')  // Should be null
localStorage.getItem('tenant_slug')  // Should still be 'nrna' ‚úÖ
```

**Pass Criteria:**
- Logout completes successfully
- User redirected to home
- Auth data cleared
- Tenant slug remains for next login

---

### 2.7 Re-login After Logout

**Objective:** Verify tenant context persists after logout

**Steps:**
1. After logout, click "Login" again
2. Verify tenant context remembered

**Expected Results:**
- ‚úÖ If subdomain used: Organization ID field hidden
- ‚úÖ If subdomain used: "Logging into: nrna" displayed
- ‚úÖ Login without re-entering organization ID

**Pass Criteria:**
- Tenant context preserved from previous session
- Seamless re-login experience

---

## Test Suite 3: Android Emulator Testing

### 3.1 Build for Android

**Objective:** Build and deploy to Android emulator

**Steps:**
```bash
# Build development version
nx build mobile --configuration=development

# Sync with Capacitor
cd apps/mobile
npx cap sync android

# Open in Android Studio
npx cap open android
```

**Expected Results:**
- ‚úÖ Build completes successfully
- ‚úÖ Android Studio opens
- ‚úÖ Project loads without errors

**Pass Criteria:**
- No build errors
- Android Studio successfully opens project

---

### 3.2 Run on Emulator

**Objective:** Deploy and run app on Android emulator

**Steps:**
1. In Android Studio, select an emulator (e.g., Pixel 5 API 30)
2. Click "Run" button
3. Wait for app to install and launch

**Expected Results:**
- ‚úÖ App installs on emulator
- ‚úÖ App launches successfully
- ‚úÖ Landing page displays

**Pass Criteria:**
- App runs without crashes
- UI renders correctly
- No native errors

---

### 3.3 Login on Android

**Objective:** Test login flow on Android emulator

**Prerequisites:**
- Backend accessible at `http://10.0.2.2:8000` (emulator alias to host)

**Steps:**
1. Click "Login" button
2. Verify Organization ID field visible
3. Enter credentials:
   - Organization ID: `nrna`
   - Email: `test@test.com`
   - Password: `password123`
4. Click "Sign In"

**Expected Console Logs** (View in Android Logcat):
```
üì± Environment: Android Emulator (10.0.2.2)
üìç API URL: http://10.0.2.2:8000/api/v1
üè¢ Setting tenant context before login: nrna
üíæ Tenant context stored: nrna (Capacitor Preferences)
‚úÖ Login successful
```

**Expected Results:**
- ‚úÖ Login form displays
- ‚úÖ API call succeeds to `http://10.0.2.2:8000/api/v1/auth/login`
- ‚úÖ Dashboard loads
- ‚úÖ Data stored in Capacitor Preferences

**Verification:**
Check Logcat for Capacitor Preferences operations:
```
CapacitorPreferences: set - key: tenant_slug, value: nrna
CapacitorPreferences: set - key: auth_token, value: 1|abc123...
CapacitorPreferences: set - key: current_user, value: {...}
```

**Pass Criteria:**
- Login successful on Android
- Data persisted in Capacitor Preferences
- Dashboard displays correctly

---

### 3.4 App Restart Persistence (Android)

**Objective:** Verify tenant context and auth state persist after app restart

**Steps:**
1. With user logged in, close app (swipe away from recent apps)
2. Reopen app from app drawer

**Expected Console Logs:**
```
üì± Restored tenant context from storage: nrna
‚úÖ Auth state restored from storage
```

**Expected Results:**
- ‚úÖ User still logged in
- ‚úÖ Dashboard displays immediately (no redirect to login)
- ‚úÖ Tenant context preserved

**Pass Criteria:**
- No need to login again
- Tenant context loaded from Capacitor Preferences
- User data loaded from secure storage

---

### 3.5 Logout on Android

**Objective:** Test logout on Android

**Steps:**
1. From dashboard, click "Logout"
2. Wait for logout to complete

**Expected Results:**
- ‚úÖ Auth token removed from Capacitor Preferences
- ‚úÖ User data cleared
- ‚úÖ Tenant context preserved
- ‚úÖ Redirected to landing page

**Verification (Logcat):**
```
CapacitorPreferences: remove - key: auth_token
CapacitorPreferences: remove - key: current_user
CapacitorPreferences: get - key: tenant_slug  ‚Üê Still present
```

**Pass Criteria:**
- Logout successful
- Auth data cleared
- Tenant slug remains

---

## Test Suite 4: Type Safety Verification

### 4.1 Code Inspection

**Objective:** Verify type annotations are correct

**Files to Check:**

**auth.service.ts:**
```typescript
// Verify import includes ApiResponse
import { LoginRequest, LoginResponse, User, ApiResponse } from '../models/auth.models';

// Verify getCurrentUser has correct type annotations
getCurrentUser(): Observable<User> {
  return this.apiService.getCurrentUser().pipe(
    tap((response: ApiResponse<LoginResponse>) => { ... }),
    map((response: ApiResponse<LoginResponse>) => response.data!.user)
  );
}
```

**dashboard.page.ts:**
```typescript
// Verify User imported from models
import { User } from '../core/models/auth.models';
```

**Pass Criteria:**
- All type annotations present
- Imports from correct locations
- No `any` types used

---

### 4.2 Build Without Errors

**Objective:** Ensure TypeScript compiles cleanly

**Command:**
```bash
nx build mobile --configuration=development
```

**Pass Criteria:**
- ‚úÖ **0 TypeScript errors**
- ‚úÖ Build completes successfully

---

## Test Suite 5: API Integration

### 5.1 Request Headers Verification

**Objective:** Verify all required headers are sent

**Steps:**
1. Open browser DevTools ‚Üí Network tab
2. Login to the app
3. Inspect the login request

**Expected Request Headers:**
```
POST /api/v1/auth/login

Headers:
  Content-Type: application/json
  Accept: application/json
  X-Requested-With: XMLHttpRequest
  X-Tenant-Slug: nrna
```

**Pass Criteria:**
- All headers present
- X-Tenant-Slug matches tenant context
- X-Requested-With present (required by Laravel)

---

### 5.2 Response Type Handling

**Objective:** Verify API responses are correctly unwrapped

**Expected Response Structure:**
```json
{
  "success": true,
  "data": {
    "token": "1|abc123...",
    "user": {
      "id": 1,
      "name": "Test User",
      "email": "test@test.com"
    }
  }
}
```

**Code Verification:**
- ‚úÖ `apiResponse.data` accessed (not `apiResponse.token`)
- ‚úÖ `apiResponse.data.user` accessed
- ‚úÖ Proper type annotation: `ApiResponse<LoginResponse>`

**Pass Criteria:**
- No runtime errors accessing response properties
- Data correctly extracted
- Type safety maintained

---

## Test Suite 6: Error Handling

### 6.1 Invalid Credentials

**Objective:** Test login with wrong password

**Steps:**
1. Enter valid email but wrong password
2. Click "Sign In"

**Expected Results:**
- ‚úÖ Error message displayed
- ‚úÖ No redirect to dashboard
- ‚úÖ User remains on login page
- ‚úÖ Tenant context cleared on failure

**Console Logs:**
```
‚ùå Login failed: [error message]
üóëÔ∏è Tenant context cleared on auth failure
```

**Pass Criteria:**
- Appropriate error handling
- User-friendly error message
- No crash or unhandled exception

---

### 6.2 Invalid Tenant

**Objective:** Test login with non-existent tenant

**Steps:**
1. Enter organization ID: `nonexistent`
2. Enter valid credentials
3. Click "Sign In"

**Expected Results:**
- ‚úÖ Error response from backend
- ‚úÖ Error displayed to user
- ‚úÖ Tenant context cleared

**Pass Criteria:**
- Graceful error handling
- Clear error message
- App remains stable

---

### 6.3 Network Error

**Objective:** Test behavior when backend is unreachable

**Steps:**
1. Stop Laravel backend (`Ctrl+C`)
2. Attempt to login

**Expected Results:**
- ‚úÖ Network error caught
- ‚úÖ Error message displayed (e.g., "Unable to connect")
- ‚úÖ App doesn't crash

**Console Logs:**
```
‚ùå Login failed: Http failure response for http://localhost:8000/api/v1/auth/login: 0 Unknown Error
```

**Pass Criteria:**
- Appropriate error handling
- App remains responsive
- No unhandled promise rejections

---

## Test Suite 7: Edge Cases

### 7.1 Refresh During Login

**Objective:** Test behavior if page refreshed during login process

**Steps:**
1. Start login process
2. Press F5 to refresh page before login completes

**Expected Results:**
- ‚úÖ Login aborted
- ‚úÖ User returned to login page
- ‚úÖ No corrupted state

**Pass Criteria:**
- Graceful handling of interrupted login
- No errors on page reload

---

### 7.2 Multiple Tabs

**Objective:** Test behavior with multiple tabs open

**Steps:**
1. Open app in two browser tabs
2. Login in Tab 1
3. Check Tab 2

**Expected Results:**
- ‚úÖ Both tabs share localStorage
- ‚úÖ Token visible in both tabs
- ‚úÖ Tenant context synchronized

**Note:** Full synchronization across tabs requires additional implementation (SharedWorker or StorageEvent listener).

**Pass Criteria:**
- No crashes
- Data accessible in both tabs

---

### 7.3 Expired Token

**Objective:** Test behavior with expired authentication token

**Steps:**
1. Login successfully
2. Manually delete token from backend database or wait for expiration
3. Attempt to access protected resource

**Expected Results:**
- ‚úÖ 401 Unauthorized error
- ‚úÖ User redirected to login
- ‚úÖ Clear error message

**Pass Criteria:**
- Proper 401 handling
- User can login again
- No infinite redirect loops

---

## Test Checklist Summary

### Critical Tests (Must Pass)

- [ ] Build compiles with 0 TypeScript errors
- [ ] Development server starts successfully
- [ ] Landing page loads in browser
- [ ] Login works with manual tenant input
- [ ] Login works with subdomain detection
- [ ] Dashboard displays after login
- [ ] Logout works correctly
- [ ] Tenant context persists after logout
- [ ] App builds for Android
- [ ] App runs on Android emulator
- [ ] Login works on Android
- [ ] Tenant context persists on app restart (Android)
- [ ] All required headers sent with API requests
- [ ] API responses correctly unwrapped
- [ ] Invalid credentials handled gracefully
- [ ] Network errors handled without crashes

### Optional Tests (Nice to Have)

- [ ] Login with subdomain on localhost
- [ ] Multiple tenant switching
- [ ] Multiple tabs synchronization
- [ ] Token expiration handling
- [ ] Offline mode handling

---

## Test Reporting Template

### Test Session Information

**Date:** [Date]
**Tester:** [Name]
**Environment:** [Browser/Android version]
**Backend Version:** [Laravel version]
**Mobile App Version:** [Version]

### Results

| Test Suite | Test Case | Status | Notes |
|------------|-----------|--------|-------|
| Build | TypeScript Compilation | ‚úÖ / ‚ùå | |
| Browser | Landing Page | ‚úÖ / ‚ùå | |
| Browser | Login (No Subdomain) | ‚úÖ / ‚ùå | |
| Browser | Login (Subdomain) | ‚úÖ / ‚ùå | |
| Browser | Dashboard | ‚úÖ / ‚ùå | |
| Browser | Logout | ‚úÖ / ‚ùå | |
| Android | Build | ‚úÖ / ‚ùå | |
| Android | Login | ‚úÖ / ‚ùå | |
| Android | Persistence | ‚úÖ / ‚ùå | |
| Types | No Errors | ‚úÖ / ‚ùå | |
| API | Headers | ‚úÖ / ‚ùå | |
| Errors | Invalid Credentials | ‚úÖ / ‚ùå | |

### Issues Found

1. [Issue description]
   - Severity: Critical / High / Medium / Low
   - Steps to reproduce
   - Expected vs Actual behavior

### Overall Assessment

**Status:** ‚úÖ Ready for Production / ‚ö†Ô∏è Needs Fixes / ‚ùå Not Ready

**Comments:**
[Overall assessment and recommendations]

---

## Troubleshooting

### Build Fails

**Problem:** `nx build mobile` fails with errors

**Solution:**
1. Clear nx cache: `nx reset` (may fail on Windows, ignore)
2. Clean install: `rm -rf node_modules && npm install`
3. Check TypeScript version compatibility
4. Verify all imports are correct

### Login Returns 0 Error

**Problem:** Login fails with "Http failure response: 0 Unknown Error"

**Possible Causes:**
1. Backend not running ‚Üí Start Laravel: `php artisan serve`
2. Wrong API URL ‚Üí Check environment.dev.ts
3. CORS issue ‚Üí Verify backend CORS config
4. Network firewall ‚Üí Check firewall settings

**Android Specific:**
- Verify using `10.0.2.2` not `localhost`
- Check backend accessible from emulator
- Test with curl from emulator

### Headers Not Sent

**Problem:** X-Tenant-Slug header missing from requests

**Solution:**
1. Verify tenant context set: `localStorage.getItem('tenant_slug')`
2. Check interceptor registered in `app.config.ts`
3. Verify interceptor order (tenant before auth)
4. Check console for interceptor logs

### Android App Crashes

**Problem:** App crashes on Android after changes

**Solution:**
1. Rebuild: `nx build mobile --configuration=development`
2. Re-sync: `npx cap sync android`
3. Clean build in Android Studio
4. Check Logcat for native errors
5. Verify Capacitor plugins installed

---

## Next Steps After Testing

### If All Tests Pass ‚úÖ

1. Update DEPLOYMENT_CHECKLIST.md with test results
2. Tag release in Git
3. Prepare for production deployment
4. Update documentation with any learnings

### If Tests Fail ‚ùå

1. Document all failing tests
2. Create issues for each failure
3. Prioritize fixes
4. Re-test after fixes
5. Update test cases if needed

---

**Testing Guide Version:** 1.0
**Last Updated:** November 15, 2025, 09:45 UTC
**Status:** Ready for Use
